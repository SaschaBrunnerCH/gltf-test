!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("babylonjs")):"function"==typeof define&&define.amd?define("babylonjs-serializers",["babylonjs"],t):"object"==typeof exports?exports["babylonjs-serializers"]=t(require("babylonjs")):e.SERIALIZERS=t(e.BABYLON)}("undefined"!=typeof self?self:"undefined"!=typeof global?global:this,(e=>(()=>{"use strict";var t,n,r={597:t=>{t.exports=e}},o={};function a(e){var t=o[e];if(void 0!==t)return t.exports;var n=o[e]={exports:{}};return r[e](n,n.exports,a),n.exports}n=Object.getPrototypeOf?e=>Object.getPrototypeOf(e):e=>e.__proto__,a.t=function(e,r){if(1&r&&(e=this(e)),8&r)return e;if("object"==typeof e&&e){if(4&r&&e.__esModule)return e;if(16&r&&"function"==typeof e.then)return e}var o=Object.create(null);a.r(o);var i={};t=t||[null,n({}),n([]),n(n)];for(var s=2&r&&e;"object"==typeof s&&!~t.indexOf(s);s=n(s))Object.getOwnPropertyNames(s).forEach((t=>i[t]=()=>e[t]));return i.default=()=>e,a.d(o,i),o},a.d=(e,t)=>{for(var n in t)a.o(t,n)&&!a.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},a.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),a.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),a.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var i={};a.d(i,{default:()=>ct});var s={};a.r(s),a.d(s,{OBJExport:()=>x});var u={};a.r(u),a.d(u,{__IGLTFExporterExtension:()=>_});var c={};a.r(c),a.d(c,{GLTFData:()=>y});var l={};a.r(l),a.d(l,{GLTF2Export:()=>ae});var f={};a.r(f),a.d(f,{GLTF2Export:()=>ae,GLTFData:()=>y,_ConvertToGLTFPBRMetallicRoughness:()=>S,_SolveMetallic:()=>V});var p={};a.r(p),a.d(p,{STLExport:()=>ie});var h={};a.r(h),a.d(h,{USDZExportAsync:()=>ye});var d={};a.r(d),a.d(d,{EXT_mesh_gpu_instancing:()=>Te,KHR_lights_punctual:()=>Ee,KHR_materials_anisotropy:()=>Re,KHR_materials_clearcoat:()=>Se,KHR_materials_diffuse_transmission:()=>Fe,KHR_materials_dispersion:()=>Pe,KHR_materials_emissive_strength:()=>Oe,KHR_materials_ior:()=>Le,KHR_materials_iridescence:()=>De,KHR_materials_sheen:()=>We,KHR_materials_specular:()=>qe,KHR_materials_transmission:()=>ze,KHR_materials_unlit:()=>Qe,KHR_materials_volume:()=>Xe,KHR_texture_transform:()=>Je});var m={};a.r(m),a.d(m,{GLTF2Export:()=>ae,GLTFData:()=>y,OBJExport:()=>x,STLExport:()=>ie,USDZExportAsync:()=>ye,_ConvertToGLTFPBRMetallicRoughness:()=>S,_SolveMetallic:()=>V,__IGLTFExporterExtension:()=>_});var g=a(597),x=function(){function e(){}return e.OBJ=function(e,t,n,r){var o=[],a=1,i=1;t&&(n||(n="mat"),o.push("mtllib "+n+".mtl"));for(var s=0;s<e.length;s++){var u=e[s],c=u.name||"mesh".concat(s,"}");o.push("o ".concat(c));var l=null;if(r){var f=u.computeWorldMatrix(!0);l=new g.Matrix,f.invertToRef(l),u.bakeTransformIntoVertices(f)}if(t){var p=u.material;p&&o.push("usemtl "+p.id)}var h=u.geometry;if(h){var d=h.getVerticesData("position"),m=h.getVerticesData("normal"),x=h.getVerticesData("uv"),_=h.getIndices(),y=0,v=0;if(d&&_){for(var T=e[0].getScene().useRightHandedSystem?1:-1,b=0;b<d.length;b+=3)o.push("v "+d[b]*T+" "+d[b+1]+" "+d[b+2]),y++;if(null!=m)for(b=0;b<m.length;b+=3)o.push("vn "+m[b]*T+" "+m[b+1]+" "+m[b+2]);if(null!=x)for(b=0;b<x.length;b+=2)o.push("vt "+x[b]+" "+x[b+1]),v++;var A=["","",""],M=(u.material||u.getScene().defaultMaterial)._getEffectiveOrientation(u)===g.Material.ClockWiseSideOrientation?[2,1]:[1,2],w=M[0],E=M[1];for(b=0;b<_.length;b+=3){var C=[String(_[b]+a),String(_[b+w]+a),String(_[b+E]+a)],R=[String(_[b]+i),String(_[b+w]+i),String(_[b+E]+i)],V=C,S=null!=x?R:A,I=null!=m?C:A;o.push("f "+V[0]+"/"+S[0]+"/"+I[0]+" "+V[1]+"/"+S[1]+"/"+I[1]+" "+V[2]+"/"+S[2]+"/"+I[2])}r&&l&&u.bakeTransformIntoVertices(l),a+=y,i+=v}else g.Tools.Warn("There are no position vertices or indices on the mesh!")}else g.Tools.Warn("No geometry is present on the mesh")}return o.join("\n")},e.MTL=function(e){var t=[],n=e.material;return t.push("newmtl mat1"),t.push("  Ns "+n.specularPower.toFixed(4)),t.push("  Ni 1.5000"),t.push("  d "+n.alpha.toFixed(4)),t.push("  Tr 0.0000"),t.push("  Tf 1.0000 1.0000 1.0000"),t.push("  illum 2"),t.push("  Ka "+n.ambientColor.r.toFixed(4)+" "+n.ambientColor.g.toFixed(4)+" "+n.ambientColor.b.toFixed(4)),t.push("  Kd "+n.diffuseColor.r.toFixed(4)+" "+n.diffuseColor.g.toFixed(4)+" "+n.diffuseColor.b.toFixed(4)),t.push("  Ks "+n.specularColor.r.toFixed(4)+" "+n.specularColor.g.toFixed(4)+" "+n.specularColor.b.toFixed(4)),t.push("  Ke "+n.emissiveColor.r.toFixed(4)+" "+n.emissiveColor.g.toFixed(4)+" "+n.emissiveColor.b.toFixed(4)),n.ambientTexture&&t.push("  map_Ka "+n.ambientTexture.name),n.diffuseTexture&&t.push("  map_Kd "+n.diffuseTexture.name),n.specularTexture&&t.push("  map_Ks "+n.specularTexture.name),n.bumpTexture&&t.push("  map_bump -imfchan z "+n.bumpTexture.name),n.opacityTexture&&t.push("  map_d "+n.opacityTexture.name),t.join("\n")},e}(),_=0,y=function(){function e(){this.files={}}return Object.defineProperty(e.prototype,"glTFFiles",{get:function(){return this.files},enumerable:!1,configurable:!0}),e.prototype.downloadFiles=function(){for(var e in this.files){var t=this.files[e],n=new Blob([t],{type:(r=e,r.endsWith(".glb")?"model/gltf-binary":r.endsWith(".bin")?"application/octet-stream":r.endsWith(".gltf")?"model/gltf+json":r.endsWith(".jpeg")||r.endsWith(".jpg")?"image/jpeg":r.endsWith(".png")?"image/png":r.endsWith(".webp")?"image/webp":void 0)});g.Tools.Download(n,e)}var r},e}(),v=function(){return v=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},v.apply(this,arguments)};function T(e,t,n,r){return new(n||(n=Promise))((function(o,a){function i(e){try{u(r.next(e))}catch(e){a(e)}}function s(e){try{u(r.throw(e))}catch(e){a(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}u((r=r.apply(e,t||[])).next())}))}function b(e,t){var n,r,o,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]},i=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return i.next=s(0),i.throw=s(1),i.return=s(2),"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(u){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,r=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!((o=(o=a.trys).length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,u])}}}function A(e,t,n){if(n||2===arguments.length)for(var r,o=0,a=t.length;o<a;o++)!r&&o in t||(r||(r=Array.prototype.slice.call(t,0,o)),r[o]=t[o]);return e.concat(r||Array.prototype.slice.call(t))}Object.create,Object.create,"function"==typeof SuppressedError&&SuppressedError;var M=1e-6,w=new g.Color3(.04,.04,.04),E=1024,C=g.Color3.White(),R=g.Color3.Black();function V(e,t,n){if(t<w.r)return 0;var r=w.r,o=e*n/(1-w.r)+t-2*w.r,a=o*o-4*r*(w.r-t);return g.Scalar.Clamp((-o+Math.sqrt(a))/(2*r),0,1)}function S(e){var t,n,r,o,a,i,s=new g.Vector2(0,1),u=new g.Vector2(0,.1),c=new g.Vector2(0,.1),l=new g.Vector2(1300,.1),f=e.diffuseColor.toLinearSpace(e.getScene().getEngine().useExactSrgbConversions).scale(.5),p=e.alpha,h=(t=g.Scalar.Clamp(e.specularPower,0,E),n=Math.pow(t/l.x,.333333),r=s.y,o=u.y,a=c.y,i=l.y,(1-n)*(1-n)*(1-n)*r+3*(1-n)*(1-n)*n*o+3*(1-n)*n*n*a+n*n*n*i);return{baseColorFactor:[f.r,f.g,f.b,p],metallicFactor:0,roughnessFactor:h}}function I(e,t){t.needAlphaBlending()?e.alphaMode="BLEND":t.needAlphaTesting()&&(e.alphaMode="MASK",e.alphaCutoff=t.alphaCutOff)}function F(e,t,n){for(var r=new Uint8Array(e*t*4),o=0;o<r.length;o+=4)r[o]=r[o+1]=r[o+2]=r[o+3]=255;return g.RawTexture.CreateRGBATexture(r,e,t,n)}function N(e){if(e instanceof Uint8Array){for(var t=e.length,n=new Float32Array(e.length),r=0;r<t;++r)n[r]=e[r]/255;return n}if(e instanceof Float32Array)return e;throw new Error("Unsupported pixel format!")}var P=function(){function e(e){this._exporter=e,this._textureMap=new Map,this._internalTextureToImage={}}return e.prototype.getTextureInfo=function(e){var t;return e&&null!==(t=this._textureMap.get(e))&&void 0!==t?t:null},e.prototype.exportStandardMaterialAsync=function(e,t,n){return T(this,void 0,void 0,(function(){var r,o,a,i,s,u,c,l;return b(this,(function(f){switch(f.label){case 0:return r=S(e),o={name:e.name},null==e.backFaceCulling||e.backFaceCulling||(e.twoSidedLighting||g.Tools.Warn(e.name+": Back-face culling disabled and two-sided lighting disabled is not supported in glTF."),o.doubleSided=!0),n?(a=[],(i=e.diffuseTexture)&&a.push(this.exportTextureAsync(i,t).then((function(e){e&&(r.baseColorTexture=e)}))),(s=e.bumpTexture)&&a.push(this.exportTextureAsync(s,t).then((function(e){e&&(o.normalTexture=e,1!==s.level&&(o.normalTexture.scale=s.level))}))),(u=e.emissiveTexture)&&(o.emissiveFactor=[1,1,1],a.push(this.exportTextureAsync(u,t).then((function(e){e&&(o.emissiveTexture=e)})))),(c=e.ambientTexture)&&a.push(this.exportTextureAsync(c,t).then((function(e){if(e){var t={index:e.index};o.occlusionTexture=t}}))),a.length>0?(this._exporter._materialNeedsUVsSet.add(e),[4,Promise.all(a)]):[3,2]):[3,2];case 1:f.sent(),f.label=2;case 2:return(e.alpha<1||e.opacityTexture)&&(e.alphaMode===g.Constants.ALPHA_COMBINE?o.alphaMode="BLEND":g.Tools.Warn(e.name+": glTF 2.0 does not support alpha mode: "+e.alphaMode.toString())),e.emissiveColor&&!e.emissiveColor.equalsWithEpsilon(R,M)&&(o.emissiveFactor=e.emissiveColor.asArray()),o.pbrMetallicRoughness=r,I(o,e),[4,this._finishMaterialAsync(o,e,t)];case 3:return f.sent(),(l=this._exporter._materials).push(o),[2,l.length-1]}}))}))},e.prototype._finishMaterialAsync=function(e,t,n){return T(this,void 0,void 0,(function(){var r,o,a,i,s;return b(this,(function(u){switch(u.label){case 0:for(r=this._exporter._extensionsPostExportMaterialAdditionalTextures("exportMaterial",e,t),o=[],a=0,i=r;a<i.length;a++)s=i[a],o.push(this.exportTextureAsync(s,n));return[4,Promise.all(o)];case 1:return u.sent(),[4,this._exporter._extensionsPostExportMaterialAsync("exportMaterial",e,t)];case 2:return u.sent(),[2]}}))}))},e.prototype._getImageDataAsync=function(e,t,n,r){return T(this,void 0,void 0,(function(){var o,i,s,u,c;return b(this,(function(l){switch(l.label){case 0:return o=g.Constants.TEXTURETYPE_UNSIGNED_BYTE,i=this._exporter._babylonScene,s=i.getEngine(),u=s.createRawTexture(e,t,n,g.Constants.TEXTUREFORMAT_RGBA,!1,!0,g.Texture.NEAREST_SAMPLINGMODE,null,o),s.isWebGPU?[4,Promise.resolve().then(a.t.bind(a,597,23))]:[3,2];case 1:return l.sent(),[3,4];case 2:return[4,Promise.resolve().then(a.t.bind(a,597,23))];case 3:l.sent(),l.label=4;case 4:return[4,g.TextureTools.ApplyPostProcess("pass",u,i,o,g.Constants.TEXTURE_NEAREST_SAMPLINGMODE,g.Constants.TEXTUREFORMAT_RGBA)];case 5:return l.sent(),[4,s._readTexturePixels(u,t,n)];case 6:return c=l.sent(),[4,g.DumpTools.DumpDataAsync(t,n,c,r,void 0,!0,!0)];case 7:return[2,l.sent()]}}))}))},e.prototype._resizeTexturesToSameDimensions=function(e,t,n){var r,o,a=e?e.getSize():{width:0,height:0},i=t?t.getSize():{width:0,height:0};return a.width<i.width?(r=e&&e instanceof g.Texture?g.TextureTools.CreateResizedCopy(e,i.width,i.height,!0):F(i.width,i.height,n),o=t):a.width>i.width?(o=t&&t instanceof g.Texture?g.TextureTools.CreateResizedCopy(t,a.width,a.height,!0):F(a.width,a.height,n),r=e):(r=e,o=t),{texture1:r,texture2:o}},e.prototype._convertSpecularGlossinessTexturesToMetallicRoughnessAsync=function(e,t,n,r){return T(this,void 0,void 0,(function(){var o,a,i,s,u,c,l,f,p,h,d,m,x,_,y,v,T,A,w,E,V,S,I,F,P,B,O,U,L,k,D;return b(this,(function(b){switch(b.label){case 0:return o=new Array,e||t?(a=e?e.getScene():t?t.getScene():null)?(i=this._resizeTexturesToSameDimensions(e,t,a),s=null===(D=i.texture1)||void 0===D?void 0:D.getSize(),u=void 0,c=void 0,l=s.width,f=s.height,[4,i.texture1.readPixels()]):[3,3]:[2,Promise.reject("diffuse and specular glossiness textures are not defined!")];case 1:return p=b.sent(),[4,i.texture2.readPixels()];case 2:if(h=b.sent(),!p)return[2,Promise.reject("Failed to retrieve pixels from diffuse texture!")];if(u=N(p),!h)return[2,Promise.reject("Failed to retrieve pixels from specular glossiness texture!")];for(c=N(h),d=c.byteLength,m=new Uint8Array(d),x=new Uint8Array(d),_=R,y=0,v=0,B=0;B<f;++B)for(O=0;O<l;++O)T=4*(l*B+O),A=new g.Color3(u[T],u[T+1],u[T+2]).toLinearSpace(a.getEngine().useExactSrgbConversions).multiply(n.diffuseColor),w=new g.Color3(c[T],c[T+1],c[T+2]).toLinearSpace(a.getEngine().useExactSrgbConversions).multiply(n.specularColor),E=c[T+3]*n.glossiness,V={diffuseColor:A,specularColor:w,glossiness:E},S=this._convertSpecularGlossinessToMetallicRoughness(V),_.r=Math.max(_.r,S.baseColor.r),_.g=Math.max(_.g,S.baseColor.g),_.b=Math.max(_.b,S.baseColor.b),y=Math.max(y,S.metallic),v=Math.max(v,S.roughness),x[T]=255*S.baseColor.r,x[T+1]=255*S.baseColor.g,x[T+2]=255*S.baseColor.b,x[T+3]=i.texture1.hasAlpha?255*u[T+3]:255,m[T]=0,m[T+1]=255*S.roughness,m[T+2]=255*S.metallic,m[T+3]=255;for(I={baseColor:_,metallic:y,roughness:v},F=!1,P=!1,B=0;B<f;++B)for(O=0;O<l;++O)x[U=4*(l*B+O)]/=I.baseColor.r>M?I.baseColor.r:1,x[U+1]/=I.baseColor.g>M?I.baseColor.g:1,x[U+2]/=I.baseColor.b>M?I.baseColor.b:1,L=g.Color3.FromInts(x[U],x[U+1],x[U+2]),k=L.toGammaSpace(a.getEngine().useExactSrgbConversions),x[U]=255*k.r,x[U+1]=255*k.g,x[U+2]=255*k.b,k.equalsWithEpsilon(C,M)||(P=!0),m[U+1]/=I.roughness>M?I.roughness:1,m[U+2]/=I.metallic>M?I.metallic:1,g.Color3.FromInts(255,m[U+1],m[U+2]).equalsWithEpsilon(C,M)||(F=!0);return F&&o.push(this._getImageDataAsync(m,l,f,r).then((function(e){I.metallicRoughnessTextureData=e}))),P&&o.push(this._getImageDataAsync(x,l,f,r).then((function(e){I.baseColorTextureData=e}))),[2,Promise.all(o).then((function(){return I}))];case 3:return[2,Promise.reject("_ConvertSpecularGlossinessTexturesToMetallicRoughness: Scene from textures is missing!")]}}))}))},e.prototype._convertSpecularGlossinessToMetallicRoughness=function(e){var t=this._getPerceivedBrightness(e.diffuseColor),n=this._getPerceivedBrightness(e.specularColor),r=1-this._getMaxComponent(e.specularColor),o=V(t,n,r),a=e.diffuseColor.scale(r/(1-w.r)/Math.max(1-o)),i=e.specularColor.subtract(w.scale(1-o)).scale(1/Math.max(o)),s=g.Color3.Lerp(a,i,o*o);return{baseColor:s=s.clampToRef(0,1,s),metallic:o,roughness:1-e.glossiness}},e.prototype._getPerceivedBrightness=function(e){return e?Math.sqrt(.299*e.r*e.r+.587*e.g*e.g+.114*e.b*e.b):0},e.prototype._getMaxComponent=function(e){return e?Math.max(e.r,Math.max(e.g,e.b)):0},e.prototype._convertMetalRoughFactorsToMetallicRoughnessAsync=function(e,t,n,r){return T(this,void 0,void 0,(function(){var o,a,i;return b(this,(function(s){switch(s.label){case 0:return o=[],a={baseColor:e._albedoColor,metallic:e._metallic,roughness:e._roughness},r&&(e._albedoTexture&&o.push(this.exportTextureAsync(e._albedoTexture,t).then((function(e){e&&(n.baseColorTexture=e)}))),(i=e._metallicTexture)&&o.push(this.exportTextureAsync(i,t).then((function(e){e&&(n.metallicRoughnessTexture=e)})))),o.length>0?(this._exporter._materialNeedsUVsSet.add(e),[4,Promise.all(o)]):[3,2];case 1:s.sent(),s.label=2;case 2:return[2,a]}}))}))},e.prototype._getTextureSampler=function(e){var t={};if(!(e&&e instanceof g.Texture))return t;var n=this._getGLTFTextureWrapMode(e.wrapU);10497!==n&&(t.wrapS=n);var r=this._getGLTFTextureWrapMode(e.wrapV);switch(10497!==r&&(t.wrapT=r),e.samplingMode){case g.Texture.LINEAR_LINEAR:t.magFilter=9729,t.minFilter=9729;break;case g.Texture.LINEAR_NEAREST:t.magFilter=9729,t.minFilter=9728;break;case g.Texture.NEAREST_LINEAR:t.magFilter=9728,t.minFilter=9729;break;case g.Texture.NEAREST_LINEAR_MIPLINEAR:t.magFilter=9728,t.minFilter=9987;break;case g.Texture.NEAREST_NEAREST:t.magFilter=9728,t.minFilter=9728;break;case g.Texture.NEAREST_LINEAR_MIPNEAREST:t.magFilter=9728,t.minFilter=9985;break;case g.Texture.LINEAR_NEAREST_MIPNEAREST:t.magFilter=9729,t.minFilter=9984;break;case g.Texture.LINEAR_NEAREST_MIPLINEAR:t.magFilter=9729,t.minFilter=9986;break;case g.Texture.NEAREST_NEAREST_MIPLINEAR:t.magFilter=9728,t.minFilter=9986;break;case g.Texture.LINEAR_LINEAR_MIPLINEAR:t.magFilter=9729,t.minFilter=9987;break;case g.Texture.LINEAR_LINEAR_MIPNEAREST:t.magFilter=9729,t.minFilter=9985;break;case g.Texture.NEAREST_NEAREST_MIPNEAREST:t.magFilter=9728,t.minFilter=9984}return t},e.prototype._getGLTFTextureWrapMode=function(e){switch(e){case g.Texture.WRAP_ADDRESSMODE:return 10497;case g.Texture.CLAMP_ADDRESSMODE:return 33071;case g.Texture.MIRROR_ADDRESSMODE:return 33648;default:return g.Tools.Error("Unsupported Texture Wrap Mode ".concat(e,"!")),10497}},e.prototype._convertSpecGlossFactorsToMetallicRoughnessAsync=function(e,t,n,r){return T(this,void 0,void 0,(function(){var o,a,i,s,u,c,l,f;return b(this,(function(p){switch(p.label){case 0:return o={diffuseColor:e._albedoColor,specularColor:e._reflectivityColor,glossiness:e._microSurface},a=e._albedoTexture,i=e._reflectivityTexture,s=e._useMicroSurfaceFromReflectivityMapAlpha,i&&!s?[2,Promise.reject("_ConvertPBRMaterial: Glossiness values not included in the reflectivity texture are currently not supported")]:(a||i)&&r?(this._exporter._materialNeedsUVsSet.add(e),u=this._exportTextureSampler(a||i),[4,this._convertSpecularGlossinessTexturesToMetallicRoughnessAsync(a,i,o,t)]):[3,2];case 1:return c=p.sent(),l=this._exporter._textures,c.baseColorTextureData&&(f=this._exportImage("baseColor".concat(l.length),t,c.baseColorTextureData),n.baseColorTexture=this._exportTextureInfo(f,u,null==a?void 0:a.coordinatesIndex)),c.metallicRoughnessTextureData&&(f=this._exportImage("metallicRoughness".concat(l.length),t,c.metallicRoughnessTextureData),n.metallicRoughnessTexture=this._exportTextureInfo(f,u,null==i?void 0:i.coordinatesIndex)),[2,c];case 2:return[2,this._convertSpecularGlossinessToMetallicRoughness(o)]}}))}))},e.prototype.exportPBRMaterialAsync=function(e,t,n){return T(this,void 0,void 0,(function(){var r,o,a,i,s,u,c,l;return b(this,(function(f){switch(f.label){case 0:return r={},o={name:e.name},(a=e.isMetallicWorkflow())&&(i=e._albedoColor,s=e.alpha,i&&(r.baseColorFactor=[i.r,i.g,i.b,s])),a?[4,this._convertMetalRoughFactorsToMetallicRoughnessAsync(e,t,r,n)]:[3,2];case 1:return c=f.sent(),[3,4];case 2:return[4,this._convertSpecGlossFactorsToMetallicRoughnessAsync(e,t,r,n)];case 3:c=f.sent(),f.label=4;case 4:return u=c,[4,this._setMetallicRoughnessPbrMaterialAsync(u,e,o,r,t,n)];case 5:return f.sent(),[4,this._finishMaterialAsync(o,e,t)];case 6:return f.sent(),(l=this._exporter._materials).push(o),[2,l.length-1]}}))}))},e.prototype._setMetallicRoughnessPbrMaterialAsync=function(e,t,n,r,o,a){return T(this,void 0,void 0,(function(){var i,s,u,c,l;return b(this,(function(f){switch(f.label){case 0:return I(n,t),e.baseColor.equalsWithEpsilon(C,M)&&g.Scalar.WithinEpsilon(t.alpha,1,M)||(r.baseColorFactor=[e.baseColor.r,e.baseColor.g,e.baseColor.b,t.alpha]),null!=e.metallic&&1!==e.metallic&&(r.metallicFactor=e.metallic),null!=e.roughness&&1!==e.roughness&&(r.roughnessFactor=e.roughness),null==t.backFaceCulling||t.backFaceCulling||(t._twoSidedLighting||g.Tools.Warn(t.name+": Back-face culling disabled and two-sided lighting disabled is not supported in glTF."),n.doubleSided=!0),a?(i=[],(s=t._bumpTexture)&&i.push(this.exportTextureAsync(s,o).then((function(e){e&&(n.normalTexture=e,1!==s.level&&(n.normalTexture.scale=s.level))}))),(u=t._ambientTexture)&&i.push(this.exportTextureAsync(u,o).then((function(e){if(e){var r={index:e.index,texCoord:e.texCoord,extensions:e.extensions};n.occlusionTexture=r;var o=t._ambientTextureStrength;o&&(r.strength=o)}}))),(c=t._emissiveTexture)&&i.push(this.exportTextureAsync(c,o).then((function(e){e&&(n.emissiveTexture=e)}))),i.length>0?(this._exporter._materialNeedsUVsSet.add(t),[4,Promise.all(i)]):[3,2]):[3,2];case 1:f.sent(),f.label=2;case 2:return(l=t._emissiveColor).equalsWithEpsilon(R,M)||(n.emissiveFactor=l.asArray()),n.pbrMetallicRoughness=r,[2]}}))}))},e.prototype._getPixelsFromTexture=function(e){return e.textureType,g.Constants.TEXTURETYPE_UNSIGNED_BYTE,e.readPixels()},e.prototype.exportTextureAsync=function(e,t){return T(this,void 0,void 0,(function(){var n,r=this;return b(this,(function(o){return(n=this._exporter._extensionsPreExportTextureAsync("exporter",e,t))?[2,n.then((function(n){return n?r._exportTextureInfoAsync(n,t):r._exportTextureInfoAsync(e,t)}))]:[2,this._exportTextureInfoAsync(e,t)]}))}))},e.prototype._exportTextureInfoAsync=function(e,t){return T(this,void 0,void 0,(function(){var n,r,o,a,i,s,u,c,l,f=this;return b(this,(function(p){switch(p.label){case 0:return(n=this._textureMap.get(e))?[3,3]:[4,this._getPixelsFromTexture(e)];case 1:if(!(r=p.sent()))return[2,null];if(o=this._exportTextureSampler(e),a=e.mimeType)switch(a){case"image/jpeg":case"image/png":case"image/webp":t=a;break;default:g.Tools.Warn("Unsupported media type: ".concat(a))}return i=this._internalTextureToImage,s=e.getInternalTexture().uniqueId,i[s]||(i[s]={}),void 0===(u=i[s][t])&&(c=e.getSize(),u=T(f,void 0,void 0,(function(){var n;return b(this,(function(o){switch(o.label){case 0:return[4,this._getImageDataAsync(r,c.width,c.height,t)];case 1:return n=o.sent(),[2,this._exportImage(e.name,t,n)]}}))})),i[s][t]=u),l=this._exportTextureInfo,[4,u];case 2:n=l.apply(this,[p.sent(),o,e.coordinatesIndex]),this._textureMap.set(e,n),this._exporter._extensionsPostExportTextures("exporter",n,e),p.label=3;case 3:return[2,n]}}))}))},e.prototype._exportImage=function(e,t,n){var r=this._exporter._imageData,o=e.replace(/\.\/|\/|\.\\|\\/g,"_"),a=function(e){switch(e){case"image/jpeg":return".jpg";case"image/png":return".png";case"image/webp":return".webp";case"image/avif":return".avif"}}(t),i=o+a;i in r&&(i="".concat(o,"_").concat(g.Tools.RandomId()).concat(a)),r[i]={data:n,mimeType:t};var s=this._exporter._images;return s.push({name:e,uri:i}),s.length-1},e.prototype._exportTextureInfo=function(e,t,n){var r=this._exporter._textures,o=r.findIndex((function(n){return n.sampler==t&&n.source===e}));-1===o&&(o=r.length,r.push({source:e,sampler:t}));var a={index:o};return n&&(a.texCoord=n),a},e.prototype._exportTextureSampler=function(e){var t=this._getTextureSampler(e),n=this._exporter._samplers,r=n.findIndex((function(e){return e.minFilter===t.minFilter&&e.magFilter===t.magFilter&&e.wrapS===t.wrapS&&e.wrapT===t.wrapT}));return-1!==r?r:(n.push(t),n.length-1)},e}(),B=g.Matrix.Compose(new g.Vector3(-1,1,1),g.Quaternion.Identity(),g.Vector3.Zero()),O=new g.Quaternion(0,1,0,0),U=1e-6,L=g.Vector3.Zero(),k=g.Vector3.One();function D(e,t,n,r){var o={buffer:e,byteLength:n};return t&&(o.byteOffset=t),r&&(o.byteStride=r),o}function K(e,t,n,r,o,a,i){void 0===a&&(a=null);var s={bufferView:e,componentType:n,count:r,type:t};return null!=a&&(s.min=a.min,s.max=a.max),i&&(s.normalized=i),null!=o&&(s.byteOffset=o),s}function W(e,t){if(e==g.VertexBuffer.ColorKind)return t?"VEC4":"VEC3";switch(e){case g.VertexBuffer.PositionKind:case g.VertexBuffer.NormalKind:return"VEC3";case g.VertexBuffer.TangentKind:case g.VertexBuffer.MatricesIndicesKind:case g.VertexBuffer.MatricesIndicesExtraKind:case g.VertexBuffer.MatricesWeightsKind:case g.VertexBuffer.MatricesWeightsExtraKind:return"VEC4";case g.VertexBuffer.UVKind:case g.VertexBuffer.UV2Kind:case g.VertexBuffer.UV3Kind:case g.VertexBuffer.UV4Kind:case g.VertexBuffer.UV5Kind:case g.VertexBuffer.UV6Kind:return"VEC2"}throw new Error("Unknown kind ".concat(e))}function G(e){switch(e){case g.VertexBuffer.PositionKind:return"POSITION";case g.VertexBuffer.NormalKind:return"NORMAL";case g.VertexBuffer.TangentKind:return"TANGENT";case g.VertexBuffer.ColorKind:return"COLOR_0";case g.VertexBuffer.UVKind:return"TEXCOORD_0";case g.VertexBuffer.UV2Kind:return"TEXCOORD_1";case g.VertexBuffer.UV3Kind:return"TEXCOORD_2";case g.VertexBuffer.UV4Kind:return"TEXCOORD_3";case g.VertexBuffer.UV5Kind:return"TEXCOORD_4";case g.VertexBuffer.UV6Kind:return"TEXCOORD_5";case g.VertexBuffer.MatricesIndicesKind:return"JOINTS_0";case g.VertexBuffer.MatricesIndicesExtraKind:return"JOINTS_1";case g.VertexBuffer.MatricesWeightsKind:return"WEIGHTS_0";case g.VertexBuffer.MatricesWeightsExtraKind:return"WEIGHTS_1"}throw new Error("Unknown kind: ".concat(e))}function q(e){switch(e){case g.Material.TriangleFillMode:return 4;case g.Material.TriangleStripDrawMode:return 5;case g.Material.TriangleFanDrawMode:return 6;case g.Material.PointListDrawMode:case g.Material.PointFillMode:return 0;case g.Material.LineLoopDrawMode:return 2;case g.Material.LineListDrawMode:return 1;case g.Material.LineStripDrawMode:return 3}throw new Error("Unknown fill mode: ".concat(e))}function j(e){var t=Math.sqrt(e.x*e.x+e.y*e.y+e.z*e.z);t>0&&(e.x/=t,e.y/=t,e.z/=t)}function z(e){return e.x*=-1,e}function H(e){return e.x*=-1,e.y*=-1,e}function Q(e){return e.multiplyInPlace(O)}function Y(e,t){return t instanceof g.TransformNode&&1==t.getChildren().length&&0==e.getChildren().length}function X(e,t){if(!(e instanceof g.TransformNode))return!1;if(t){if(!e.getWorldMatrix().isIdentity())return!1}else if(!e.getWorldMatrix().multiplyToRef(B,g.TmpVectors.Matrix[0]).isIdentity())return!1;return!(e instanceof g.Mesh&&e.geometry||e instanceof g.InstancedMesh&&e.sourceMesh.geometry)}function Z(e,t){for(var n=0,r=Object.entries(e);n<r.length;n++){var o=r[n],a=o[0],i=o[1],s=t[a];(Array.isArray(i)&&Array.isArray(s)&&J(i,s)||i===s)&&delete e[a]}return e}function J(e,t){return e.length===t.length&&e.every((function(e,n){return e===t[n]}))}var $,ee=function(){function e(e){this._data=new Uint8Array(e),this._dataView=new DataView(this._data.buffer),this._byteOffset=0}return Object.defineProperty(e.prototype,"byteOffset",{get:function(){return this._byteOffset},enumerable:!1,configurable:!0}),e.prototype.getOutputData=function(){return new Uint8Array(this._data.buffer,0,this._byteOffset)},e.prototype.writeUInt8=function(e){this._checkGrowBuffer(1),this._dataView.setUint8(this._byteOffset,e),this._byteOffset++},e.prototype.writeInt8=function(e){this._checkGrowBuffer(1),this._dataView.setInt8(this._byteOffset,e),this._byteOffset++},e.prototype.writeInt16=function(e){this._checkGrowBuffer(2),this._dataView.setInt16(this._byteOffset,e,!0),this._byteOffset+=2},e.prototype.writeUInt16=function(e){this._checkGrowBuffer(2),this._dataView.setUint16(this._byteOffset,e,!0),this._byteOffset+=2},e.prototype.writeUInt32=function(e){this._checkGrowBuffer(4),this._dataView.setUint32(this._byteOffset,e,!0),this._byteOffset+=4},e.prototype.writeFloat32=function(e){this._checkGrowBuffer(4),this._dataView.setFloat32(this._byteOffset,e,!0),this._byteOffset+=4},e.prototype.writeUint8Array=function(e){this._checkGrowBuffer(e.byteLength),this._data.set(e,this._byteOffset),this._byteOffset+=e.byteLength},e.prototype.writeUint16Array=function(e){this._checkGrowBuffer(e.byteLength),this._data.set(e,this._byteOffset),this._byteOffset+=e.byteLength},e.prototype._checkGrowBuffer=function(e){var t=this.byteOffset+e;if(t>this._data.byteLength){var n=new Uint8Array(2*t);n.set(this._data),this._data=n,this._dataView=new DataView(this._data.buffer)}},e}();!function(e){e[e.INTANGENT=0]="INTANGENT",e[e.OUTTANGENT=1]="OUTTANGENT"}($||($={}));var te=function(){function e(){}return e._IsTransformable=function(e){return e&&(e instanceof g.TransformNode||e instanceof g.Camera||e instanceof g.Light)},e._CreateNodeAnimation=function(t,n,r,o,a){if(this._IsTransformable(t)){var i=[],s=[],u=n.getKeys(),c=e._CalculateMinMaxKeyFrames(u),l=e._DeduceInterpolation(u,r,o),f=l.interpolationType,p=l.shouldBakeAnimation;if(p?e._CreateBakedAnimation(t,n,r,c.min,c.max,n.framePerSecond,a,i,s,c,o):"LINEAR"===f||"STEP"===f?e._CreateLinearOrStepAnimation(t,n,r,i,s,o):"CUBICSPLINE"===f?e._CreateCubicSplineAnimation(t,n,r,i,s,o):e._CreateBakedAnimation(t,n,r,c.min,c.max,n.framePerSecond,a,i,s,c,o),i.length&&s.length)return{inputs:i,outputs:s,samplerInterpolation:f,inputsMin:p?c.min:g.Tools.FloatRound(c.min/n.framePerSecond),inputsMax:p?c.max:g.Tools.FloatRound(c.max/n.framePerSecond)}}return null},e._DeduceAnimationInfo=function(e){var t=null,n="VEC3",r=!1,o=e.targetProperty.split(".");switch(o[0]){case"scaling":t="scale";break;case"position":t="translation";break;case"rotation":n="VEC4",t="rotation";break;case"rotationQuaternion":n="VEC4",r=!0,t="rotation";break;case"influence":n="SCALAR",t="weights";break;default:g.Tools.Error("Unsupported animatable property ".concat(o[0]))}return t?{animationChannelTargetPath:t,dataAccessorType:n,useQuaternion:r}:(g.Tools.Error("animation channel target path and data accessor type could be deduced"),null)},e._CreateNodeAnimationFromNodeAnimations=function(t,n,r,o,a,i,s,u,c,l,f){var p;if(e._IsTransformable(t)&&t.animations)for(var h=0,d=t.animations;h<d.length;h++){var m=d[h];if(!f||f(m)){var g=e._DeduceAnimationInfo(m);g&&(p={name:m.name,samplers:[],channels:[]},e._AddAnimation("".concat(m.name),m.hasRunningRuntimeAnimations?n:p,t,m,g.dataAccessorType,g.animationChannelTargetPath,o,i,s,u,g.useQuaternion,c,l),p.samplers.length&&p.channels.length&&r.push(p))}}},e._CreateMorphTargetAnimationFromMorphTargetAnimations=function(t,n,r,o,a,i,s,u,c,l,f){var p;if(t instanceof g.Mesh){var h=t.morphTargetManager;if(h)for(var d=0;d<h.numTargets;++d)for(var m=0,x=h.getTarget(d).animations;m<x.length;m++){var _=x[m];if(!f||f(_)){for(var y=new g.Animation("".concat(_.name),"influence",_.framePerSecond,_.dataType,_.loopMode,_.enableBlending),v=[],T=_.getKeys(),b=0;b<T.length;++b)for(var A=T[b],M=0;M<h.numTargets;++M)M==d?v.push(A):v.push({frame:A.frame,value:0});y.setKeys(v);var w=e._DeduceAnimationInfo(y);w&&(p={name:y.name,samplers:[],channels:[]},e._AddAnimation(_.name,_.hasRunningRuntimeAnimations?n:p,t,y,w.dataAccessorType,w.animationChannelTargetPath,o,i,s,u,w.useQuaternion,c,l,h.numTargets),p.samplers.length&&p.channels.length&&r.push(p))}}}},e._CreateNodeAndMorphAnimationFromAnimationGroups=function(t,n,r,o,a,i,s,u,c){var l,f;if(t.animationGroups)for(var p=t.animationGroups,h=function(p){var h=new Map,m=new Map,x=new Set,_=p.to-p.from;f={name:p.name,channels:[],samplers:[]};for(var y=function(n){var _=p.targetedAnimations[n],y=_.target,v=_.animation;if(c&&!c(v))return"continue";var T=u.has(y);if(d._IsTransformable(y)||1===y.length&&d._IsTransformable(y[0])){if(A=e._DeduceAnimationInfo(_.animation)){var b=d._IsTransformable(y)?y:d._IsTransformable(y[0])?y[0]:null;b&&e._AddAnimation("".concat(v.name),f,b,v,A.dataAccessorType,A.animationChannelTargetPath,r,o,a,i,A.useQuaternion,s,T)}}else if(y instanceof g.MorphTarget||1===y.length&&y[0]instanceof g.MorphTarget){var A;if(A=e._DeduceAnimationInfo(_.animation)){var M=y instanceof g.MorphTarget?y:y[0];if(M){var w=t.morphTargetManagers.find((function(e){for(var t=0;t<e.numTargets;++t)if(e.getTarget(t)===M)return!0;return!1}));if(w){var E=t.meshes.find((function(e){return e.morphTargetManager===w}));E&&(h.has(E)||h.set(E,new Map),null===(l=h.get(E))||void 0===l||l.set(M,v),x.add(E),m.set(E,v))}}}}},v=0;v<p.targetedAnimations.length;++v)y(v);x.forEach((function(t){for(var n=t.morphTargetManager,u=null,c=[],l=m.get(t).getKeys(),d=l.length,x=0;x<d;++x)for(var y=0;y<n.numTargets;++y){var v=n.getTarget(y),T=h.get(t);if(T){var b=T.get(v);b?(u||(u=new g.Animation("".concat(p.name,"_").concat(t.name,"_MorphWeightAnimation"),"influence",b.framePerSecond,g.Animation.ANIMATIONTYPE_FLOAT,b.loopMode,b.enableBlending)),c.push(b.getKeys()[x])):c.push({frame:p.from+_/d*x,value:v.influence,inTangent:l[0].inTangent?0:void 0,outTangent:l[0].outTangent?0:void 0})}}u.setKeys(c);var A=e._DeduceAnimationInfo(u);A&&e._AddAnimation("".concat(p.name,"_").concat(t.name,"_MorphWeightAnimation"),f,t,u,A.dataAccessorType,A.animationChannelTargetPath,r,o,a,i,A.useQuaternion,s,!1,null==n?void 0:n.numTargets)})),f.channels.length&&f.samplers.length&&n.push(f)},d=this,m=0,x=p;m<x.length;m++)h(x[m])},e._AddAnimation=function(t,n,r,o,a,i,s,u,c,l,f,p,h,d){var m,x,_,y,v,T,b,A=e._CreateNodeAnimation(r,o,i,f,p);if(A){if(d){for(var M=0,w=0,E=[];A.inputs.length>0;)w=A.inputs.shift(),M%d==0&&E.push(w),M++;A.inputs=E}var C=s.get(r),R=4*A.inputs.length;m=D(0,u.byteOffset,R),c.push(m),A.inputs.forEach((function(e){u.writeFloat32(e)})),x=K(c.length-1,"SCALAR",5126,A.inputs.length,null,{min:[A.inputsMin],max:[A.inputsMax]}),l.push(x),_=l.length-1,v=A.outputs.length,R=4*function(e){switch(e){case"MAT2":case"VEC4":return 4;case"MAT3":return 9;case"MAT4":return 16;case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":return 3}}(a)*A.outputs.length,m=D(0,u.byteOffset,R),c.push(m);var V=new g.Quaternion,S=new g.Vector3,I=new g.Vector3,F=r instanceof g.Camera;A.outputs.forEach((function(e){if(h)switch(i){case"translation":g.Vector3.FromArrayToRef(e,0,I),z(I),u.writeFloat32(I.x),u.writeFloat32(I.y),u.writeFloat32(I.z);break;case"rotation":4===e.length?g.Quaternion.FromArrayToRef(e,0,V):(g.Vector3.FromArrayToRef(e,0,S),g.Quaternion.FromEulerVectorToRef(S,V)),F?Q(V):g.Quaternion.IsIdentity(V)||H(V),u.writeFloat32(V.x),u.writeFloat32(V.y),u.writeFloat32(V.z),u.writeFloat32(V.w);break;default:e.forEach((function(e){u.writeFloat32(e)}))}else"rotation"===i?(4===e.length?g.Quaternion.FromArrayToRef(e,0,V):(g.Vector3.FromArrayToRef(e,0,S),g.Quaternion.FromEulerVectorToRef(S,V)),F&&Q(V),u.writeFloat32(V.x),u.writeFloat32(V.y),u.writeFloat32(V.z),u.writeFloat32(V.w)):e.forEach((function(e){u.writeFloat32(e)}))})),x=K(c.length-1,a,5126,v,null),l.push(x),y=l.length-1,T={interpolation:A.samplerInterpolation,input:_,output:y},n.samplers.push(T),b={sampler:n.samplers.length-1,target:{node:C,path:i}},n.channels.push(b)}},e._CreateBakedAnimation=function(t,n,r,o,a,i,s,u,c,l,f){var p,h,d=g.Quaternion.Identity(),m=null,x=null,_=null,y=null,v=null,T=null;l.min=g.Tools.FloatRound(o/i);for(var b=n.getKeys(),A=0,M=b.length;A<M;++A){if(T=null,_=b[A],A+1<M)if(y=b[A+1],_.value.equals&&_.value.equals(y.value)||_.value===y.value){if(0!==A)continue;T=_.frame}else T=y.frame;else{if(v=b[A-1],_.value.equals&&_.value.equals(v.value)||_.value===v.value)continue;T=a}if(T)for(var w=_.frame;w<=T;w+=s)if((h=g.Tools.FloatRound(w/i))!==m){m=h,x=h;var E={key:0,repeatCount:0,loopMode:n.loopMode};p=n._interpolate(w,E),e._SetInterpolatedValue(t,p,h,n,r,d,u,c,f)}}x&&(l.max=x)},e._ConvertFactorToVector3OrQuaternion=function(t,n,r,o,a){var i=e._GetBasePositionRotationOrScale(n,o,a),s=r.targetProperty.split("."),u=s?s[1]:"",c=a?g.Quaternion.FromArray(i).normalize():g.Vector3.FromArray(i);switch(u){case"x":case"y":case"z":c[u]=t;break;case"w":c.w=t;break;default:g.Tools.Error('glTFAnimation: Unsupported component name "'.concat(u,'"!'))}return c},e._SetInterpolatedValue=function(e,t,n,r,o,a,i,s,u){var c;i.push(n),"weights"!==o?(r.dataType===g.Animation.ANIMATIONTYPE_FLOAT&&(t=this._ConvertFactorToVector3OrQuaternion(t,e,r,o,u)),"rotation"===o?(u?a=t:(c=t,g.Quaternion.RotationYawPitchRollToRef(c.y,c.x,c.z,a)),s.push(a.asArray())):(c=t,s.push(c.asArray()))):s.push([t])},e._CreateLinearOrStepAnimation=function(t,n,r,o,a,i){for(var s=0,u=n.getKeys();s<u.length;s++){var c=u[s];o.push(c.frame/n.framePerSecond),e._AddKeyframeValue(c,n,a,r,t,i)}},e._CreateCubicSplineAnimation=function(t,n,r,o,a,i){n.getKeys().forEach((function(s){o.push(s.frame/n.framePerSecond),e._AddSplineTangent($.INTANGENT,a,r,"CUBICSPLINE",s,i),e._AddKeyframeValue(s,n,a,r,t,i),e._AddSplineTangent($.OUTTANGENT,a,r,"CUBICSPLINE",s,i)}))},e._GetBasePositionRotationOrScale=function(e,t,n){var r;if("rotation"===t)if(n){var o=e.rotationQuaternion;r=(null!=o?o:g.Quaternion.Identity()).asArray()}else{var a=e.rotation;r=(null!=a?a:g.Vector3.Zero()).asArray()}else if("translation"===t){var i=e.position;r=(null!=i?i:g.Vector3.Zero()).asArray()}else{var s=e.scaling;r=(null!=s?s:g.Vector3.One()).asArray()}return r},e._AddKeyframeValue=function(e,t,n,r,o,a){var i,s=t.dataType;if(s===g.Animation.ANIMATIONTYPE_VECTOR3){var u=e.value.asArray();if("rotation"===r){var c=g.Vector3.FromArray(u);u=g.Quaternion.RotationYawPitchRoll(c.y,c.x,c.z).asArray()}n.push(u)}else if(s===g.Animation.ANIMATIONTYPE_FLOAT){if("weights"===r)n.push([e.value]);else if(i=this._ConvertFactorToVector3OrQuaternion(e.value,o,t,r,a)){if("rotation"===r){var l=a?i:g.Quaternion.RotationYawPitchRoll(i.y,i.x,i.z).normalize();n.push(l.asArray())}n.push(i.asArray())}}else s===g.Animation.ANIMATIONTYPE_QUATERNION?n.push(e.value.normalize().asArray()):g.Tools.Error("glTFAnimation: Unsupported key frame values for animation!")},e._DeduceInterpolation=function(e,t,n){var r,o,a=!1;if("rotation"===t&&!n)return{interpolationType:"LINEAR",shouldBakeAnimation:!0};for(var i=0,s=e.length;i<s;++i)if((o=e[i]).inTangent||o.outTangent)if(r){if("CUBICSPLINE"!==r){r="LINEAR",a=!0;break}}else r="CUBICSPLINE";else if(r){if("CUBICSPLINE"===r||o.interpolation&&1===o.interpolation&&"STEP"!==r){r="LINEAR",a=!0;break}}else r=o.interpolation&&1===o.interpolation?"STEP":"LINEAR";return r||(r="LINEAR"),{interpolationType:r,shouldBakeAnimation:a}},e._AddSplineTangent=function(e,t,n,r,o,a){var i,s=e===$.INTANGENT?o.inTangent:o.outTangent;if("CUBICSPLINE"===r){if("rotation"===n)if(s)if(a)i=s.asArray();else{var u=s;i=g.Quaternion.RotationYawPitchRoll(u.y,u.x,u.z).asArray()}else i=[0,0,0,0];else i="weights"===n?s?[s]:[0]:s?s.asArray():[0,0,0];t.push(i)}},e._CalculateMinMaxKeyFrames=function(e){var t=1/0,n=-1/0;return e.forEach((function(e){t=Math.min(t,e.frame),n=Math.max(n,e.frame)})),{min:t,max:n}},e}();function ne(e,t,n,r,o,a){var i={attributes:{},influence:e.influence,name:e.name},s=a?-1:1,u=g.Vector3.Zero(),c=0,l=0,f=0,p=0;if(e.hasPositions){var h=e.getPositions(),d=t.getVerticesData(g.VertexBuffer.PositionKind,void 0,void 0,!0);if(d){var m=[1/0,1/0,1/0],x=[-1/0,-1/0,-1/0];l=d.length/3,f=n.byteOffset;for(var _=c=0;_<l;++_){var y=g.Vector3.FromArray(d,3*_);g.Vector3.FromArray(h,3*_).subtractToRef(y,u),u.x*=s,m[0]=Math.min(m[0],u.x),x[0]=Math.max(x[0],u.x),m[1]=Math.min(m[1],u.y),x[1]=Math.max(x[1],u.y),m[2]=Math.min(m[2],u.z),x[2]=Math.max(x[2],u.z),n.writeFloat32(u.x),n.writeFloat32(u.y),n.writeFloat32(u.z)}r.push(D(0,f,4*h.length,12)),p=r.length-1,o.push(K(p,"VEC3",5126,h.length/3,0,{min:m,max:x})),i.attributes.POSITION=o.length-1}else g.Tools.Warn("Morph target positions for mesh ".concat(t.name," were not exported. Mesh does not have position vertex data"))}if(e.hasNormals){var v=e.getNormals(),T=t.getVerticesData(g.VertexBuffer.NormalKind,void 0,void 0,!0);if(T){for(l=T.length/3,f=n.byteOffset,_=c=0;_<l;++_){var b=g.Vector3.FromArray(T,3*_).normalize();g.Vector3.FromArray(v,3*_).normalize().subtractToRef(b,u),n.writeFloat32(u.x*s),n.writeFloat32(u.y),n.writeFloat32(u.z)}r.push(D(0,f,4*v.length,12)),p=r.length-1,o.push(K(p,"VEC3",5126,v.length/3,0)),i.attributes.NORMAL=o.length-1}else g.Tools.Warn("Morph target normals for mesh ".concat(t.name," were not exported. Mesh does not have normals vertex data"))}if(e.hasTangents){var A=e.getTangents(),M=t.getVerticesData(g.VertexBuffer.TangentKind,void 0,void 0,!0);if(M){for(l=M.length/4,c=0,f=n.byteOffset,_=c;_<l;++_){var w=g.Vector3.FromArray(M,4*_);j(w);var E=g.Vector3.FromArray(A,3*_);j(E),E.subtractToRef(w,u),n.writeFloat32(u.x*s),n.writeFloat32(u.y),n.writeFloat32(u.z)}r.push(D(0,f,4*l*3,12)),p=r.length-1,o.push(K(p,"VEC3",5126,l,0)),i.attributes.TANGENT=o.length-1}else g.Tools.Warn("Morph target tangents for mesh ".concat(t.name," were not exported. Mesh does not have tangents vertex data"))}return i}var re=function(){function e(e,t){this._indicesAccessorMap=new Map,this._vertexBufferViewMap=new Map,this._vertexAccessorMap=new Map,this._remappedBufferView=new Map,this._meshMorphTargetMap=new Map,this._vertexMapColorAlpha=new Map,this._exportedNodes=new Set,this._meshMap=new Map,this.convertedToRightHandedBuffers=new Map,this.convertToRightHanded=e,this.wasAddedByNoopNode=t}return e.prototype.getIndicesAccessor=function(e,t,n,r,o){var a,i,s,u;return null===(u=null===(s=null===(i=null===(a=this._indicesAccessorMap.get(e))||void 0===a?void 0:a.get(t))||void 0===i?void 0:i.get(n))||void 0===s?void 0:s.get(r))||void 0===u?void 0:u.get(o)},e.prototype.setIndicesAccessor=function(e,t,n,r,o,a){var i=this._indicesAccessorMap.get(e);i||(i=new Map,this._indicesAccessorMap.set(e,i));var s=i.get(t);s||(s=new Map,i.set(t,s));var u=s.get(n);u||(u=new Map,s.set(n,u));var c=u.get(r);c||(c=new Map,u.set(r,c)),c.set(o,a)},e.prototype.pushExportedNode=function(e){this._exportedNodes.has(e)||this._exportedNodes.add(e)},e.prototype.getNodesSet=function(){return this._exportedNodes},e.prototype.getVertexBufferView=function(e){return this._vertexBufferViewMap.get(e)},e.prototype.setVertexBufferView=function(e,t){this._vertexBufferViewMap.set(e,t)},e.prototype.setRemappedBufferView=function(e,t,n){this._remappedBufferView.set(e,new Map),this._remappedBufferView.get(e).set(t,n)},e.prototype.getRemappedBufferView=function(e,t){var n;return null===(n=this._remappedBufferView.get(e))||void 0===n?void 0:n.get(t)},e.prototype.getVertexAccessor=function(e,t,n){var r,o;return null===(o=null===(r=this._vertexAccessorMap.get(e))||void 0===r?void 0:r.get(t))||void 0===o?void 0:o.get(n)},e.prototype.setVertexAccessor=function(e,t,n,r){var o=this._vertexAccessorMap.get(e);o||(o=new Map,this._vertexAccessorMap.set(e,o));var a=o.get(t);a||(a=new Map,o.set(t,a)),a.set(n,r)},e.prototype.hasVertexColorAlpha=function(e){return this._vertexMapColorAlpha.get(e)||!1},e.prototype.setHasVertexColorAlpha=function(e,t){return this._vertexMapColorAlpha.set(e,t)},e.prototype.getMesh=function(e){return this._meshMap.get(e)},e.prototype.setMesh=function(e,t){this._meshMap.set(e,t)},e.prototype.bindMorphDataToMesh=function(e,t){var n=this._meshMorphTargetMap.get(e)||[];this._meshMorphTargetMap.set(e,n),-1===n.indexOf(t)&&n.push(t)},e.prototype.getMorphTargetsFromMesh=function(e){return this._meshMorphTargetMap.get(e)},e}(),oe=function(){function e(e,t){if(void 0===e&&(e=g.EngineStore.LastCreatedScene),this._glTF={asset:{generator:"Babylon.js v".concat(g.Engine.Version),version:"2.0"}},this._animations=[],this._accessors=[],this._bufferViews=[],this._cameras=[],this._images=[],this._materials=[],this._meshes=[],this._nodes=[],this._samplers=[],this._scenes=[],this._skins=[],this._textures=[],this._imageData={},this._orderedImageData=[],this._materialExporter=new P(this),this._extensions={},this._dataWriter=new ee(4),this._shouldExportNodeMap=new Map,this._nodeMap=new Map,this._materialMap=new Map,this._camerasMap=new Map,this._nodesCameraMap=new Map,this._skinMap=new Map,this._nodesSkinMap=new Map,this._materialNeedsUVsSet=new Set,!e)throw new Error("No scene available to export");this._babylonScene=e,this._options=v({shouldExportNode:function(){return!0},shouldExportAnimation:function(){return!0},metadataSelector:function(e){return e},animationSampleRate:1/60,exportWithoutWaitingForScene:!1,exportUnusedUVs:!1,removeNoopRootNodes:!0,includeCoordinateSystemConversionNodes:!1},t),this._loadExtensions()}return e.prototype._applyExtension=function(e,t,n,r){var o=this;if(n>=t.length)return Promise.resolve(e);var a=r(t[n],e);return a?a.then((function(e){return e?o._applyExtension(e,t,n+1,r):null})):this._applyExtension(e,t,n+1,r)},e.prototype._applyExtensions=function(t,n){for(var r=[],o=0,a=e._ExtensionNames;o<a.length;o++){var i=a[o];r.push(this._extensions[i])}return this._applyExtension(t,r,0,n)},e.prototype._extensionsPreExportTextureAsync=function(e,t,n){return this._applyExtensions(t,(function(t,r){return t.preExportTextureAsync&&t.preExportTextureAsync(e,r,n)}))},e.prototype._extensionsPostExportMeshPrimitiveAsync=function(e,t,n){return this._applyExtensions(t,(function(t,r){return t.postExportMeshPrimitiveAsync&&t.postExportMeshPrimitiveAsync(e,r,n)}))},e.prototype._extensionsPostExportNodeAsync=function(e,t,n,r,o){var a=this;return this._applyExtensions(t,(function(t,i){return t.postExportNodeAsync&&t.postExportNodeAsync(e,i,n,r,o,a._dataWriter)}))},e.prototype._extensionsPostExportMaterialAsync=function(e,t,n){return this._applyExtensions(t,(function(t,r){return t.postExportMaterialAsync&&t.postExportMaterialAsync(e,r,n)}))},e.prototype._extensionsPostExportMaterialAdditionalTextures=function(t,n,r){for(var o=[],a=0,i=e._ExtensionNames;a<i.length;a++){var s=i[a],u=this._extensions[s];u.postExportMaterialAdditionalTextures&&o.push.apply(o,u.postExportMaterialAdditionalTextures(t,n,r))}return o},e.prototype._extensionsPostExportTextures=function(t,n,r){for(var o=0,a=e._ExtensionNames;o<a.length;o++){var i=a[o],s=this._extensions[i];s.postExportTexture&&s.postExportTexture(t,n,r)}},e.prototype._forEachExtensions=function(t){for(var n=0,r=e._ExtensionNames;n<r.length;n++){var o=r[n],a=this._extensions[o];a.enabled&&t(a)}},e.prototype._extensionsOnExporting=function(){var e=this;this._forEachExtensions((function(t){var n,r,o;t.wasUsed&&((n=e._glTF).extensionsUsed||(n.extensionsUsed=[]),-1===e._glTF.extensionsUsed.indexOf(t.name)&&e._glTF.extensionsUsed.push(t.name),t.required&&((r=e._glTF).extensionsRequired||(r.extensionsRequired=[]),-1===e._glTF.extensionsRequired.indexOf(t.name)&&e._glTF.extensionsRequired.push(t.name)),(o=e._glTF).extensions||(o.extensions={}),t.onExporting&&t.onExporting())}))},e.prototype._loadExtensions=function(){for(var t=0,n=e._ExtensionNames;t<n.length;t++){var r=n[t],o=e._ExtensionFactories[r](this);this._extensions[r]=o}},e.prototype.dispose=function(){for(var e in this._extensions)this._extensions[e].dispose()},Object.defineProperty(e.prototype,"options",{get:function(){return this._options},enumerable:!1,configurable:!0}),e.RegisterExtension=function(t,n){e.UnregisterExtension(t)&&g.Tools.Warn("Extension with the name ".concat(t," already exists")),e._ExtensionFactories[t]=n,e._ExtensionNames.push(t)},e.UnregisterExtension=function(t){if(!e._ExtensionFactories[t])return!1;delete e._ExtensionFactories[t];var n=e._ExtensionNames.indexOf(t);return-1!==n&&e._ExtensionNames.splice(n,1),!0},e.prototype._generateJSON=function(e,t,n,r){var o,a,i=this,s={byteLength:t},u=t;return s.byteLength&&(this._glTF.buffers=[s]),this._nodes&&this._nodes.length&&(this._glTF.nodes=this._nodes),this._meshes&&this._meshes.length&&(this._glTF.meshes=this._meshes),this._scenes&&this._scenes.length&&(this._glTF.scenes=this._scenes,this._glTF.scene=0),this._cameras&&this._cameras.length&&(this._glTF.cameras=this._cameras),this._bufferViews&&this._bufferViews.length&&(this._glTF.bufferViews=this._bufferViews),this._accessors&&this._accessors.length&&(this._glTF.accessors=this._accessors),this._animations&&this._animations.length&&(this._glTF.animations=this._animations),this._materials&&this._materials.length&&(this._glTF.materials=this._materials),this._textures&&this._textures.length&&(this._glTF.textures=this._textures),this._samplers&&this._samplers.length&&(this._glTF.samplers=this._samplers),this._skins&&this._skins.length&&(this._glTF.skins=this._skins),this._images&&this._images.length&&(e?(this._glTF.images=[],this._images.forEach((function(e){e.uri&&(o=i._imageData[e.uri],i._orderedImageData.push(o),a=D(0,u,o.data.byteLength,void 0),u+=o.data.byteLength,i._bufferViews.push(a),e.bufferView=i._bufferViews.length-1,e.name=void 0,e.mimeType=o.mimeType,e.uri=void 0,i._glTF.images.push(e))})),s.byteLength=u):this._glTF.images=this._images),e||(s.uri=n+".bin"),r?JSON.stringify(this._glTF,null,2):JSON.stringify(this._glTF)},e.prototype.generateGLTFAsync=function(e){return T(this,void 0,void 0,(function(){var t,n,r,o,a,i,s;return b(this,(function(u){switch(u.label){case 0:return[4,this._generateBinaryAsync()];case 1:if(t=u.sent(),this._extensionsOnExporting(),n=this._generateJSON(!1,t.byteLength,e,!0),r=new Blob([t],{type:"application/octet-stream"}),o=e+".gltf",a=e+".bin",(i=new y).files[o]=n,i.files[a]=r,this._imageData)for(s in this._imageData)i.files[s]=new Blob([this._imageData[s].data],{type:this._imageData[s].mimeType});return[2,i]}}))}))},e.prototype._generateBinaryAsync=function(){return T(this,void 0,void 0,(function(){return b(this,(function(e){switch(e.label){case 0:return[4,this._exportSceneAsync()];case 1:return e.sent(),[2,this._dataWriter.getOutputData()]}}))}))},e.prototype._getPadding=function(e){var t=e%4;return 0===t?t:4-t},e.prototype.generateGLBAsync=function(e){return T(this,void 0,void 0,(function(){var t,n,r,o,a,i,s,u,c,l,f,p,h,d,m,g,x,_,v,T,A,M,w,E,C,R,V,S,I;return b(this,(function(b){switch(b.label){case 0:return[4,this._generateBinaryAsync()];case 1:for(t=b.sent(),this._extensionsOnExporting(),n=this._generateJSON(!0,t.byteLength),r=e+".glb",o=n.length,i=0,"undefined"!=typeof TextEncoder&&(s=new TextEncoder,a=s.encode(n),o=a.length),V=0;V<this._orderedImageData.length;++V)i+=this._orderedImageData[V].data.byteLength;if(u=this._getPadding(o),c=this._getPadding(t.byteLength),l=this._getPadding(i),f=28+o+u+t.byteLength+c+i+l,p=new ArrayBuffer(12),(h=new DataView(p)).setUint32(0,1179937895,!0),h.setUint32(4,2,!0),h.setUint32(8,f,!0),d=new ArrayBuffer(8+o+u),(m=new DataView(d)).setUint32(0,o+u,!0),m.setUint32(4,1313821514,!0),g=new Uint8Array(d,8),a)g.set(a);else for(x="_".charCodeAt(0),V=0;V<o;++V)(_=n.charCodeAt(V))!=n.codePointAt(V)?g[V]=x:g[V]=_;for(v=new Uint8Array(d,8+o),V=0;V<u;++V)v[V]=32;for(T=new ArrayBuffer(8),(A=new DataView(T)).setUint32(0,t.byteLength+c+i+l,!0),A.setUint32(4,5130562,!0),M=new ArrayBuffer(c),w=new Uint8Array(M),V=0;V<c;++V)w[V]=0;for(E=new ArrayBuffer(l),C=new Uint8Array(E),V=0;V<l;++V)C[V]=0;for(R=[p,d,T,t],V=0;V<this._orderedImageData.length;++V)R.push(this._orderedImageData[V].data);return R.push(M),R.push(E),S=new Blob(R,{type:"application/octet-stream"}),(I=new y).files[r]=S,[2,I]}}))}))},e.prototype._setNodeTransformation=function(e,t,n){if(t.getPivotPoint().equalsToFloats(0,0,0)||g.Tools.Warn("Pivot points are not supported in the glTF serializer"),!t.position.equalsToFloats(0,0,0)){var r=g.TmpVectors.Vector3[0].copyFrom(t.position);n&&z(r),e.translation=r.asArray()}t.scaling.equalsToFloats(1,1,1)||(e.scale=t.scaling.asArray());var o=g.Quaternion.FromEulerAngles(t.rotation.x,t.rotation.y,t.rotation.z);t.rotationQuaternion&&o.multiplyInPlace(t.rotationQuaternion),g.Quaternion.IsIdentity(o)||(n&&H(o),e.rotation=o.normalize().asArray())},e.prototype._setCameraTransformation=function(e,t,n,r){var o=g.TmpVectors.Vector3[0],a=g.TmpVectors.Quaternion[0];if(null!==r){var i=g.Matrix.Invert(r.getWorldMatrix());t.getWorldMatrix().multiply(i).decompose(void 0,a,o)}else t.getWorldMatrix().decompose(void 0,a,o);o.equalsToFloats(0,0,0)||(e.translation=o.asArray()),g.Quaternion.IsIdentity(a)||(e.rotation=a.asArray())},e.prototype._listAvailableCameras=function(){for(var e=0,t=this._babylonScene.cameras;e<t.length;e++){var n=t[e],r={type:n.mode===g.Camera.PERSPECTIVE_CAMERA?"perspective":"orthographic"};if(n.name&&(r.name=n.name),"perspective"===r.type)r.perspective={aspectRatio:n.getEngine().getAspectRatio(n),yfov:n.fovMode===g.Camera.FOVMODE_VERTICAL_FIXED?n.fov:n.fov*n.getEngine().getAspectRatio(n),znear:n.minZ,zfar:n.maxZ};else if("orthographic"===r.type){var o=n.orthoLeft&&n.orthoRight?.5*(n.orthoRight-n.orthoLeft):.5*n.getEngine().getRenderWidth(),a=n.orthoBottom&&n.orthoTop?.5*(n.orthoTop-n.orthoBottom):.5*n.getEngine().getRenderHeight();r.orthographic={xmag:o,ymag:a,znear:n.minZ,zfar:n.maxZ}}this._camerasMap.set(n,r)}},e.prototype._exportAndAssignCameras=function(){for(var e=0,t=Array.from(this._camerasMap.values());e<t.length;e++){var n=t[e],r=this._nodesCameraMap.get(n);if(void 0!==r){this._cameras.push(n);for(var o=0,a=r;o<a.length;o++)a[o].camera=this._cameras.length-1}}},e.prototype._listAvailableSkeletons=function(){for(var e=0,t=this._babylonScene.skeletons;e<t.length;e++){var n=t[e];n.bones.length<=0||this._skinMap.set(n,{joints:[]})}},e.prototype._exportAndAssignSkeletons=function(){for(var e,t=this,n=0,r=this._babylonScene.skeletons;n<r.length;n++){var o=r[n];if(!(o.bones.length<=0)){var a=this._skinMap.get(o);if(null!=a){for(var i={},s=[],u=-1,c=0;c<o.bones.length;++c)-1!==(l=null!==(e=(f=o.bones[c]).getIndex())&&void 0!==e?e:c)&&(i[l]=f,l>u&&(u=l));for(var l=0;l<=u;++l){var f=i[l];s.push(f.getAbsoluteInverseBindMatrix());var p=f.getTransformNode();if(null!==p){var h=this._nodeMap.get(p);p&&null!=h?a.joints.push(h):g.Tools.Warn("Exporting a bone without a linked transform node is currently unsupported")}else g.Tools.Warn("Exporting a bone without a linked transform node is currently unsupported")}var d=this._nodesSkinMap.get(a);if(a.joints.length>0&&void 0!==d){var m=64*s.length,x=D(0,this._dataWriter.byteOffset,m,void 0);this._bufferViews.push(x);var _=K(this._bufferViews.length-1,"MAT4",5126,s.length,null,null),y=this._accessors.push(_)-1;a.inverseBindMatrices=y,s.forEach((function(e){e.m.forEach((function(e){t._dataWriter.writeFloat32(e)}))})),this._skins.push(a);for(var v=0,T=d;v<T.length;v++)T[v].skin=this._skins.length-1}}}}},e.prototype._exportSceneAsync=function(){return T(this,void 0,void 0,(function(){var e,t,n,r,o,a,i,s,u,c,l,f,p,h,d,m,g,x,_,y,v,T;return b(this,(function(b){switch(b.label){case 0:for(e={nodes:[]},this._babylonScene.metadata&&(this._options.metadataSelector?e.extras=this._options.metadataSelector(this._babylonScene.metadata):this._babylonScene.metadata.gltf&&(e.extras=this._babylonScene.metadata.gltf.extras)),t=new Array,n=new Array,r=new Array,o=0,a=this._babylonScene.rootNodes;o<a.length;o++)i=a[o],this._options.removeNoopRootNodes&&!this._options.includeCoordinateSystemConversionNodes&&X(i,this._babylonScene.useRightHandedSystem)?r.push.apply(r,i.getChildren()):this._babylonScene.useRightHandedSystem?t.push(i):n.push(i);return this._listAvailableCameras(),this._listAvailableSkeletons(),s=new re(!0,!1),c=(u=(y=e.nodes).push).apply,l=[y],[4,this._exportNodesAsync(n,s)];case 1:return c.apply(u,l.concat([b.sent()])),f=new re(!1,!1),h=(p=(v=e.nodes).push).apply,d=[v],[4,this._exportNodesAsync(t,f)];case 2:return h.apply(p,d.concat([b.sent()])),m=new re(!1,!0),x=(g=(T=e.nodes).push).apply,_=[T],[4,this._exportNodesAsync(r,m)];case 3:return x.apply(g,_.concat([b.sent()])),e.nodes.length&&this._scenes.push(e),this._exportAndAssignCameras(),this._exportAndAssignSkeletons(),this._babylonScene.animationGroups.length&&te._CreateNodeAndMorphAnimationFromAnimationGroups(this._babylonScene,this._animations,this._nodeMap,this._dataWriter,this._bufferViews,this._accessors,this._animationSampleRate,s.getNodesSet()),[2]}}))}))},e.prototype._shouldExportNode=function(e){var t=this._shouldExportNodeMap.get(e);return void 0===t&&(t=this._options.shouldExportNode(e),this._shouldExportNodeMap.set(e,t)),t},e.prototype._exportNodesAsync=function(e,t){return T(this,void 0,void 0,(function(){var n,r,o,a;return b(this,(function(i){switch(i.label){case 0:n=new Array,this._exportBuffers(e,t),r=0,o=e,i.label=1;case 1:return r<o.length?(a=o[r],[4,this._exportNodeAsync(a,n,t)]):[3,4];case 2:i.sent(),i.label=3;case 3:return r++,[3,1];case 4:return[2,n]}}))}))},e.prototype._collectBuffers=function(e,t,n,r,o){if(this._shouldExportNode(e)&&e instanceof g.Mesh&&e.geometry){var a=e.geometry.getVertexBuffers();if(a)for(var i in a){var s=a[i];o.setHasVertexColorAlpha(s,e.hasVertexAlpha);var u=s._buffer,c=t.get(u)||[];t.set(u,c),-1===c.indexOf(s)&&c.push(s);var l=n.get(s)||[];n.set(s,l),-1===l.indexOf(e)&&l.push(e)}var f=e.morphTargetManager;if(f)for(var p=0;p<f.numTargets;p++){var h=f.getTarget(p);l=r.get(h)||[],r.set(h,l),-1===l.indexOf(e)&&l.push(e)}}for(var d=0,m=e.getChildren();d<m.length;d++){var x=m[d];this._collectBuffers(x,t,n,r,o)}},e.prototype._exportBuffers=function(e,t){for(var n=new Map,r=new Map,o=new Map,a=0,i=e;a<i.length;a++){var s=i[a];this._collectBuffers(s,n,r,o,t)}for(var u=Array.from(n.keys()),c=function(e){var o=e.getData();if(!o)throw new Error("Buffer data is not available");var a=n.get(e);if(!a)return"continue";var i=a[0].byteStride;if(a.some((function(e){return e.byteStride!==i})))throw new Error("Vertex buffers pointing to the same buffer must have the same byte stride");for(var s=function(e){if(e instanceof Array){var t=new Float32Array(e);return new Uint8Array(t.buffer,t.byteOffset,t.byteLength)}return ArrayBuffer.isView(e)?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):new Uint8Array(e)}(o).slice(),u=function(e){var t=e.byteOffset,n=e.byteStride,o=e.type,a=e.normalized,i=e.getSize(),u=r.get(e),c=u.reduce((function(e,t){return t.getTotalVertices()>e?t.getTotalVertices():e}),-Number.MAX_VALUE);switch(e.getKind()){case g.VertexBuffer.NormalKind:case g.VertexBuffer.TangentKind:(0,g.EnumerateFloatValues)(s,t,n,i,o,c*i,a,(function(e){var t=1/Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);e[0]*=t,e[1]*=t,e[2]*=t}));break;case g.VertexBuffer.ColorKind:var f=u.filter((function(e){return e.material instanceof g.StandardMaterial||null==e.material})).length;if(0==f)break;if(f!=u.length){g.Logger.Warn("Not converting vertex color space, as buffer is shared by StandardMaterials and other material types. Results may look incorrect.");break}o==g.VertexBuffer.UNSIGNED_BYTE&&g.Logger.Warn("Converting uint8 vertex colors to linear space. Results may look incorrect.");var p=new g.Color3,h=new g.Color4,d=l._babylonScene.getEngine().useExactSrgbConversions;(0,g.EnumerateFloatValues)(s,t,n,i,o,c*i,a,(function(e){3===e.length?(p.fromArray(e,0),p.toLinearSpaceToRef(p,d),p.toArray(e,0)):(h.fromArray(e,0),h.toLinearSpaceToRef(h,d),h.toArray(e,0))}))}},c=0,f=a;c<f.length;c++)u(F=f[c]);if(t.convertToRightHanded){for(var p=0,h=a;p<h.length;p++)switch((F=h[p]).getKind()){case g.VertexBuffer.PositionKind:case g.VertexBuffer.NormalKind:case g.VertexBuffer.TangentKind:for(var d=0,m=r.get(F);d<m.length;d++){var x=m[d],_=F.byteOffset,y=F.byteStride,v=F.type,T=F.normalized,b=F.getSize();(0,g.EnumerateFloatValues)(s,_,y,b,v,x.getTotalVertices()*b,T,(function(e){e[0]=-e[0]}))}}t.convertedToRightHandedBuffers.set(e,s)}var A=l._dataWriter.byteOffset;l._dataWriter.writeUint8Array(s),l._bufferViews.push(D(0,A,s.length,i)),t.setVertexBufferView(e,l._bufferViews.length-1);for(var M=new Map,w=0,E=a;w<E.length;w++)switch((F=E[w]).getKind()){case g.VertexBuffer.MatricesIndicesKind:case g.VertexBuffer.MatricesIndicesExtraKind:if(F.type==g.VertexBuffer.FLOAT)for(var C=0,R=r.get(F);C<R.length;C++){x=R[C];var V=F.getFloatData(x.getTotalVertices());null!==V&&M.set(F,V)}}0!==M.size&&g.Logger.Warn("Joints conversion needed: some joints are stored as floats in Babylon but GLTF requires UNSIGNED BYTES. We will perform the conversion but this might lead to unused data in the buffer.");for(var S=0,I=Array.from(M.keys());S<I.length;S++){var F=I[S],N=M.get(F);if(N){var P=l._dataWriter.byteOffset;if(N.some((function(e){return e>=256}))){for(var B=new Uint16Array(N.length),O=0;O<N.length;O++)B[O]=N[O];l._dataWriter.writeUint16Array(B),l._bufferViews.push(D(0,P,B.byteLength,8))}else{for(B=new Uint8Array(N.length),O=0;O<N.length;O++)B[O]=N[O];l._dataWriter.writeUint8Array(B),l._bufferViews.push(D(0,P,B.byteLength,4))}t.setRemappedBufferView(e,F,l._bufferViews.length-1)}}},l=this,f=0,p=u;f<p.length;f++)c(p[f]);for(var h=0,d=Array.from(o.keys());h<d.length;h++){var m=d[h],x=o.get(m);if(x)for(var _=ne(m,x[0],this._dataWriter,this._bufferViews,this._accessors,t.convertToRightHanded),y=0,v=x;y<v.length;y++){var T=v[y];t.bindMorphDataToMesh(T,_)}}},e.prototype._exportNodeAsync=function(e,t,n){return T(this,void 0,void 0,(function(){var r,o,a,i,s,u,c,l,f=this;return b(this,(function(p){switch(p.label){case 0:return void 0!==(r=this._nodeMap.get(e))?(t.includes(r)||t.push(r),[2]):[4,this._createNodeAsync(e,n)];case 1:(o=p.sent())&&(r=this._nodes.length,this._nodes.push(o),this._nodeMap.set(e,r),n.pushExportedNode(e),t.push(r),a={name:"runtime animations",channels:[],samplers:[]},i=[],this._babylonScene.animationGroups.length||(te._CreateMorphTargetAnimationFromMorphTargetAnimations(e,a,i,this._nodeMap,this._nodes,this._dataWriter,this._bufferViews,this._accessors,this._animationSampleRate,n.convertToRightHanded,this._options.shouldExportAnimation),e.animations.length&&te._CreateNodeAnimationFromNodeAnimations(e,a,i,this._nodeMap,this._nodes,this._dataWriter,this._bufferViews,this._accessors,this._animationSampleRate,n.convertToRightHanded,this._options.shouldExportAnimation)),a.channels.length&&a.samplers.length&&this._animations.push(a),i.forEach((function(e){e.channels.length&&e.samplers.length&&f._animations.push(e)}))),s=o?[]:t,u=0,c=e.getChildren(),p.label=2;case 2:return u<c.length?(l=c[u],[4,this._exportNodeAsync(l,s,n)]):[3,5];case 3:p.sent(),p.label=4;case 4:return u++,[3,2];case 5:return o&&s.length&&(o.children=s),[2]}}))}))},e.prototype._createNodeAsync=function(e,t){return T(this,void 0,void 0,(function(){var n,r,o,a,i,s,u,c,l,f,p;return b(this,(function(h){switch(h.label){case 0:return this._shouldExportNode(e)?(n={},e.name&&(n.name=e.name),e instanceof g.TransformNode?(this._setNodeTransformation(n,e,t.convertToRightHanded),e instanceof g.Mesh||e instanceof g.InstancedMesh?(r=e instanceof g.Mesh?e:e.sourceMesh).subMeshes&&r.subMeshes.length>0?(o=n,[4,this._exportMeshAsync(r,t)]):[3,2]:[3,3]):[3,3]):[2,null];case 1:o.mesh=h.sent(),h.label=2;case 2:e.skeleton&&void 0!==(a=this._skinMap.get(e.skeleton))&&(void 0===this._nodesSkinMap.get(a)&&this._nodesSkinMap.set(a,[]),null===(l=this._nodesSkinMap.get(a))||void 0===l||l.push(n)),h.label=3;case 3:if(e instanceof g.Camera&&(i=this._camerasMap.get(e))){if(void 0===this._nodesCameraMap.get(i)&&this._nodesCameraMap.set(i,[]),s=e.parent,this._setCameraTransformation(n,e,t.convertToRightHanded,s),s&&Y(e,s)&&(u=this._nodeMap.get(s)))return c=this._nodes[u],null===(f=this._nodesCameraMap.get(i))||void 0===f||f.push(c),[2,null];t.convertToRightHanded&&(d=n,m=g.Vector3.FromArrayToRef(d.translation||[0,0,0],0,g.TmpVectors.Vector3[0]),x=g.Quaternion.FromArrayToRef(d.rotation||[0,0,0,1],0,g.TmpVectors.Quaternion[0]),m=z(m),x=H(x),m.equalsWithEpsilon(L,U)?delete d.translation:d.translation=m.asArray(),g.Quaternion.IsIdentity(x)?delete d.rotation:d.rotation=x.asArray(),function(e){if(e.rotation){var t=g.Quaternion.FromArrayToRef(e.rotation||[0,0,0,1],0,g.TmpVectors.Quaternion[1]);O.multiplyToRef(t,t),e.rotation=t.asArray()}}(n)),null===(p=this._nodesCameraMap.get(i))||void 0===p||p.push(n)}return[4,this._extensionsPostExportNodeAsync("exportNodeAsync",n,e,this._nodeMap,t.convertToRightHanded)];case 4:return h.sent()?[2,n]:(g.Logger.Warn("Not exporting node ".concat(e.name)),[2,null])}var d,m,x}))}))},e.prototype._exportIndices=function(e,t,n,r,o,a,i,s){var u=function(e,t){return e?e instanceof Array?e.some((function(e){return e>=65536})):4===e.BYTES_PER_ELEMENT:t>=65536}(e,n),c=e;s.mode=q(o);var l=a!==g.Material.CounterClockWiseSideOrientation,f=!i.wasAddedByNoopNode&&l,p=function(e){switch(e){case g.Material.TriangleFillMode:case g.Material.TriangleStripDrawMode:case g.Material.TriangleFanDrawMode:return!0}return!1}(o)&&f;if(p){if(o===g.Material.TriangleStripDrawMode||o===g.Material.TriangleFanDrawMode)throw new Error("Triangle strip/fan fill mode is not implemented");s.mode=q(o);var h=u?new Uint32Array(n):new Uint16Array(n);if(e)for(var d=0;d+2<n;d+=3)h[d]=e[t+d]+r,h[d+1]=e[t+d+2]+r,h[d+2]=e[t+d+1]+r;else for(d=0;d+2<n;d+=3)h[d]=d,h[d+1]=d+2,h[d+2]=d+1;c=h}else if(e&&0!==r){for(h=u?new Uint32Array(n):new Uint16Array(n),d=0;d<n;d++)h[d]=e[t+d]+r;c=h}if(c){var m=i.getIndicesAccessor(e,t,n,r,p);if(void 0===m){var x=this._dataWriter.byteOffset,_=function(e,t,n,r){if(e instanceof Array){var o=e.slice(t,t+n);return e=r?new Uint32Array(o):new Uint16Array(o),new Uint8Array(e.buffer,e.byteOffset,e.byteLength)}return ArrayBuffer.isView(e)?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):new Uint8Array(e)}(c,t,n,u);this._dataWriter.writeUint8Array(_),this._bufferViews.push(D(0,x,_.length));var y=this._bufferViews.length-1,v=u?5125:5123;this._accessors.push(K(y,"SCALAR",v,n,0)),m=this._accessors.length-1,i.setIndicesAccessor(e,t,n,r,p,m)}s.indices=m}},e.prototype._exportVertexBuffer=function(e,t,n,r,o,a){var i=e.getKind();if(function(e){switch(e){case g.VertexBuffer.PositionKind:case g.VertexBuffer.NormalKind:case g.VertexBuffer.TangentKind:case g.VertexBuffer.ColorKind:case g.VertexBuffer.MatricesIndicesKind:case g.VertexBuffer.MatricesIndicesExtraKind:case g.VertexBuffer.MatricesWeightsKind:case g.VertexBuffer.MatricesWeightsExtraKind:case g.VertexBuffer.UVKind:case g.VertexBuffer.UV2Kind:case g.VertexBuffer.UV3Kind:case g.VertexBuffer.UV4Kind:case g.VertexBuffer.UV5Kind:case g.VertexBuffer.UV6Kind:return!0}return!1}(i)&&(!i.startsWith("uv")||this._options.exportUnusedUVs||t&&this._materialNeedsUVsSet.has(t))){var s=o.getVertexAccessor(e,n,r);if(void 0===s){var u,c=o.convertedToRightHandedBuffers.get(e._buffer)||e._buffer.getData(),l=i===g.VertexBuffer.PositionKind?function(e,t,n,r){var o=t.byteOffset,a=t.byteStride,i=t.type,s=t.normalized,u=t.getSize(),c=new Array(u).fill(1/0),l=new Array(u).fill(-1/0);return(0,g.EnumerateFloatValues)(e,o+n*a,a,u,i,r*u,s,(function(e){for(var t=0;t<u;t++)c[t]=Math.min(c[t],e[t]),l[t]=Math.max(l[t],e[t])})),{min:c,max:l}}(c,e,n,r):null;if(i!==g.VertexBuffer.MatricesIndicesKind&&i!==g.VertexBuffer.MatricesIndicesExtraKind||e.type!==g.VertexBuffer.FLOAT)u=o.getVertexBufferView(e._buffer),f=e.byteOffset+n*e.byteStride,this._accessors.push(K(u,W(i,o.hasVertexColorAlpha(e)),e.type,r,f,l,e.normalized)),s=this._accessors.length-1,o.setVertexAccessor(e,n,r,s),a.attributes[G(i)]=s;else if(void 0!==(u=o.getRemappedBufferView(e._buffer,e))){var f=e.byteOffset+n*e.byteStride;this._accessors.push(K(u,W(i,o.hasVertexColorAlpha(e)),g.VertexBuffer.UNSIGNED_BYTE,r,f,l)),s=this._accessors.length-1,o.setVertexAccessor(e,n,r,s),a.attributes[G(i)]=s}}else a.attributes[G(i)]=s}},e.prototype._exportMaterialAsync=function(e,t,n,r){return T(this,void 0,void 0,(function(){var o,a;return b(this,(function(i){switch(i.label){case 0:return void 0!==(o=this._materialMap.get(e))?[3,6]:(a=t&&Object.keys(t).some((function(e){return e.startsWith("uv")})),(e=e instanceof g.MultiMaterial?e.subMaterials[n.materialIndex]:e)instanceof g.PBRMaterial?[4,this._materialExporter.exportPBRMaterialAsync(e,"image/png",a)]:[3,2]);case 1:return o=i.sent(),[3,5];case 2:return e instanceof g.StandardMaterial?[4,this._materialExporter.exportStandardMaterialAsync(e,"image/png",a)]:[3,4];case 3:return o=i.sent(),[3,5];case 4:return g.Logger.Warn("Unsupported material '".concat(e.name,"' with type ").concat(e.getClassName())),[2];case 5:this._materialMap.set(e,o),i.label=6;case 6:return r.material=o,[2]}}))}))},e.prototype._exportMeshAsync=function(e,t){return T(this,void 0,void 0,(function(){var n,r,o,a,i,s,u,c,l,f,p,h,d,m,x,_,y,v,T,M,w,E,C,R,V,S;return b(this,(function(b){switch(b.label){case 0:if(void 0!==(n=t.getMesh(e)))return[2,n];if(r={primitives:[]},n=this._meshes.length,this._meshes.push(r),t.setMesh(e,n),o=e.isUnIndexed?null:e.getIndices(),a=null===(V=e.geometry)||void 0===V?void 0:V.getVertexBuffers(),i=t.getMorphTargetsFromMesh(e),s=!1,e instanceof g.LinesMesh&&(s=!0),u=e.subMeshes,!(a&&u&&u.length>0))return[3,6];c=0,l=u,b.label=1;case 1:return c<l.length?(f=l[c],p={attributes:{}},h=f.getMaterial()||this._babylonScene.defaultMaterial,s?(d={name:h.name},(!(m=e).color.equals(g.Color3.White())||m.alpha<1)&&(d.pbrMetallicRoughness={baseColorFactor:A(A([],m.color.asArray(),!0),[m.alpha],!1)}),this._materials.push(d),p.material=this._materials.length-1,[3,4]):[3,2]):[3,6];case 2:return[4,this._exportMaterialAsync(h,a,f,p)];case 3:b.sent(),b.label=4;case 4:for(x=s?g.Material.LineListDrawMode:null!==(S=e.overrideRenderingFillMode)&&void 0!==S?S:h.fillMode,_=h._getEffectiveOrientation(e),this._exportIndices(o,f.indexStart,f.indexCount,-f.verticesStart,x,_,t,p),y=0,v=Object.values(a);y<v.length;y++)T=v[y],this._exportVertexBuffer(T,h,f.verticesStart,f.verticesCount,t,p);if(r.primitives.push(p),i)for(p.targets=[],M=0,w=i;M<w.length;M++)R=w[M],p.targets.push(R.attributes);b.label=5;case 5:return c++,[3,1];case 6:if(i)for(r.weights=[],r.extras||(r.extras={}),r.extras.targetNames=[],E=0,C=i;E<C.length;E++)R=C[E],r.weights.push(R.influence),r.extras.targetNames.push(R.name);return[2,n]}}))}))},e._ExtensionNames=new Array,e._ExtensionFactories={},e}(),ae=function(){function e(){}return e.GLTFAsync=function(e,t,n){return T(this,void 0,void 0,(function(){var r,o;return b(this,(function(a){switch(a.label){case 0:return n&&n.exportWithoutWaitingForScene?[3,2]:[4,e.whenReadyAsync()];case 1:a.sent(),a.label=2;case 2:return[4,(r=new oe(e,n)).generateGLTFAsync(t.replace(/\.[^/.]+$/,""))];case 3:return o=a.sent(),r.dispose(),[2,o]}}))}))},e.GLBAsync=function(e,t,n){return T(this,void 0,void 0,(function(){var r,o;return b(this,(function(a){switch(a.label){case 0:return n&&n.exportWithoutWaitingForScene?[3,2]:[4,e.whenReadyAsync()];case 1:a.sent(),a.label=2;case 2:return[4,(r=new oe(e,n)).generateGLBAsync(t.replace(/\.[^/.]+$/,""))];case 3:return o=a.sent(),r.dispose(),[2,o]}}))}))},e}(),ie=function(){function e(){}return e.CreateSTL=function(e,t,n,r,o,a,i,s){void 0===t&&(t=!0),void 0===n&&(n="stlmesh"),void 0===r&&(r=!1),void 0===o&&(o=!0),void 0===a&&(a=!1),void 0===i&&(i=!1),void 0===s&&(s=!1);var u=function(e,t,n){var r=[3*e[n],3*e[n+1],3*e[n+2]],o=[new g.Vector3(t[r[0]],t[r[0]+2],t[r[0]+1]),new g.Vector3(t[r[1]],t[r[1]+2],t[r[1]+1]),new g.Vector3(t[r[2]],t[r[2]+2],t[r[2]+1])],a=o[0].subtract(o[1]),i=o[2].subtract(o[1]);return{v:o,n:g.Vector3.Cross(i,a).normalize()}},c=function(e,t,n,r){return t=l(e,t,n.x,r),t=l(e,t,n.y,r),l(e,t,n.z,r)},l=function(e,t,n,r){return e.setFloat32(t,n,r),t+4},f=function(e){if(i){var t=e;e instanceof g.InstancedMesh&&(t=e.sourceMesh);var n=t.getVerticesData(g.VertexBuffer.PositionKind,!0,!0);if(!n)return[];var r=g.Vector3.Zero(),o=void 0;for(o=0;o<n.length;o+=3)g.Vector3.TransformCoordinatesFromFloatsToRef(n[o],n[o+1],n[o+2],e.computeWorldMatrix(!0),r).toArray(n,o);return n}return e.getVerticesData(g.VertexBuffer.PositionKind)||[]};i&&(a=!0);var p="",h=0,d=0;if(r){for(var m=0;m<e.length;m++)h+=(v=(_=e[m]).getIndices())?v.length/3:0;var x=new ArrayBuffer(84+50*h);d+=80,(p=new DataView(x)).setUint32(d,h,o),d+=4}else s||(p="solid stlmesh\r\n");for(m=0;m<e.length;m++){var _=e[m];!r&&s&&(p+="solid "+_.name+"\r\n"),!a&&_ instanceof g.Mesh&&_.bakeCurrentTransformIntoVertices();for(var y=f(_),v=_.getIndices()||[],T=0;T<v.length;T+=3){var b=u(v,y,T);r?(d=c(p,d,b.n,o),d=c(p,d,b.v[0],o),d=c(p,d,b.v[1],o),d=c(p,d,b.v[2],o),d+=2):(p+="\tfacet normal "+b.n.x+" "+b.n.y+" "+b.n.z+"\r\n",p+="\t\touter loop\r\n",p+="\t\t\tvertex "+b.v[0].x+" "+b.v[0].y+" "+b.v[0].z+"\r\n",p+="\t\t\tvertex "+b.v[1].x+" "+b.v[1].y+" "+b.v[1].z+"\r\n",p+="\t\t\tvertex "+b.v[2].x+" "+b.v[2].y+" "+b.v[2].z+"\r\n",p+="\t\tendloop\r\n",p+="\tendfacet\r\n")}!r&&s&&(p+="endsolid "+name+"\r\n")}if(r||s||(p+="endsolid stlmesh"),t){var A=document.createElement("a"),M=new Blob([p],{type:"application/octet-stream"});A.href=window.URL.createObjectURL(M),A.download=n+".stl",A.click()}return p},e}();function se(e,t,n){void 0===n&&(n=3);for(var r=[],o=0;o<e.length/n;o++){var a=e[o*n],i=e[o*n+1],s=e[o*n+2];r.push("(".concat(a.toPrecision(t.precision),", ").concat(i.toPrecision(t.precision),", ").concat(s.toPrecision(t.precision),")"))}return r.join(", ")}function ue(e,t){for(var n=[],r=0;r<e.length/2;r++){var o=e[2*r],a=e[2*r+1];n.push("(".concat(o.toPrecision(t.precision),", ").concat((1-a).toPrecision(t.precision),")"))}return n.join(", ")}function ce(e,t){var n=function(e,t){var n=e.getVerticesData(g.VertexBuffer.PositionKind),r=e.getVerticesData(g.VertexBuffer.PositionKind);if(n&&r)return'\n\tdef Mesh "'.concat("Geometry",'"\n\t{\n\t\tint[] faceVertexCounts = [').concat(function(e){var t,n=(null===(t=e.getIndices())||void 0===t?void 0:t.length)?e.getTotalIndices():e.getTotalVertices();return Array(n/3).fill(3).join(", ")}(e),"]\n\t\tint[] faceVertexIndices = [").concat(function(e){var t=e.getIndices(),n=[];if(null!==t)for(var r=0;r<t.length;r++)n.push(t[r]);else{var o=e.getTotalVertices();for(r=0;r<o;r++)n.push(r)}return n.join(", ")}(e),"]\n\t\tnormal3f[] normals = [").concat(se(r,t),'] (\n\t\t\tinterpolation = "vertex"\n\t\t)\n\t\tpoint3f[] points = [').concat(se(n,t),"]\n        ").concat(function(e,t){for(var n="",r=0;r<4;r++){var o=r>0?r:"",a=e.getVerticesData(g.VertexBuffer.UVKind+(o||""));a&&(n+="\n\t\ttexCoord2f[] primvars:st".concat(o," = [").concat(ue(a,t),'] (\n\t\t\tinterpolation = "vertex"\n\t\t)'))}var i=e.getVerticesData(g.VertexBuffer.ColorKind);return i&&(n+="\n\tcolor3f[] primvars:displayColor = [".concat(se(i,t,4),'] (\n\t\tinterpolation = "vertex"\n\t\t)')),n}(e,t),'\n\t\tuniform token subdivisionScheme = "none"\n\t}\n')}(e,t);return'\n        def "Geometry"\n        {\n        '.concat(n,"\n        }\n        ")}function le(e){var t='#usda 1.0\n    (\n        customLayerData = {\n            string creator = "Babylon.js USDZExportAsync"\n        }\n        defaultPrim = "Root"\n        metersPerUnit = 1\n        upAxis = "Y"\n    )';return t+=e,fflate.strToU8(t)}function fe(e){var t=e.m;return"( ".concat(pe(t,0),", ").concat(pe(t,4),", ").concat(pe(t,8),", ").concat(pe(t,12)," )")}function pe(e,t){return"(".concat(e[t+0],", ").concat(e[t+1],", ").concat(e[t+2],", ").concat(e[t+3],")")}function he(e){var t="Object_"+e.uniqueId,n=e.getWorldMatrix().clone();n.determinant()<0&&n.multiplyToRef(g.Matrix.Scaling(-1,1,1),n);var r=fe(n);return'def Xform "'.concat(t,'" (\n\tprepend references = @./geometries/Geometry_').concat(e.geometry.uniqueId,'.usda@</Geometry>\n\tprepend apiSchemas = ["MaterialBindingAPI"]\n)\n{\n\tmatrix4d xformOp:transform = ').concat(r,'\n\tuniform token[] xformOpOrder = ["xformOp:transform"]\t\n\n    rel material:binding = </Materials/Material_').concat(e.material.uniqueId,">\n}\n\n")}function de(e){switch(e){case g.Constants.TEXTURE_CLAMP_ADDRESSMODE:return"clamp";case g.Constants.TEXTURE_MIRROR_ADDRESSMODE:return"mirror";case g.Constants.TEXTURE_WRAP_ADDRESSMODE:default:return"repeat"}}function me(e){return"(".concat(e.x,", ").concat(e.y,")")}function ge(e){return"(".concat(e.r,", ").concat(e.g,", ").concat(e.b,")")}function xe(e,t,n,r,o,a){var i=e.getInternalTexture().uniqueId+"_"+e.invertY;o[i]=e;var s=e.coordinatesIndex>0?"st"+e.coordinatesIndex:"st",u=new g.Vector2(e.uScale,e.vScale),c=new g.Vector2(e.uOffset,e.vOffset),l=e.wAng,f=Math.sin(l),p=Math.cos(l);return c.y=1-c.y-u.y,c.x+=f*u.x,c.y+=(1-p)*u.y,'\n    def Shader "PrimvarReader_'.concat(n,'"\n    {\n        uniform token info:id = "UsdPrimvarReader_float2"\n        float2 inputs:fallback = (0.0, 0.0)\n        token inputs:varname = "').concat(s,'"\n        float2 outputs:result\n    }\n\n    def Shader "Transform2d_').concat(n,'"\n    {\n        uniform token info:id = "UsdTransform2d"\n        token inputs:in.connect = </Materials/Material_').concat(t.uniqueId,"/PrimvarReader_").concat(n,".outputs:result>\n        float inputs:rotation = ").concat((l*(180/Math.PI)).toFixed(a.precision),"\n        float2 inputs:scale = ").concat(me(u),"\n        float2 inputs:translation = ").concat(me(c),'\n        float2 outputs:result\n    }\n\n    def Shader "Texture_').concat(e.uniqueId,"_").concat(n,'"\n    {\n        uniform token info:id = "UsdUVTexture"\n        asset inputs:file = @textures/Texture_').concat(i,".png@\n        float2 inputs:st.connect = </Materials/Material_").concat(t.uniqueId,"/Transform2d_").concat(n,".outputs:result>\n        ").concat(r?"float4 inputs:scale = "+function(e){return"(".concat(e.r,", ").concat(e.g,", ").concat(e.b,", 1.0)")}(r):"",'\n        token inputs:sourceColorSpace = "').concat(e.gammaSpace?"raw":"sRGB",'"\n        token inputs:wrapS = "').concat(de(e.wrapU),'"\n        token inputs:wrapT = "').concat(de(e.wrapV),'"\n        float outputs:r\n        float outputs:g\n        float outputs:b\n        float3 outputs:rgb\n        ').concat(t.needAlphaBlending()?"float outputs:a":"","\n    }")}function _e(e,t,n){var r="\t\t\t",o=[],a=[],i=function(e){switch(e.getClassName()){case"StandardMaterial":return{diffuseMap:e.diffuseTexture,diffuse:e.diffuseColor,alphaCutOff:e.alphaCutOff,emissiveMap:e.emissiveTexture,emissive:e.emissiveColor,roughnessMap:null,normalMap:null,metalnessMap:null,roughness:1,metalness:0,aoMap:null,aoMapIntensity:0,alphaMap:e.opacityTexture,ior:1};case"PBRMaterial":return{diffuseMap:e.albedoTexture,diffuse:e.albedoColor,alphaCutOff:e.alphaCutOff,emissiveMap:e.emissiveTexture,emissive:e.emissiveColor,normalMap:e.bumpTexture,roughnessMap:e.metallicTexture,roughnessChannel:e.useRoughnessFromMetallicTextureAlpha?"a":"g",roughness:e.roughness||1,metalnessMap:e.metallicTexture,metalnessChannel:e.useMetallnessFromMetallicTextureBlue?"b":"r",metalness:e.metallic||0,aoMap:e.ambientTexture,aoMapChannel:e.useAmbientInGrayScale?"r":"rgb",aoMapIntensity:e.ambientTextureStrength,alphaMap:e.opacityTexture,ior:e.indexOfRefraction};case"PBRMetallicRoughnessMaterial":return{diffuseMap:e.baseTexture,diffuse:e.baseColor,alphaCutOff:e.alphaCutOff,emissiveMap:e.emissiveTexture,emissive:e.emissiveColor,normalMap:e.normalTexture,roughnessMap:e.metallicTexture,roughnessChannel:e.useRoughnessFromMetallicTextureAlpha?"a":"g",roughness:e.roughness||1,metalnessMap:e.metallicTexture,metalnessChannel:e.useMetallnessFromMetallicTextureBlue?"b":"r",metalness:e.metallic||0,aoMap:e.ambientTexture,aoMapChannel:e.useAmbientInGrayScale?"r":"rgb",aoMapIntensity:e.ambientTextureStrength,alphaMap:e.opacityTexture,ior:e.indexOfRefraction};default:return{diffuseMap:null,diffuse:null,emissiveMap:null,emissemissiveiveColor:null,normalMap:null,roughnessMap:null,metalnessMap:null,alphaCutOff:0,roughness:0,metalness:0,aoMap:null,aoMapIntensity:0,alphaMap:null,ior:1}}}(e),s=i.diffuseMap,u=i.diffuse,c=i.alphaCutOff,l=i.emissiveMap,f=i.emissive,p=i.normalMap,h=i.roughnessMap,d=i.roughnessChannel,m=i.roughness,x=i.metalnessMap,_=i.metalnessChannel,y=i.metalness,v=i.aoMap,T=i.aoMapChannel,b=i.aoMapIntensity,A=i.alphaMap,M=i.ior;return null!==s?(o.push("".concat(r,"color3f inputs:diffuseColor.connect = </Materials/Material_").concat(e.uniqueId,"/Texture_").concat(s.uniqueId,"_diffuse.outputs:rgb>")),e.needAlphaBlending()?o.push("".concat(r,"float inputs:opacity.connect = </Materials/Material_").concat(e.uniqueId,"/Texture_").concat(s.uniqueId,"_diffuse.outputs:a>")):e.needAlphaTesting()&&(o.push("".concat(r,"float inputs:opacity.connect = </Materials/Material_").concat(e.uniqueId,"/Texture_").concat(s.uniqueId,"_diffuse.outputs:a>")),o.push("".concat(r,"float inputs:opacityThreshold = ").concat(c))),a.push(xe(s,e,"diffuse",u,t,n))):o.push("".concat(r,"color3f inputs:diffuseColor = ").concat(ge(u||g.Color3.White()))),null!==l?(o.push("".concat(r,"color3f inputs:emissiveColor.connect = </Materials/Material_").concat(e.uniqueId,"/Texture_").concat(l.uniqueId,"_emissive.outputs:rgb>")),a.push(xe(l,e,"emissive",f,t,n))):f&&f.toLuminance()>0&&o.push("".concat(r,"color3f inputs:emissiveColor = ").concat(ge(f))),null!==p&&(o.push("".concat(r,"normal3f inputs:normal.connect = </Materials/Material_").concat(e.uniqueId,"/Texture_").concat(p.uniqueId,"_normal.outputs:rgb>")),a.push(xe(p,e,"normal",null,t,n))),null!==v&&(o.push("".concat(r,"float inputs:occlusion.connect = </Materials/Material_").concat(e.uniqueId,"/Texture_").concat(v.uniqueId,"_occlusion.outputs:").concat(T,">")),a.push(xe(v,e,"occlusion",new g.Color3(b,b,b),t,n))),null!==h?(o.push("".concat(r,"float inputs:roughness.connect = </Materials/Material_").concat(e.uniqueId,"/Texture_").concat(h.uniqueId,"_roughness.outputs:").concat(d,">")),a.push(xe(h,e,"roughness",new g.Color3(m,m,m),t,n))):o.push("".concat(r,"float inputs:roughness = ").concat(m)),null!==x?(o.push("".concat(r,"float inputs:metallic.connect = </Materials/Material_").concat(e.uniqueId,"/Texture_").concat(x.uniqueId,"_metallic.outputs:").concat(_,">")),a.push(xe(x,e,"metallic",new g.Color3(y,y,y),t,n))):o.push("".concat(r,"float inputs:metallic = ").concat(y)),null!==A?(o.push("".concat(r,"float inputs:opacity.connect = </Materials/Material_").concat(e.uniqueId,"/Texture_").concat(A.uniqueId,"_opacity.outputs:r>")),o.push("".concat(r,"float inputs:opacityThreshold = 0.0001")),a.push(xe(A,e,"opacity",null,t,n))):o.push("".concat(r,"float inputs:opacity = ").concat(e.alpha)),o.push("".concat(r,"float inputs:ior = ").concat(M)),'\n\tdef Material "Material_'.concat(e.uniqueId,'"\n\t{\n\t\tdef Shader "PreviewSurface"\n\t\t{\n\t\t\tuniform token info:id = "UsdPreviewSurface"\n').concat(o.join("\n"),"\n\t\t\tint inputs:useSpecularWorkflow = 0\n\t\t\ttoken outputs:surface\n\t\t}\n\n\t\ttoken outputs:surface.connect = </Materials/Material_").concat(e.uniqueId,"/PreviewSurface.outputs:surface>\n\n").concat(a.join("\n"),"\n\n\t}\n")}function ye(e,t,n){return T(this,void 0,void 0,(function(){var r,o,a,i,s,u,c,l,f,p,h,d,m,x,_,y,T,A,M,w,E,C,R,V,S,I,F,N;return b(this,(function(b){switch(b.label){case 0:return r=v({fflateUrl:"https://unpkg.com/fflate@0.8.2",includeAnchoringProperties:!0,anchoringType:"plane",planeAnchoringAlignment:"horizontal",modelFileName:"model.usda",precision:5,exportCamera:!1,cameraSensorWidth:35},t),"undefined"!=typeof fflate?[3,2]:[4,g.Tools.LoadScriptAsync(r.fflateUrl)];case 1:b.sent(),b.label=2;case 2:for((o={})[r.modelFileName]=null,a='#usda 1.0\n    (\n        customLayerData = {\n            string creator = "Babylon.js USDZExportAsync"\n        }\n        defaultPrim = "Root"\n        metersPerUnit = 1\n        upAxis = "Y"\n    )',a+=function(e){var t=!0===e.includeAnchoringProperties?'\n\t\ttoken preliminary:anchoring:type = "'.concat(e.anchoringType,'"\n\t\ttoken preliminary:planeAnchoring:alignment = "').concat(e.planeAnchoringAlignment,'"'):"";return'def Xform "Root"\n    {\n        def Scope "Scenes" (\n            kind = "sceneLibrary"\n        )\n        {\n            def Xform "Scene" (\n                customData = {\n                    bool preliminary_collidesWithEnvironment = 0\n                    string sceneName = "Scene"\n                }\n                sceneName = "Scene"\n            )\n            {'.concat(t,"\n            ")}(r),i={},s=0,u=e.meshes;s<u.length;s++)0!==(c=u[s]).getTotalVertices()&&(f=(l=c).geometry,(p=l.material)&&f&&(!n||n(l))&&(-1!==["StandardMaterial","PBRMaterial","PBRMetallicRoughnessMaterial"].indexOf(p.getClassName())?((h="geometries/Geometry_"+f.uniqueId+".usda")in o||(d=ce(f,r),o[h]=le(d)),p.uniqueId in i||(i[p.uniqueId]=p),a+=he(l)):g.Tools.Warn("USDZExportAsync does not support this material type: "+p.getClassName())));for(y in e.activeCamera&&r.exportCamera&&(a+=function(e,t){var n="Camera_"+e.uniqueId,r=fe(g.Matrix.RotationY(Math.PI).multiply(e.getWorldMatrix()));if(e.mode===g.Constants.ORTHOGRAPHIC_CAMERA)return'def Camera "'.concat(n,'"\n\t\t{\n\t\t\tmatrix4d xformOp:transform = ').concat(r,'\n\t\t\tuniform token[] xformOpOrder = ["xformOp:transform"]\n\n\t\t\tfloat2 clippingRange = (').concat(e.minZ.toPrecision(t.precision),", ").concat(e.maxZ.toPrecision(t.precision),")\n\t\t\tfloat horizontalAperture = ").concat((10*(Math.abs(e.orthoLeft||1)+Math.abs(e.orthoRight||1))).toPrecision(t.precision),"\n\t\t\tfloat verticalAperture = ").concat((10*(Math.abs(e.orthoTop||1)+Math.abs(e.orthoBottom||1))).toPrecision(t.precision),'\n\t\t\ttoken projection = "orthographic"\n\t\t}\n\t\n\t');var o=e.getEngine().getAspectRatio(e),a=t.cameraSensorWidth||35;return'def Camera "'.concat(n,'"\n\t\t{\n\t\t\tmatrix4d xformOp:transform = ').concat(r,'\n\t\t\tuniform token[] xformOpOrder = ["xformOp:transform"]\n\n\t\t\tfloat2 clippingRange = (').concat(e.minZ.toPrecision(t.precision),", ").concat(e.maxZ.toPrecision(t.precision),")\n\t\t\tfloat focalLength = ").concat((a/(2*Math.tan(.5*e.fov))).toPrecision(t.precision),'\n            token projection = "perspective"\n\t\t\tfloat horizontalAperture = ').concat((a*o).toPrecision(t.precision),"\n\t\t\tfloat verticalAperture = ").concat((a/o).toPrecision(t.precision),"            \n\t\t}\n\t\n\t")}(e.activeCamera,r)),a+="\n            }\n        }\n    }",a+=function(e,t,n){var r=[];for(var o in e){var a=e[o];r.push(_e(a,t,n))}return'\n    def "Materials"\n{\n'.concat(r.join(""),"\n}\n\n")}(i,m={},r),o[r.modelFileName]=fflate.strToU8(a),_=[],x=m)_.push(y);T=0,b.label=3;case 3:return T<_.length?(y=_[T])in x?(M=m[A=y],w=M.getSize(),[4,M.readPixels()]):[3,6]:[3,7];case 4:if(!(E=b.sent()))throw new Error("Texture data is not available");return[4,g.DumpTools.DumpDataAsync(w.width,w.height,E,"image/png",void 0,!1,!0)];case 5:C=b.sent(),o["textures/Texture_".concat(A,".png")]=new Uint8Array(C).slice(),b.label=6;case 6:return T++,[3,3];case 7:for(V in R=0,o)(S=o[V])&&(I=34+V.length,4!=(F=63&(R+=I))&&(N=new Uint8Array(64-F),o[V]=[S,{extra:{12345:N}}]),R=S.length);return[2,fflate.zipSync(o,{level:0})]}}))}))}var ve="EXT_mesh_gpu_instancing",Te=function(){function e(e){this.name=ve,this.enabled=!0,this.required=!1,this._wasUsed=!1,this._exporter=e}return e.prototype.dispose=function(){},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.postExportNodeAsync=function(e,t,n,r,o,a){var i=this;return new Promise((function(e){if(t&&n instanceof g.Mesh&&n.hasThinInstances&&i._exporter){i._wasUsed=!0;for(var r=g.Vector3.Zero(),s=g.Quaternion.Identity(),u=g.Vector3.One(),c=n.thinInstanceGetWorldMatrices(),l=g.TmpVectors.Vector3[2],f=g.TmpVectors.Quaternion[1],p=g.TmpVectors.Vector3[3],h=!1,d=!1,m=!1,x=new Float32Array(3*n.thinInstanceCount),_=new Float32Array(4*n.thinInstanceCount),y=new Float32Array(3*n.thinInstanceCount),v=0,T=0,b=c;T<b.length;T++)b[T].decompose(p,f,l),o&&(z(l),H(f)),x.set(l.asArray(),3*v),_.set(f.normalize().asArray(),4*v),y.set(p.asArray(),3*v),h=h||!l.equalsWithEpsilon(r),d=d||!f.equalsWithEpsilon(s),m=m||!p.equalsWithEpsilon(u),v++;var A={attributes:{}};h&&(A.attributes.TRANSLATION=i._buildAccessor(x,"VEC3",n.thinInstanceCount,a,5126)),d&&(A.attributes.ROTATION=i._buildAccessor(_,"VEC4",n.thinInstanceCount,a,5126)),m&&(A.attributes.SCALE=i._buildAccessor(y,"VEC3",n.thinInstanceCount,a,5126)),t.extensions=t.extensions||{},t.extensions[ve]=A}e(t)}))},e.prototype._buildAccessor=function(e,t,n,r,o){var a=r.byteOffset;switch(o){case 5126:for(var i=0;i!=e.length;i++)r.writeFloat32(e[i]);break;case 5120:for(i=0;i!=e.length;i++)r.writeInt8(127*e[i]);break;case 5122:for(i=0;i!=e.length;i++)r.writeInt16(32767*e[i])}var s={buffer:0,byteOffset:a,byteLength:e.length*g.VertexBuffer.GetTypeByteLength(o)},u=this._exporter._bufferViews.length;this._exporter._bufferViews.push(s);var c=this._exporter._accessors.length,l={bufferView:u,componentType:o,count:n,type:t,normalized:5120==o||5122==o};return this._exporter._accessors.push(l),c},e}();oe.RegisterExtension(ve,(function(e){return new Te(e)}));var be="KHR_lights_punctual",Ae={name:"",color:[1,1,1],intensity:1,range:Number.MAX_VALUE},Me={innerConeAngle:0,outerConeAngle:Math.PI/4},we=g.Vector3.Backward(),Ee=function(){function e(e){this.name=be,this.enabled=!0,this.required=!1,this._exporter=e}return e.prototype.dispose=function(){this._lights=null},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return!!this._lights},enumerable:!1,configurable:!0}),e.prototype.onExporting=function(){this._exporter._glTF.extensions[be]=this._lights},e.prototype.postExportNodeAsync=function(e,t,n,r,o){var a=this;return new Promise((function(i){if(n instanceof g.ShadowLight){var s=n.getTypeID()==g.Light.LIGHTTYPEID_POINTLIGHT?"point":n.getTypeID()==g.Light.LIGHTTYPEID_DIRECTIONALLIGHT?"directional":n.getTypeID()==g.Light.LIGHTTYPEID_SPOTLIGHT?"spot":null;if(!s)return g.Logger.Warn("".concat(e,": Light ").concat(n.name," is not supported in ").concat(be)),void i(t);if(n.falloffType!==g.Light.FALLOFF_GLTF&&g.Logger.Warn("".concat(e,": Light falloff for ").concat(n.name," does not match the ").concat(be," specification!")),!n.position.equalsToFloats(0,0,0)){var u=g.TmpVectors.Vector3[0].copyFrom(n.position);o&&z(u),t.translation=u.asArray()}if("point"!==s){var c=n.direction.normalizeToRef(g.TmpVectors.Vector3[0]);o&&z(c);var l=Math.acos(g.Vector3.Dot(we,c)),f=g.Vector3.Cross(we,c),p=g.Quaternion.RotationAxisToRef(f,l,g.TmpVectors.Quaternion[0]);g.Quaternion.IsIdentity(p)||(t.rotation=p.asArray())}var h={type:s,name:n.name,color:n.diffuse.asArray(),intensity:n.intensity,range:n.range};if(Z(h,Ae),"spot"===s){var d=n;h.spot={innerConeAngle:d.innerAngle/2,outerConeAngle:d.angle/2},Z(h.spot,Me)}a._lights||(a._lights={lights:[]}),a._lights.lights.push(h);var m={light:a._lights.lights.length-1},x=n.parent;if(x&&Y(n,x)){var _=r.get(x);if(_){var y=a._exporter._nodes[_];return function(e,t){var n=g.Vector3.FromArrayToRef(t.translation||[0,0,0],0,g.TmpVectors.Vector3[0]),r=g.Quaternion.FromArrayToRef(t.rotation||[0,0,0,1],0,g.TmpVectors.Quaternion[0]),o=g.Vector3.FromArrayToRef(t.scale||[1,1,1],0,g.TmpVectors.Vector3[1]),a=g.Matrix.ComposeToRef(o,r,n,g.TmpVectors.Matrix[0]),i=g.Vector3.FromArrayToRef(e.translation||[0,0,0],0,g.TmpVectors.Vector3[2]),s=g.Quaternion.FromArrayToRef(e.rotation||[0,0,0,1],0,g.TmpVectors.Quaternion[1]),u=g.Vector3.FromArrayToRef(e.scale||[1,1,1],0,g.TmpVectors.Vector3[1]),c=g.Matrix.ComposeToRef(u,s,i,g.TmpVectors.Matrix[1]);a.multiplyToRef(c,c),c.decompose(o,r,n),n.equalsWithEpsilon(L,U)?delete t.translation:t.translation=n.asArray(),g.Quaternion.IsIdentity(r)?delete t.rotation:t.rotation=r.asArray(),o.equalsWithEpsilon(k,U)?delete t.scale:t.scale=o.asArray()}(t,y),y.extensions||(y.extensions={}),y.extensions[be]=m,void i(null)}}t.extensions||(t.extensions={}),t.extensions[be]=m,i(t)}else i(t)}))},e}();oe.RegisterExtension(be,(function(e){return new Ee(e)}));var Ce="KHR_materials_anisotropy",Re=function(){function e(e){this.name=Ce,this.enabled=!0,this.required=!1,this._wasUsed=!1,this._exporter=e}return e.prototype.dispose=function(){},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.postExportMaterialAdditionalTextures=function(e,t,n){var r=[];return n instanceof g.PBRBaseMaterial&&n.anisotropy.isEnabled&&!n.anisotropy.legacy?(n.anisotropy.texture&&r.push(n.anisotropy.texture),r):[]},e.prototype.postExportMaterialAsync=function(e,t,n){var r=this;return new Promise((function(e){if(n instanceof g.PBRBaseMaterial){if(!n.anisotropy.isEnabled||n.anisotropy.legacy)return void e(t);r._wasUsed=!0,t.extensions=t.extensions||{};var o=r._exporter._materialExporter.getTextureInfo(n.anisotropy.texture),a={anisotropyStrength:n.anisotropy.intensity,anisotropyRotation:n.anisotropy.angle,anisotropyTexture:null!=o?o:void 0};null!==a.anisotropyTexture&&r._exporter._materialNeedsUVsSet.add(n),t.extensions[Ce]=a}e(t)}))},e}();oe.RegisterExtension(Ce,(function(e){return new Re(e)}));var Ve="KHR_materials_clearcoat",Se=function(){function e(e){this.name=Ve,this.enabled=!0,this.required=!1,this._wasUsed=!1,this._exporter=e}return e.prototype.dispose=function(){},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.postExportMaterialAdditionalTextures=function(e,t,n){var r=[];return n instanceof g.PBRBaseMaterial&&n.clearCoat.isEnabled?(n.clearCoat.texture&&r.push(n.clearCoat.texture),!n.clearCoat.useRoughnessFromMainTexture&&n.clearCoat.textureRoughness&&r.push(n.clearCoat.textureRoughness),n.clearCoat.bumpTexture&&r.push(n.clearCoat.bumpTexture),r):[]},e.prototype.postExportMaterialAsync=function(e,t,n){var r=this;return new Promise((function(e){if(n instanceof g.PBRBaseMaterial){if(!n.clearCoat.isEnabled)return void e(t);r._wasUsed=!0,t.extensions=t.extensions||{};var o,a=r._exporter._materialExporter.getTextureInfo(n.clearCoat.texture);o=n.clearCoat.useRoughnessFromMainTexture?r._exporter._materialExporter.getTextureInfo(n.clearCoat.texture):r._exporter._materialExporter.getTextureInfo(n.clearCoat.textureRoughness),n.clearCoat.isTintEnabled&&g.Tools.Warn("Clear Color tint is not supported for glTF export. Ignoring for: ".concat(n.name)),n.clearCoat.remapF0OnInterfaceChange&&g.Tools.Warn("Clear Color F0 remapping is not supported for glTF export. Ignoring for: ".concat(n.name));var i=r._exporter._materialExporter.getTextureInfo(n.clearCoat.bumpTexture),s={clearcoatFactor:n.clearCoat.intensity,clearcoatTexture:null!=a?a:void 0,clearcoatRoughnessFactor:n.clearCoat.roughness,clearcoatRoughnessTexture:null!=o?o:void 0,clearcoatNormalTexture:null!=i?i:void 0};null===s.clearcoatTexture&&null===s.clearcoatRoughnessTexture&&null===s.clearcoatRoughnessTexture||r._exporter._materialNeedsUVsSet.add(n),t.extensions[Ve]=s}e(t)}))},e}();oe.RegisterExtension(Ve,(function(e){return new Se(e)}));var Ie="KHR_materials_diffuse_transmission",Fe=function(){function e(e){this.name=Ie,this.enabled=!0,this.required=!1,this._wasUsed=!1,this._exporter=e}return e.prototype.dispose=function(){},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.postExportMaterialAdditionalTextures=function(e,t,n){var r=[];return n instanceof g.PBRMaterial&&this._isExtensionEnabled(n)?(n.subSurface.thicknessTexture&&r.push(n.subSurface.thicknessTexture),r):r},e.prototype._isExtensionEnabled=function(e){if(e.unlit)return!1;var t=e.subSurface;return!!t.isTranslucencyEnabled&&!e.unlit&&!t.useAlbedoToTintTranslucency&&t.useGltfStyleTextures&&1===t.volumeIndexOfRefraction&&0===t.minimumThickness&&0===t.maximumThickness},e.prototype._hasTexturesExtension=function(e){return null!=e.subSurface.translucencyIntensityTexture||null!=e.subSurface.translucencyColorTexture},e.prototype.postExportMaterialAsync=function(e,t,n){var r=this;return new Promise((function(e){var o,a;if(n instanceof g.PBRMaterial&&r._isExtensionEnabled(n)){r._wasUsed=!0;var i=n.subSurface,s={diffuseTransmissionFactor:1==i.translucencyIntensity?void 0:i.translucencyIntensity,diffuseTransmissionTexture:null!==(o=r._exporter._materialExporter.getTextureInfo(i.translucencyIntensityTexture))&&void 0!==o?o:void 0,diffuseTransmissionColorFactor:!i.translucencyColor||i.translucencyColor.equalsFloats(1,1,1)?void 0:i.translucencyColor.asArray(),diffuseTransmissionColorTexture:null!==(a=r._exporter._materialExporter.getTextureInfo(i.translucencyColorTexture))&&void 0!==a?a:void 0};r._hasTexturesExtension(n)&&r._exporter._materialNeedsUVsSet.add(n),t.extensions=t.extensions||{},t.extensions[Ie]=s}e(t)}))},e}();oe.RegisterExtension(Ie,(function(e){return new Fe(e)}));var Ne="KHR_materials_dispersion",Pe=function(){function e(){this.name=Ne,this.enabled=!0,this.required=!1,this._wasUsed=!1}return e.prototype.dispose=function(){},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype._isExtensionEnabled=function(e){if(e.unlit)return!1;var t=e.subSurface;return!(!t.isRefractionEnabled&&!t.isDispersionEnabled)},e.prototype.postExportMaterialAsync=function(e,t,n){var r=this;return new Promise((function(e){if(n instanceof g.PBRMaterial&&r._isExtensionEnabled(n)){r._wasUsed=!0;var o={dispersion:n.subSurface.dispersion};t.extensions=t.extensions||{},t.extensions[Ne]=o}e(t)}))},e}();oe.RegisterExtension(Ne,(function(){return new Pe}));var Be="KHR_materials_emissive_strength",Oe=function(){function e(){this.name=Be,this.enabled=!0,this.required=!1,this._wasUsed=!1}return e.prototype.dispose=function(){},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.postExportMaterialAsync=function(e,t,n){var r=this;return new Promise((function(e){if(!(n instanceof g.PBRMaterial))return e(t);var o=n.emissiveColor.asArray(),a=Math.max.apply(Math,o);if(a>1){r._wasUsed=!0,t.extensions||(t.extensions={});var i={emissiveStrength:a},s=n.emissiveColor.scale(1/i.emissiveStrength);t.emissiveFactor=s.asArray(),t.extensions[Be]=i}return e(t)}))},e}();oe.RegisterExtension(Be,(function(e){return new Oe}));var Ue="KHR_materials_ior",Le=function(){function e(){this.name=Ue,this.enabled=!0,this.required=!1,this._wasUsed=!1}return e.prototype.dispose=function(){},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype._isExtensionEnabled=function(e){return!e.unlit&&null!=e.indexOfRefraction&&1.5!=e.indexOfRefraction},e.prototype.postExportMaterialAsync=function(e,t,n){var r=this;return new Promise((function(e){if(n instanceof g.PBRMaterial&&r._isExtensionEnabled(n)){r._wasUsed=!0;var o={ior:n.indexOfRefraction};t.extensions=t.extensions||{},t.extensions[Ue]=o}e(t)}))},e}();oe.RegisterExtension(Ue,(function(e){return new Le}));var ke="KHR_materials_iridescence",De=function(){function e(e){this.name=ke,this.enabled=!0,this.required=!1,this._wasUsed=!1,this._exporter=e}return e.prototype.dispose=function(){},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.postExportMaterialAdditionalTextures=function(e,t,n){var r=[];return n instanceof g.PBRBaseMaterial&&n.iridescence.isEnabled?(n.iridescence.texture&&r.push(n.iridescence.texture),n.iridescence.thicknessTexture&&n.iridescence.thicknessTexture!==n.iridescence.texture&&r.push(n.iridescence.thicknessTexture),r):[]},e.prototype.postExportMaterialAsync=function(e,t,n){var r=this;return new Promise((function(e){if(n instanceof g.PBRBaseMaterial){if(!n.iridescence.isEnabled)return void e(t);r._wasUsed=!0,t.extensions=t.extensions||{};var o=r._exporter._materialExporter.getTextureInfo(n.iridescence.texture),a=r._exporter._materialExporter.getTextureInfo(n.iridescence.thicknessTexture),i={iridescenceFactor:n.iridescence.intensity,iridescenceIor:n.iridescence.indexOfRefraction,iridescenceThicknessMinimum:n.iridescence.minimumThickness,iridescenceThicknessMaximum:n.iridescence.maximumThickness,iridescenceTexture:null!=o?o:void 0,iridescenceThicknessTexture:null!=a?a:void 0};null===i.iridescenceTexture&&null===i.iridescenceThicknessTexture||r._exporter._materialNeedsUVsSet.add(n),t.extensions[ke]=i}e(t)}))},e}();oe.RegisterExtension(ke,(function(e){return new De(e)}));var Ke="KHR_materials_sheen",We=function(){function e(e){this.name=Ke,this.enabled=!0,this.required=!1,this._wasUsed=!1,this._exporter=e}return e.prototype.dispose=function(){},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.postExportMaterialAdditionalTextures=function(e,t,n){return n instanceof g.PBRMaterial&&n.sheen.isEnabled&&n.sheen.texture?[n.sheen.texture]:[]},e.prototype.postExportMaterialAsync=function(e,t,n){var r=this;return new Promise((function(e){var o,a,i,s;if(n instanceof g.PBRMaterial){if(!n.sheen.isEnabled)return void e(t);r._wasUsed=!0,null==t.extensions&&(t.extensions={});var u={sheenColorFactor:n.sheen.color.asArray(),sheenRoughnessFactor:null!==(o=n.sheen.roughness)&&void 0!==o?o:0};null===u.sheenColorTexture&&null===u.sheenRoughnessTexture||r._exporter._materialNeedsUVsSet.add(n),n.sheen.texture&&(u.sheenColorTexture=null!==(a=r._exporter._materialExporter.getTextureInfo(n.sheen.texture))&&void 0!==a?a:void 0),n.sheen.textureRoughness&&!n.sheen.useRoughnessFromMainTexture?u.sheenRoughnessTexture=null!==(i=r._exporter._materialExporter.getTextureInfo(n.sheen.textureRoughness))&&void 0!==i?i:void 0:n.sheen.texture&&n.sheen.useRoughnessFromMainTexture&&(u.sheenRoughnessTexture=null!==(s=r._exporter._materialExporter.getTextureInfo(n.sheen.texture))&&void 0!==s?s:void 0),t.extensions[Ke]=u}e(t)}))},e}();oe.RegisterExtension(Ke,(function(e){return new We(e)}));var Ge="KHR_materials_specular",qe=function(){function e(e){this.name=Ge,this.enabled=!0,this.required=!1,this._wasUsed=!1,this._exporter=e}return e.prototype.dispose=function(){},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.postExportMaterialAdditionalTextures=function(e,t,n){var r=[];return n instanceof g.PBRMaterial&&this._isExtensionEnabled(n)?(n.metallicReflectanceTexture&&r.push(n.metallicReflectanceTexture),n.reflectanceTexture&&r.push(n.reflectanceTexture),r):r},e.prototype._isExtensionEnabled=function(e){return!e.unlit&&(null!=e.metallicF0Factor&&1!=e.metallicF0Factor||null!=e.metallicReflectanceColor&&!e.metallicReflectanceColor.equalsFloats(1,1,1)||this._hasTexturesExtension(e))},e.prototype._hasTexturesExtension=function(e){return null!=e.metallicReflectanceTexture||null!=e.reflectanceTexture},e.prototype.postExportMaterialAsync=function(e,t,n){var r=this;return new Promise((function(e){var o,a;if(n instanceof g.PBRMaterial&&r._isExtensionEnabled(n)){r._wasUsed=!0,t.extensions=t.extensions||{};var i=null!==(o=r._exporter._materialExporter.getTextureInfo(n.metallicReflectanceTexture))&&void 0!==o?o:void 0,s=null!==(a=r._exporter._materialExporter.getTextureInfo(n.reflectanceTexture))&&void 0!==a?a:void 0,u={specularFactor:1==n.metallicF0Factor?void 0:n.metallicF0Factor,specularTexture:i,specularColorFactor:n.metallicReflectanceColor.equalsFloats(1,1,1)?void 0:n.metallicReflectanceColor.asArray(),specularColorTexture:s};r._hasTexturesExtension(n)&&r._exporter._materialNeedsUVsSet.add(n),t.extensions[Ge]=u}e(t)}))},e}();oe.RegisterExtension(Ge,(function(e){return new qe(e)}));var je="KHR_materials_transmission",ze=function(){function e(e){this.name=je,this.enabled=!0,this.required=!1,this._wasUsed=!1,this._exporter=e}return e.prototype.dispose=function(){},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.postExportMaterialAdditionalTextures=function(e,t,n){var r=[];return n instanceof g.PBRMaterial&&this._isExtensionEnabled(n)?(n.subSurface.thicknessTexture&&r.push(n.subSurface.thicknessTexture),r):r},e.prototype._isExtensionEnabled=function(e){if(e.unlit)return!1;var t=e.subSurface;return t.isRefractionEnabled&&null!=t.refractionIntensity&&0!=t.refractionIntensity||this._hasTexturesExtension(e)},e.prototype._hasTexturesExtension=function(e){return null!=e.subSurface.refractionIntensityTexture},e.prototype.postExportMaterialAsync=function(e,t,n){return T(this,void 0,void 0,(function(){var r,o,a,i;return b(this,(function(s){switch(s.label){case 0:return n instanceof g.PBRMaterial&&this._isExtensionEnabled(n)?(this._wasUsed=!0,r=n.subSurface,o=0===r.refractionIntensity?void 0:r.refractionIntensity,a={transmissionFactor:o},this._hasTexturesExtension(n)&&this._exporter._materialNeedsUVsSet.add(n),r.refractionIntensityTexture?r.useGltfStyleTextures?[4,this._exporter._materialExporter.exportTextureAsync(r.refractionIntensityTexture,"image/png")]:[3,2]:[3,3]):[3,4];case 1:return(i=s.sent())&&(a.transmissionTexture=i),[3,3];case 2:g.Logger.Warn("".concat(e,": Exporting a subsurface refraction intensity texture without `useGltfStyleTextures` is not supported")),s.label=3;case 3:t.extensions||(t.extensions={}),t.extensions[je]=a,s.label=4;case 4:return[2,t]}}))}))},e}();oe.RegisterExtension(je,(function(e){return new ze(e)}));var He="KHR_materials_unlit",Qe=function(){function e(){this.name=He,this.enabled=!0,this.required=!1,this._wasUsed=!1}return Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.dispose=function(){},e.prototype.postExportMaterialAsync=function(e,t,n){var r=this;return new Promise((function(e){var o=!1;n instanceof g.PBRMaterial?o=n.unlit:n instanceof g.StandardMaterial&&(o=n.disableLighting),o&&(r._wasUsed=!0,null==t.extensions&&(t.extensions={}),t.extensions[He]={}),e(t)}))},e}();oe.RegisterExtension(He,(function(){return new Qe}));var Ye="KHR_materials_volume",Xe=function(){function e(e){this.name=Ye,this.enabled=!0,this.required=!1,this._wasUsed=!1,this._exporter=e}return e.prototype.dispose=function(){},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.postExportMaterialAdditionalTextures=function(e,t,n){var r=[];return n instanceof g.PBRMaterial&&this._isExtensionEnabled(n)?(n.subSurface.thicknessTexture&&r.push(n.subSurface.thicknessTexture),r):r},e.prototype._isExtensionEnabled=function(e){if(e.unlit)return!1;var t=e.subSurface;return!(!t.isRefractionEnabled&&!t.isTranslucencyEnabled)&&(null!=t.maximumThickness&&0!=t.maximumThickness||null!=t.tintColorAtDistance&&t.tintColorAtDistance!=Number.POSITIVE_INFINITY||null!=t.tintColor&&t.tintColor!=g.Color3.White()||this._hasTexturesExtension(e))},e.prototype._hasTexturesExtension=function(e){return null!=e.subSurface.thicknessTexture},e.prototype.postExportMaterialAsync=function(e,t,n){var r=this;return new Promise((function(e){var o;if(n instanceof g.PBRMaterial&&r._isExtensionEnabled(n)){r._wasUsed=!0;var a=n.subSurface,i={thicknessFactor:0==a.maximumThickness?void 0:a.maximumThickness,thicknessTexture:null!==(o=r._exporter._materialExporter.getTextureInfo(a.thicknessTexture))&&void 0!==o?o:void 0,attenuationDistance:a.tintColorAtDistance==Number.POSITIVE_INFINITY?void 0:a.tintColorAtDistance,attenuationColor:a.tintColor.equalsFloats(1,1,1)?void 0:a.tintColor.asArray()};r._hasTexturesExtension(n)&&r._exporter._materialNeedsUVsSet.add(n),t.extensions=t.extensions||{},t.extensions[Ye]=i}e(t)}))},e}();oe.RegisterExtension(Ye,(function(e){return new Xe(e)}));var Ze="KHR_texture_transform",Je=function(){function e(){this.name=Ze,this.enabled=!0,this.required=!1,this._wasUsed=!1}return e.prototype.dispose=function(){},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.postExportTexture=function(e,t,n){if(n&&0===n.uAng&&0===n.vAng){var r={},o=!1;if(0===n.uOffset&&0===n.vOffset||(r.offset=[n.uOffset,n.vOffset],o=!0),1===n.uScale&&1===n.vScale||(r.scale=[n.uScale,n.vScale],o=!0),0!==n.wAng&&(r.rotation=-n.wAng,o=!0,0===n.uRotationCenter&&0===n.vRotationCenter||(r.offset=function(e){var t=e.uOffset,n=e.vOffset,r=e.uRotationCenter,o=e.vRotationCenter,a=e.wAng,i=Math.cos(-a),s=Math.sin(-a);return[t+(r*(1-i)-o*s),n+(o*(1-i)+r*s)]}(n))),0!==n.coordinatesIndex&&(r.texCoord=n.coordinatesIndex,o=!0),!o)return;this._wasUsed=!0,t.extensions||(t.extensions={}),t.extensions[Ze]=r}},e.prototype.preExportTextureAsync=function(e,t){return new Promise((function(n,r){t.getScene()?(0===t.uAng&&0===t.vAng||(g.Tools.Warn("".concat(e,": Texture ").concat(t.name," with rotation in the u or v axis is not supported in glTF.")),n(null)),0===t.wAng||0===t.uRotationCenter&&0===t.vRotationCenter||g.Tools.Warn("".concat(e,": Texture ").concat(t.name," with rotation not centered at the origin will be exported with an adjusted texture offset.")),n(t)):r("".concat(e,': "scene" is not defined for Babylon texture ').concat(t.name,"!"))}))},e}();oe.RegisterExtension(Ze,(function(){return new Je}));var $e=void 0!==a.g?a.g:"undefined"!=typeof window?window:void 0;if(void 0!==$e){$e.BABYLON=$e.BABYLON||{};var et=$e.BABYLON;et.GLTF2=et.GLTF2||{},et.GLTF2.Exporter=et.GLTF2.Exporter||{},et.GLTF2.Exporter.Extensions=et.GLTF2.Exporter.Extensions||{};var tt=[];for(var nt in u)et[nt]=u[nt],tt.push(nt);for(var nt in c)et[nt]=c[nt],tt.push(nt);for(var nt in l)et[nt]=l[nt],tt.push(nt);for(var nt in d)et.GLTF2.Exporter.Extensions[nt]=d[nt],tt.push(nt);for(var nt in f)tt.indexOf(nt)>-1||(et.GLTF2.Exporter[nt]=f[nt])}var rt=void 0!==a.g?a.g:"undefined"!=typeof window?window:void 0;if(void 0!==rt)for(var ot in s)rt.BABYLON[ot]=s[ot];var at=void 0!==a.g?a.g:"undefined"!=typeof window?window:void 0;if(void 0!==at)for(var it in p)at.BABYLON[it]=p[it];var st=void 0!==a.g?a.g:"undefined"!=typeof window?window:void 0;if(void 0!==st)for(var ut in h)st.BABYLON[ut]=h[ut];const ct=m;return i.default})()));
//# sourceMappingURL=babylonjs.serializers.min.js.map