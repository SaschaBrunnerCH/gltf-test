!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("babylonjs")):"function"==typeof define&&define.amd?define("babylonjs-serializers",["babylonjs"],t):"object"==typeof exports?exports["babylonjs-serializers"]=t(require("babylonjs")):e.SERIALIZERS=t(e.BABYLON)}("undefined"!=typeof self?self:"undefined"!=typeof global?global:this,(e=>(()=>{"use strict";var t,r,n={597:t=>{t.exports=e}},i={};function o(e){var t=i[e];if(void 0!==t)return t.exports;var r=i[e]={exports:{}};return n[e](r,r.exports,o),r.exports}r=Object.getPrototypeOf?e=>Object.getPrototypeOf(e):e=>e.__proto__,o.t=function(e,n){if(1&n&&(e=this(e)),8&n)return e;if("object"==typeof e&&e){if(4&n&&e.__esModule)return e;if(16&n&&"function"==typeof e.then)return e}var i=Object.create(null);o.r(i);var s={};t=t||[null,r({}),r([]),r(r)];for(var a=2&n&&e;"object"==typeof a&&!~t.indexOf(a);a=r(a))Object.getOwnPropertyNames(a).forEach((t=>s[t]=()=>e[t]));return s.default=()=>e,o.d(i,s),i},o.d=(e,t)=>{for(var r in t)o.o(t,r)&&!o.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},o.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),o.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var s={};o.d(s,{default:()=>ke});var a={};o.r(a),o.d(a,{__IGLTFExporterExtension:()=>p});var u={};o.r(u),o.d(u,{GLTFData:()=>g});var l={};o.r(l),o.d(l,{GLTF2Export:()=>te});var c={};o.r(c),o.d(c,{EXT_mesh_gpu_instancing:()=>ne,KHR_lights_punctual:()=>ue,KHR_materials_anisotropy:()=>ce,KHR_materials_clearcoat:()=>he,KHR_materials_diffuse_transmission:()=>de,KHR_materials_dispersion:()=>xe,KHR_materials_emissive_strength:()=>_e,KHR_materials_ior:()=>Te,KHR_materials_iridescence:()=>be,KHR_materials_sheen:()=>we,KHR_materials_specular:()=>Me,KHR_materials_transmission:()=>Ce,KHR_materials_unlit:()=>Fe,KHR_materials_volume:()=>Ie,KHR_texture_transform:()=>Be});var f={};o.r(f),o.d(f,{GLTF2Export:()=>te,GLTFData:()=>g,_ConvertToGLTFPBRMetallicRoughness:()=>M,_SolveMetallic:()=>E});var h={};o.r(h),o.d(h,{GLTF2Export:()=>te,GLTFData:()=>g,_ConvertToGLTFPBRMetallicRoughness:()=>M,_SolveMetallic:()=>E,__IGLTFExporterExtension:()=>p});var p=0,d=o(597),g=function(){function e(){this.files={}}return Object.defineProperty(e.prototype,"glTFFiles",{get:function(){return this.files},enumerable:!1,configurable:!0}),e.prototype.downloadFiles=function(){for(var e in this.files){var t=this.files[e],r=new Blob([t],{type:(n=e,n.endsWith(".glb")?"model/gltf-binary":n.endsWith(".bin")?"application/octet-stream":n.endsWith(".gltf")?"model/gltf+json":n.endsWith(".jpeg")||n.endsWith(".jpg")?"image/jpeg":n.endsWith(".png")?"image/png":n.endsWith(".webp")?"image/webp":void 0)});d.Tools.Download(r,e)}var n},e}(),x=function(){return x=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},x.apply(this,arguments)};function m(e,t,r,n){return new(r||(r=Promise))((function(i,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))}function _(e,t){var r,n,i,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},s=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return s.next=a(0),s.throw=a(1),s.return=a(2),"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(a){return function(u){return function(a){if(r)throw new TypeError("Generator is already executing.");for(;s&&(s=0,a[0]&&(o=0)),o;)try{if(r=1,n&&(i=2&a[0]?n.return:a[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,a[1])).done)return i;switch(n=0,i&&(a=[2&a[0],i.value]),a[0]){case 0:case 1:i=a;break;case 4:return o.label++,{value:a[1],done:!1};case 5:o.label++,n=a[1],a=[0];continue;case 7:a=o.ops.pop(),o.trys.pop();continue;default:if(!((i=(i=o.trys).length>0&&i[i.length-1])||6!==a[0]&&2!==a[0])){o=0;continue}if(3===a[0]&&(!i||a[1]>i[0]&&a[1]<i[3])){o.label=a[1];break}if(6===a[0]&&o.label<i[1]){o.label=i[1],i=a;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(a);break}i[2]&&o.ops.pop(),o.trys.pop();continue}a=t.call(e,o)}catch(e){a=[6,e],n=0}finally{r=i=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,u])}}}function y(e,t,r){if(r||2===arguments.length)for(var n,i=0,o=t.length;i<o;i++)!n&&i in t||(n||(n=Array.prototype.slice.call(t,0,i)),n[i]=t[i]);return e.concat(n||Array.prototype.slice.call(t))}Object.create,Object.create,"function"==typeof SuppressedError&&SuppressedError;var T=1e-6,v=new d.Color3(.04,.04,.04),b=1024,A=d.Color3.White(),w=d.Color3.Black();function E(e,t,r){if(t<v.r)return 0;var n=v.r,i=e*r/(1-v.r)+t-2*v.r,o=i*i-4*n*(v.r-t);return d.Scalar.Clamp((-i+Math.sqrt(o))/(2*n),0,1)}function M(e){var t,r,n,i,o,s,a=new d.Vector2(0,1),u=new d.Vector2(0,.1),l=new d.Vector2(0,.1),c=new d.Vector2(1300,.1),f=e.diffuseColor.toLinearSpace(e.getScene().getEngine().useExactSrgbConversions).scale(.5),h=e.alpha,p=(t=d.Scalar.Clamp(e.specularPower,0,b),r=Math.pow(t/c.x,.333333),n=a.y,i=u.y,o=l.y,s=c.y,(1-r)*(1-r)*(1-r)*n+3*(1-r)*(1-r)*r*i+3*(1-r)*r*r*o+r*r*r*s);return{baseColorFactor:[f.r,f.g,f.b,h],metallicFactor:0,roughnessFactor:p}}function R(e,t){t.needAlphaBlending()?e.alphaMode="BLEND":t.needAlphaTesting()&&(e.alphaMode="MASK",e.alphaCutoff=t.alphaCutOff)}function C(e,t,r){for(var n=new Uint8Array(e*t*4),i=0;i<n.length;i+=4)n[i]=n[i+1]=n[i+2]=n[i+3]=255;return d.RawTexture.CreateRGBATexture(n,e,t,r)}function V(e){if(e instanceof Uint8Array){for(var t=e.length,r=new Float32Array(e.length),n=0;n<t;++n)r[n]=e[n]/255;return r}if(e instanceof Float32Array)return e;throw new Error("Unsupported pixel format!")}var F=function(){function e(e){this._exporter=e,this._textureMap=new Map,this._internalTextureToImage={}}return e.prototype.getTextureInfo=function(e){var t;return e&&null!==(t=this._textureMap.get(e))&&void 0!==t?t:null},e.prototype.exportStandardMaterialAsync=function(e,t,r){return m(this,void 0,void 0,(function(){var n,i,o,s,a,u,l,c;return _(this,(function(f){switch(f.label){case 0:return n=M(e),i={name:e.name},null==e.backFaceCulling||e.backFaceCulling||(e.twoSidedLighting||d.Tools.Warn(e.name+": Back-face culling disabled and two-sided lighting disabled is not supported in glTF."),i.doubleSided=!0),r?(o=[],(s=e.diffuseTexture)&&o.push(this.exportTextureAsync(s,t).then((function(e){e&&(n.baseColorTexture=e)}))),(a=e.bumpTexture)&&o.push(this.exportTextureAsync(a,t).then((function(e){e&&(i.normalTexture=e,1!==a.level&&(i.normalTexture.scale=a.level))}))),(u=e.emissiveTexture)&&(i.emissiveFactor=[1,1,1],o.push(this.exportTextureAsync(u,t).then((function(e){e&&(i.emissiveTexture=e)})))),(l=e.ambientTexture)&&o.push(this.exportTextureAsync(l,t).then((function(e){if(e){var t={index:e.index};i.occlusionTexture=t}}))),o.length>0?(this._exporter._materialNeedsUVsSet.add(e),[4,Promise.all(o)]):[3,2]):[3,2];case 1:f.sent(),f.label=2;case 2:return(e.alpha<1||e.opacityTexture)&&(e.alphaMode===d.Constants.ALPHA_COMBINE?i.alphaMode="BLEND":d.Tools.Warn(e.name+": glTF 2.0 does not support alpha mode: "+e.alphaMode.toString())),e.emissiveColor&&!e.emissiveColor.equalsWithEpsilon(w,T)&&(i.emissiveFactor=e.emissiveColor.asArray()),i.pbrMetallicRoughness=n,R(i,e),[4,this._finishMaterialAsync(i,e,t)];case 3:return f.sent(),(c=this._exporter._materials).push(i),[2,c.length-1]}}))}))},e.prototype._finishMaterialAsync=function(e,t,r){return m(this,void 0,void 0,(function(){var n,i,o,s,a;return _(this,(function(u){switch(u.label){case 0:for(n=this._exporter._extensionsPostExportMaterialAdditionalTextures("exportMaterial",e,t),i=[],o=0,s=n;o<s.length;o++)a=s[o],i.push(this.exportTextureAsync(a,r));return[4,Promise.all(i)];case 1:return u.sent(),[4,this._exporter._extensionsPostExportMaterialAsync("exportMaterial",e,t)];case 2:return u.sent(),[2]}}))}))},e.prototype._getImageDataAsync=function(e,t,r,n){return m(this,void 0,void 0,(function(){var i,s,a,u,l;return _(this,(function(c){switch(c.label){case 0:return i=d.Constants.TEXTURETYPE_UNSIGNED_BYTE,s=this._exporter._babylonScene,a=s.getEngine(),u=a.createRawTexture(e,t,r,d.Constants.TEXTUREFORMAT_RGBA,!1,!0,d.Texture.NEAREST_SAMPLINGMODE,null,i),a.isWebGPU?[4,Promise.resolve().then(o.t.bind(o,597,23))]:[3,2];case 1:return c.sent(),[3,4];case 2:return[4,Promise.resolve().then(o.t.bind(o,597,23))];case 3:c.sent(),c.label=4;case 4:return[4,d.TextureTools.ApplyPostProcess("pass",u,s,i,d.Constants.TEXTURE_NEAREST_SAMPLINGMODE,d.Constants.TEXTUREFORMAT_RGBA)];case 5:return c.sent(),[4,a._readTexturePixels(u,t,r)];case 6:return l=c.sent(),[4,d.DumpTools.DumpDataAsync(t,r,l,n,void 0,!0,!0)];case 7:return[2,c.sent()]}}))}))},e.prototype._resizeTexturesToSameDimensions=function(e,t,r){var n,i,o=e?e.getSize():{width:0,height:0},s=t?t.getSize():{width:0,height:0};return o.width<s.width?(n=e&&e instanceof d.Texture?d.TextureTools.CreateResizedCopy(e,s.width,s.height,!0):C(s.width,s.height,r),i=t):o.width>s.width?(i=t&&t instanceof d.Texture?d.TextureTools.CreateResizedCopy(t,o.width,o.height,!0):C(o.width,o.height,r),n=e):(n=e,i=t),{texture1:n,texture2:i}},e.prototype._convertSpecularGlossinessTexturesToMetallicRoughnessAsync=function(e,t,r,n){return m(this,void 0,void 0,(function(){var i,o,s,a,u,l,c,f,h,p,g,x,m,y,v,b,E,M,R,C,F,S,I,N,B,P,O,U,L,k,D;return _(this,(function(_){switch(_.label){case 0:return i=new Array,e||t?(o=e?e.getScene():t?t.getScene():null)?(s=this._resizeTexturesToSameDimensions(e,t,o),a=null===(D=s.texture1)||void 0===D?void 0:D.getSize(),u=void 0,l=void 0,c=a.width,f=a.height,[4,s.texture1.readPixels()]):[3,3]:[2,Promise.reject("diffuse and specular glossiness textures are not defined!")];case 1:return h=_.sent(),[4,s.texture2.readPixels()];case 2:if(p=_.sent(),!h)return[2,Promise.reject("Failed to retrieve pixels from diffuse texture!")];if(u=V(h),!p)return[2,Promise.reject("Failed to retrieve pixels from specular glossiness texture!")];for(l=V(p),g=l.byteLength,x=new Uint8Array(g),m=new Uint8Array(g),y=w,v=0,b=0,P=0;P<f;++P)for(O=0;O<c;++O)E=4*(c*P+O),M=new d.Color3(u[E],u[E+1],u[E+2]).toLinearSpace(o.getEngine().useExactSrgbConversions).multiply(r.diffuseColor),R=new d.Color3(l[E],l[E+1],l[E+2]).toLinearSpace(o.getEngine().useExactSrgbConversions).multiply(r.specularColor),C=l[E+3]*r.glossiness,F={diffuseColor:M,specularColor:R,glossiness:C},S=this._convertSpecularGlossinessToMetallicRoughness(F),y.r=Math.max(y.r,S.baseColor.r),y.g=Math.max(y.g,S.baseColor.g),y.b=Math.max(y.b,S.baseColor.b),v=Math.max(v,S.metallic),b=Math.max(b,S.roughness),m[E]=255*S.baseColor.r,m[E+1]=255*S.baseColor.g,m[E+2]=255*S.baseColor.b,m[E+3]=s.texture1.hasAlpha?255*u[E+3]:255,x[E]=0,x[E+1]=255*S.roughness,x[E+2]=255*S.metallic,x[E+3]=255;for(I={baseColor:y,metallic:v,roughness:b},N=!1,B=!1,P=0;P<f;++P)for(O=0;O<c;++O)m[U=4*(c*P+O)]/=I.baseColor.r>T?I.baseColor.r:1,m[U+1]/=I.baseColor.g>T?I.baseColor.g:1,m[U+2]/=I.baseColor.b>T?I.baseColor.b:1,L=d.Color3.FromInts(m[U],m[U+1],m[U+2]),k=L.toGammaSpace(o.getEngine().useExactSrgbConversions),m[U]=255*k.r,m[U+1]=255*k.g,m[U+2]=255*k.b,k.equalsWithEpsilon(A,T)||(B=!0),x[U+1]/=I.roughness>T?I.roughness:1,x[U+2]/=I.metallic>T?I.metallic:1,d.Color3.FromInts(255,x[U+1],x[U+2]).equalsWithEpsilon(A,T)||(N=!0);return N&&i.push(this._getImageDataAsync(x,c,f,n).then((function(e){I.metallicRoughnessTextureData=e}))),B&&i.push(this._getImageDataAsync(m,c,f,n).then((function(e){I.baseColorTextureData=e}))),[2,Promise.all(i).then((function(){return I}))];case 3:return[2,Promise.reject("_ConvertSpecularGlossinessTexturesToMetallicRoughness: Scene from textures is missing!")]}}))}))},e.prototype._convertSpecularGlossinessToMetallicRoughness=function(e){var t=this._getPerceivedBrightness(e.diffuseColor),r=this._getPerceivedBrightness(e.specularColor),n=1-this._getMaxComponent(e.specularColor),i=E(t,r,n),o=e.diffuseColor.scale(n/(1-v.r)/Math.max(1-i)),s=e.specularColor.subtract(v.scale(1-i)).scale(1/Math.max(i)),a=d.Color3.Lerp(o,s,i*i);return{baseColor:a=a.clampToRef(0,1,a),metallic:i,roughness:1-e.glossiness}},e.prototype._getPerceivedBrightness=function(e){return e?Math.sqrt(.299*e.r*e.r+.587*e.g*e.g+.114*e.b*e.b):0},e.prototype._getMaxComponent=function(e){return e?Math.max(e.r,Math.max(e.g,e.b)):0},e.prototype._convertMetalRoughFactorsToMetallicRoughnessAsync=function(e,t,r,n){return m(this,void 0,void 0,(function(){var i,o,s;return _(this,(function(a){switch(a.label){case 0:return i=[],o={baseColor:e._albedoColor,metallic:e._metallic,roughness:e._roughness},n&&(e._albedoTexture&&i.push(this.exportTextureAsync(e._albedoTexture,t).then((function(e){e&&(r.baseColorTexture=e)}))),(s=e._metallicTexture)&&i.push(this.exportTextureAsync(s,t).then((function(e){e&&(r.metallicRoughnessTexture=e)})))),i.length>0?(this._exporter._materialNeedsUVsSet.add(e),[4,Promise.all(i)]):[3,2];case 1:a.sent(),a.label=2;case 2:return[2,o]}}))}))},e.prototype._getTextureSampler=function(e){var t={};if(!(e&&e instanceof d.Texture))return t;var r=this._getGLTFTextureWrapMode(e.wrapU);10497!==r&&(t.wrapS=r);var n=this._getGLTFTextureWrapMode(e.wrapV);switch(10497!==n&&(t.wrapT=n),e.samplingMode){case d.Texture.LINEAR_LINEAR:t.magFilter=9729,t.minFilter=9729;break;case d.Texture.LINEAR_NEAREST:t.magFilter=9729,t.minFilter=9728;break;case d.Texture.NEAREST_LINEAR:t.magFilter=9728,t.minFilter=9729;break;case d.Texture.NEAREST_LINEAR_MIPLINEAR:t.magFilter=9728,t.minFilter=9987;break;case d.Texture.NEAREST_NEAREST:t.magFilter=9728,t.minFilter=9728;break;case d.Texture.NEAREST_LINEAR_MIPNEAREST:t.magFilter=9728,t.minFilter=9985;break;case d.Texture.LINEAR_NEAREST_MIPNEAREST:t.magFilter=9729,t.minFilter=9984;break;case d.Texture.LINEAR_NEAREST_MIPLINEAR:t.magFilter=9729,t.minFilter=9986;break;case d.Texture.NEAREST_NEAREST_MIPLINEAR:t.magFilter=9728,t.minFilter=9986;break;case d.Texture.LINEAR_LINEAR_MIPLINEAR:t.magFilter=9729,t.minFilter=9987;break;case d.Texture.LINEAR_LINEAR_MIPNEAREST:t.magFilter=9729,t.minFilter=9985;break;case d.Texture.NEAREST_NEAREST_MIPNEAREST:t.magFilter=9728,t.minFilter=9984}return t},e.prototype._getGLTFTextureWrapMode=function(e){switch(e){case d.Texture.WRAP_ADDRESSMODE:return 10497;case d.Texture.CLAMP_ADDRESSMODE:return 33071;case d.Texture.MIRROR_ADDRESSMODE:return 33648;default:return d.Tools.Error("Unsupported Texture Wrap Mode ".concat(e,"!")),10497}},e.prototype._convertSpecGlossFactorsToMetallicRoughnessAsync=function(e,t,r,n){return m(this,void 0,void 0,(function(){var i,o,s,a,u,l,c,f;return _(this,(function(h){switch(h.label){case 0:return i={diffuseColor:e._albedoColor,specularColor:e._reflectivityColor,glossiness:e._microSurface},o=e._albedoTexture,s=e._reflectivityTexture,a=e._useMicroSurfaceFromReflectivityMapAlpha,s&&!a?[2,Promise.reject("_ConvertPBRMaterial: Glossiness values not included in the reflectivity texture are currently not supported")]:(o||s)&&n?(this._exporter._materialNeedsUVsSet.add(e),u=this._exportTextureSampler(o||s),[4,this._convertSpecularGlossinessTexturesToMetallicRoughnessAsync(o,s,i,t)]):[3,2];case 1:return l=h.sent(),c=this._exporter._textures,l.baseColorTextureData&&(f=this._exportImage("baseColor".concat(c.length),t,l.baseColorTextureData),r.baseColorTexture=this._exportTextureInfo(f,u,null==o?void 0:o.coordinatesIndex)),l.metallicRoughnessTextureData&&(f=this._exportImage("metallicRoughness".concat(c.length),t,l.metallicRoughnessTextureData),r.metallicRoughnessTexture=this._exportTextureInfo(f,u,null==s?void 0:s.coordinatesIndex)),[2,l];case 2:return[2,this._convertSpecularGlossinessToMetallicRoughness(i)]}}))}))},e.prototype.exportPBRMaterialAsync=function(e,t,r){return m(this,void 0,void 0,(function(){var n,i,o,s,a,u,l,c;return _(this,(function(f){switch(f.label){case 0:return n={},i={name:e.name},(o=e.isMetallicWorkflow())&&(s=e._albedoColor,a=e.alpha,s&&(n.baseColorFactor=[s.r,s.g,s.b,a])),o?[4,this._convertMetalRoughFactorsToMetallicRoughnessAsync(e,t,n,r)]:[3,2];case 1:return l=f.sent(),[3,4];case 2:return[4,this._convertSpecGlossFactorsToMetallicRoughnessAsync(e,t,n,r)];case 3:l=f.sent(),f.label=4;case 4:return u=l,[4,this._setMetallicRoughnessPbrMaterialAsync(u,e,i,n,t,r)];case 5:return f.sent(),[4,this._finishMaterialAsync(i,e,t)];case 6:return f.sent(),(c=this._exporter._materials).push(i),[2,c.length-1]}}))}))},e.prototype._setMetallicRoughnessPbrMaterialAsync=function(e,t,r,n,i,o){return m(this,void 0,void 0,(function(){var s,a,u,l,c;return _(this,(function(f){switch(f.label){case 0:return R(r,t),e.baseColor.equalsWithEpsilon(A,T)&&d.Scalar.WithinEpsilon(t.alpha,1,T)||(n.baseColorFactor=[e.baseColor.r,e.baseColor.g,e.baseColor.b,t.alpha]),null!=e.metallic&&1!==e.metallic&&(n.metallicFactor=e.metallic),null!=e.roughness&&1!==e.roughness&&(n.roughnessFactor=e.roughness),null==t.backFaceCulling||t.backFaceCulling||(t._twoSidedLighting||d.Tools.Warn(t.name+": Back-face culling disabled and two-sided lighting disabled is not supported in glTF."),r.doubleSided=!0),o?(s=[],(a=t._bumpTexture)&&s.push(this.exportTextureAsync(a,i).then((function(e){e&&(r.normalTexture=e,1!==a.level&&(r.normalTexture.scale=a.level))}))),(u=t._ambientTexture)&&s.push(this.exportTextureAsync(u,i).then((function(e){if(e){var n={index:e.index,texCoord:e.texCoord,extensions:e.extensions};r.occlusionTexture=n;var i=t._ambientTextureStrength;i&&(n.strength=i)}}))),(l=t._emissiveTexture)&&s.push(this.exportTextureAsync(l,i).then((function(e){e&&(r.emissiveTexture=e)}))),s.length>0?(this._exporter._materialNeedsUVsSet.add(t),[4,Promise.all(s)]):[3,2]):[3,2];case 1:f.sent(),f.label=2;case 2:return(c=t._emissiveColor).equalsWithEpsilon(w,T)||(r.emissiveFactor=c.asArray()),r.pbrMetallicRoughness=n,[2]}}))}))},e.prototype._getPixelsFromTexture=function(e){return e.textureType,d.Constants.TEXTURETYPE_UNSIGNED_BYTE,e.readPixels()},e.prototype.exportTextureAsync=function(e,t){return m(this,void 0,void 0,(function(){var r,n=this;return _(this,(function(i){return(r=this._exporter._extensionsPreExportTextureAsync("exporter",e,t))?[2,r.then((function(r){return r?n._exportTextureInfoAsync(r,t):n._exportTextureInfoAsync(e,t)}))]:[2,this._exportTextureInfoAsync(e,t)]}))}))},e.prototype._exportTextureInfoAsync=function(e,t){return m(this,void 0,void 0,(function(){var r,n,i,o,s,a,u,l,c,f=this;return _(this,(function(h){switch(h.label){case 0:return(r=this._textureMap.get(e))?[3,3]:[4,this._getPixelsFromTexture(e)];case 1:if(!(n=h.sent()))return[2,null];if(i=this._exportTextureSampler(e),o=e.mimeType)switch(o){case"image/jpeg":case"image/png":case"image/webp":t=o;break;default:d.Tools.Warn("Unsupported media type: ".concat(o))}return s=this._internalTextureToImage,a=e.getInternalTexture().uniqueId,s[a]||(s[a]={}),void 0===(u=s[a][t])&&(l=e.getSize(),u=m(f,void 0,void 0,(function(){var r;return _(this,(function(i){switch(i.label){case 0:return[4,this._getImageDataAsync(n,l.width,l.height,t)];case 1:return r=i.sent(),[2,this._exportImage(e.name,t,r)]}}))})),s[a][t]=u),c=this._exportTextureInfo,[4,u];case 2:r=c.apply(this,[h.sent(),i,e.coordinatesIndex]),this._textureMap.set(e,r),this._exporter._extensionsPostExportTextures("exporter",r,e),h.label=3;case 3:return[2,r]}}))}))},e.prototype._exportImage=function(e,t,r){var n=this._exporter._imageData,i=e.replace(/\.\/|\/|\.\\|\\/g,"_"),o=function(e){switch(e){case"image/jpeg":return".jpg";case"image/png":return".png";case"image/webp":return".webp";case"image/avif":return".avif"}}(t),s=i+o;s in n&&(s="".concat(i,"_").concat(d.Tools.RandomId()).concat(o)),n[s]={data:r,mimeType:t};var a=this._exporter._images;return a.push({name:e,uri:s}),a.length-1},e.prototype._exportTextureInfo=function(e,t,r){var n=this._exporter._textures,i=n.findIndex((function(r){return r.sampler==t&&r.source===e}));-1===i&&(i=n.length,n.push({source:e,sampler:t}));var o={index:i};return r&&(o.texCoord=r),o},e.prototype._exportTextureSampler=function(e){var t=this._getTextureSampler(e),r=this._exporter._samplers,n=r.findIndex((function(e){return e.minFilter===t.minFilter&&e.magFilter===t.magFilter&&e.wrapS===t.wrapS&&e.wrapT===t.wrapT}));return-1!==n?n:(r.push(t),r.length-1)},e}(),S=d.Matrix.Compose(new d.Vector3(-1,1,1),d.Quaternion.Identity(),d.Vector3.Zero()),I=new d.Quaternion(0,1,0,0),N=1e-6,B=d.Vector3.Zero(),P=d.Vector3.One();function O(e,t,r,n){var i={buffer:e,byteLength:r};return t&&(i.byteOffset=t),n&&(i.byteStride=n),i}function U(e,t,r,n,i,o,s){void 0===o&&(o=null);var a={bufferView:e,componentType:r,count:n,type:t};return null!=o&&(a.min=o.min,a.max=o.max),s&&(a.normalized=s),null!=i&&(a.byteOffset=i),a}function L(e,t){if(e==d.VertexBuffer.ColorKind)return t?"VEC4":"VEC3";switch(e){case d.VertexBuffer.PositionKind:case d.VertexBuffer.NormalKind:return"VEC3";case d.VertexBuffer.TangentKind:case d.VertexBuffer.MatricesIndicesKind:case d.VertexBuffer.MatricesIndicesExtraKind:case d.VertexBuffer.MatricesWeightsKind:case d.VertexBuffer.MatricesWeightsExtraKind:return"VEC4";case d.VertexBuffer.UVKind:case d.VertexBuffer.UV2Kind:case d.VertexBuffer.UV3Kind:case d.VertexBuffer.UV4Kind:case d.VertexBuffer.UV5Kind:case d.VertexBuffer.UV6Kind:return"VEC2"}throw new Error("Unknown kind ".concat(e))}function k(e){switch(e){case d.VertexBuffer.PositionKind:return"POSITION";case d.VertexBuffer.NormalKind:return"NORMAL";case d.VertexBuffer.TangentKind:return"TANGENT";case d.VertexBuffer.ColorKind:return"COLOR_0";case d.VertexBuffer.UVKind:return"TEXCOORD_0";case d.VertexBuffer.UV2Kind:return"TEXCOORD_1";case d.VertexBuffer.UV3Kind:return"TEXCOORD_2";case d.VertexBuffer.UV4Kind:return"TEXCOORD_3";case d.VertexBuffer.UV5Kind:return"TEXCOORD_4";case d.VertexBuffer.UV6Kind:return"TEXCOORD_5";case d.VertexBuffer.MatricesIndicesKind:return"JOINTS_0";case d.VertexBuffer.MatricesIndicesExtraKind:return"JOINTS_1";case d.VertexBuffer.MatricesWeightsKind:return"WEIGHTS_0";case d.VertexBuffer.MatricesWeightsExtraKind:return"WEIGHTS_1"}throw new Error("Unknown kind: ".concat(e))}function D(e){switch(e){case d.Material.TriangleFillMode:return 4;case d.Material.TriangleStripDrawMode:return 5;case d.Material.TriangleFanDrawMode:return 6;case d.Material.PointListDrawMode:case d.Material.PointFillMode:return 0;case d.Material.LineLoopDrawMode:return 2;case d.Material.LineListDrawMode:return 1;case d.Material.LineStripDrawMode:return 3}throw new Error("Unknown fill mode: ".concat(e))}function K(e){var t=Math.sqrt(e.x*e.x+e.y*e.y+e.z*e.z);t>0&&(e.x/=t,e.y/=t,e.z/=t)}function W(e){return e.x*=-1,e}function G(e){return e.x*=-1,e.y*=-1,e}function j(e){return e.multiplyInPlace(I)}function H(e,t){return t instanceof d.TransformNode&&1==t.getChildren().length&&0==e.getChildren().length}function q(e,t){if(!(e instanceof d.TransformNode))return!1;if(t){if(!e.getWorldMatrix().isIdentity())return!1}else if(!e.getWorldMatrix().multiplyToRef(S,d.TmpVectors.Matrix[0]).isIdentity())return!1;return!(e instanceof d.Mesh&&e.geometry||e instanceof d.InstancedMesh&&e.sourceMesh.geometry)}function z(e,t){for(var r=0,n=Object.entries(e);r<n.length;r++){var i=n[r],o=i[0],s=i[1],a=t[o];(Array.isArray(s)&&Array.isArray(a)&&Q(s,a)||s===a)&&delete e[o]}return e}function Q(e,t){return e.length===t.length&&e.every((function(e,r){return e===t[r]}))}var Y,X=function(){function e(e){this._data=new Uint8Array(e),this._dataView=new DataView(this._data.buffer),this._byteOffset=0}return Object.defineProperty(e.prototype,"byteOffset",{get:function(){return this._byteOffset},enumerable:!1,configurable:!0}),e.prototype.getOutputData=function(){return new Uint8Array(this._data.buffer,0,this._byteOffset)},e.prototype.writeUInt8=function(e){this._checkGrowBuffer(1),this._dataView.setUint8(this._byteOffset,e),this._byteOffset++},e.prototype.writeInt8=function(e){this._checkGrowBuffer(1),this._dataView.setInt8(this._byteOffset,e),this._byteOffset++},e.prototype.writeInt16=function(e){this._checkGrowBuffer(2),this._dataView.setInt16(this._byteOffset,e,!0),this._byteOffset+=2},e.prototype.writeUInt16=function(e){this._checkGrowBuffer(2),this._dataView.setUint16(this._byteOffset,e,!0),this._byteOffset+=2},e.prototype.writeUInt32=function(e){this._checkGrowBuffer(4),this._dataView.setUint32(this._byteOffset,e,!0),this._byteOffset+=4},e.prototype.writeFloat32=function(e){this._checkGrowBuffer(4),this._dataView.setFloat32(this._byteOffset,e,!0),this._byteOffset+=4},e.prototype.writeUint8Array=function(e){this._checkGrowBuffer(e.byteLength),this._data.set(e,this._byteOffset),this._byteOffset+=e.byteLength},e.prototype.writeUint16Array=function(e){this._checkGrowBuffer(e.byteLength),this._data.set(e,this._byteOffset),this._byteOffset+=e.byteLength},e.prototype._checkGrowBuffer=function(e){var t=this.byteOffset+e;if(t>this._data.byteLength){var r=new Uint8Array(2*t);r.set(this._data),this._data=r,this._dataView=new DataView(this._data.buffer)}},e}();!function(e){e[e.INTANGENT=0]="INTANGENT",e[e.OUTTANGENT=1]="OUTTANGENT"}(Y||(Y={}));var Z=function(){function e(){}return e._IsTransformable=function(e){return e&&(e instanceof d.TransformNode||e instanceof d.Camera||e instanceof d.Light)},e._CreateNodeAnimation=function(t,r,n,i,o){if(this._IsTransformable(t)){var s=[],a=[],u=r.getKeys(),l=e._CalculateMinMaxKeyFrames(u),c=e._DeduceInterpolation(u,n,i),f=c.interpolationType,h=c.shouldBakeAnimation;if(h?e._CreateBakedAnimation(t,r,n,l.min,l.max,r.framePerSecond,o,s,a,l,i):"LINEAR"===f||"STEP"===f?e._CreateLinearOrStepAnimation(t,r,n,s,a,i):"CUBICSPLINE"===f?e._CreateCubicSplineAnimation(t,r,n,s,a,i):e._CreateBakedAnimation(t,r,n,l.min,l.max,r.framePerSecond,o,s,a,l,i),s.length&&a.length)return{inputs:s,outputs:a,samplerInterpolation:f,inputsMin:h?l.min:d.Tools.FloatRound(l.min/r.framePerSecond),inputsMax:h?l.max:d.Tools.FloatRound(l.max/r.framePerSecond)}}return null},e._DeduceAnimationInfo=function(e){var t=null,r="VEC3",n=!1,i=e.targetProperty.split(".");switch(i[0]){case"scaling":t="scale";break;case"position":t="translation";break;case"rotation":r="VEC4",t="rotation";break;case"rotationQuaternion":r="VEC4",n=!0,t="rotation";break;case"influence":r="SCALAR",t="weights";break;default:d.Tools.Error("Unsupported animatable property ".concat(i[0]))}return t?{animationChannelTargetPath:t,dataAccessorType:r,useQuaternion:n}:(d.Tools.Error("animation channel target path and data accessor type could be deduced"),null)},e._CreateNodeAnimationFromNodeAnimations=function(t,r,n,i,o,s,a,u,l,c,f){var h;if(e._IsTransformable(t)&&t.animations)for(var p=0,d=t.animations;p<d.length;p++){var g=d[p];if(!f||f(g)){var x=e._DeduceAnimationInfo(g);x&&(h={name:g.name,samplers:[],channels:[]},e._AddAnimation("".concat(g.name),g.hasRunningRuntimeAnimations?r:h,t,g,x.dataAccessorType,x.animationChannelTargetPath,i,s,a,u,x.useQuaternion,l,c),h.samplers.length&&h.channels.length&&n.push(h))}}},e._CreateMorphTargetAnimationFromMorphTargetAnimations=function(t,r,n,i,o,s,a,u,l,c,f){var h;if(t instanceof d.Mesh){var p=t.morphTargetManager;if(p)for(var g=0;g<p.numTargets;++g)for(var x=0,m=p.getTarget(g).animations;x<m.length;x++){var _=m[x];if(!f||f(_)){for(var y=new d.Animation("".concat(_.name),"influence",_.framePerSecond,_.dataType,_.loopMode,_.enableBlending),T=[],v=_.getKeys(),b=0;b<v.length;++b)for(var A=v[b],w=0;w<p.numTargets;++w)w==g?T.push(A):T.push({frame:A.frame,value:0});y.setKeys(T);var E=e._DeduceAnimationInfo(y);E&&(h={name:y.name,samplers:[],channels:[]},e._AddAnimation(_.name,_.hasRunningRuntimeAnimations?r:h,t,y,E.dataAccessorType,E.animationChannelTargetPath,i,s,a,u,E.useQuaternion,l,c,p.numTargets),h.samplers.length&&h.channels.length&&n.push(h))}}}},e._CreateNodeAndMorphAnimationFromAnimationGroups=function(t,r,n,i,o,s,a,u,l){var c,f;if(t.animationGroups)for(var h=t.animationGroups,p=function(h){var p=new Map,x=new Map,m=new Set,_=h.to-h.from;f={name:h.name,channels:[],samplers:[]};for(var y=function(r){var _=h.targetedAnimations[r],y=_.target,T=_.animation;if(l&&!l(T))return"continue";var v=u.has(y);if(g._IsTransformable(y)||1===y.length&&g._IsTransformable(y[0])){if(A=e._DeduceAnimationInfo(_.animation)){var b=g._IsTransformable(y)?y:g._IsTransformable(y[0])?y[0]:null;b&&e._AddAnimation("".concat(T.name),f,b,T,A.dataAccessorType,A.animationChannelTargetPath,n,i,o,s,A.useQuaternion,a,v)}}else if(y instanceof d.MorphTarget||1===y.length&&y[0]instanceof d.MorphTarget){var A;if(A=e._DeduceAnimationInfo(_.animation)){var w=y instanceof d.MorphTarget?y:y[0];if(w){var E=t.morphTargetManagers.find((function(e){for(var t=0;t<e.numTargets;++t)if(e.getTarget(t)===w)return!0;return!1}));if(E){var M=t.meshes.find((function(e){return e.morphTargetManager===E}));M&&(p.has(M)||p.set(M,new Map),null===(c=p.get(M))||void 0===c||c.set(w,T),m.add(M),x.set(M,T))}}}}},T=0;T<h.targetedAnimations.length;++T)y(T);m.forEach((function(t){for(var r=t.morphTargetManager,u=null,l=[],c=x.get(t).getKeys(),g=c.length,m=0;m<g;++m)for(var y=0;y<r.numTargets;++y){var T=r.getTarget(y),v=p.get(t);if(v){var b=v.get(T);b?(u||(u=new d.Animation("".concat(h.name,"_").concat(t.name,"_MorphWeightAnimation"),"influence",b.framePerSecond,d.Animation.ANIMATIONTYPE_FLOAT,b.loopMode,b.enableBlending)),l.push(b.getKeys()[m])):l.push({frame:h.from+_/g*m,value:T.influence,inTangent:c[0].inTangent?0:void 0,outTangent:c[0].outTangent?0:void 0})}}u.setKeys(l);var A=e._DeduceAnimationInfo(u);A&&e._AddAnimation("".concat(h.name,"_").concat(t.name,"_MorphWeightAnimation"),f,t,u,A.dataAccessorType,A.animationChannelTargetPath,n,i,o,s,A.useQuaternion,a,!1,null==r?void 0:r.numTargets)})),f.channels.length&&f.samplers.length&&r.push(f)},g=this,x=0,m=h;x<m.length;x++)p(m[x])},e._AddAnimation=function(t,r,n,i,o,s,a,u,l,c,f,h,p,g){var x,m,_,y,T,v,b,A=e._CreateNodeAnimation(n,i,s,f,h);if(A){if(g){for(var w=0,E=0,M=[];A.inputs.length>0;)E=A.inputs.shift(),w%g==0&&M.push(E),w++;A.inputs=M}var R=a.get(n),C=4*A.inputs.length;x=O(0,u.byteOffset,C),l.push(x),A.inputs.forEach((function(e){u.writeFloat32(e)})),m=U(l.length-1,"SCALAR",5126,A.inputs.length,null,{min:[A.inputsMin],max:[A.inputsMax]}),c.push(m),_=c.length-1,T=A.outputs.length,C=4*function(e){switch(e){case"MAT2":case"VEC4":return 4;case"MAT3":return 9;case"MAT4":return 16;case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":return 3}}(o)*A.outputs.length,x=O(0,u.byteOffset,C),l.push(x);var V=new d.Quaternion,F=new d.Vector3,S=new d.Vector3,I=n instanceof d.Camera;A.outputs.forEach((function(e){if(p)switch(s){case"translation":d.Vector3.FromArrayToRef(e,0,S),W(S),u.writeFloat32(S.x),u.writeFloat32(S.y),u.writeFloat32(S.z);break;case"rotation":4===e.length?d.Quaternion.FromArrayToRef(e,0,V):(d.Vector3.FromArrayToRef(e,0,F),d.Quaternion.FromEulerVectorToRef(F,V)),I?j(V):d.Quaternion.IsIdentity(V)||G(V),u.writeFloat32(V.x),u.writeFloat32(V.y),u.writeFloat32(V.z),u.writeFloat32(V.w);break;default:e.forEach((function(e){u.writeFloat32(e)}))}else"rotation"===s?(4===e.length?d.Quaternion.FromArrayToRef(e,0,V):(d.Vector3.FromArrayToRef(e,0,F),d.Quaternion.FromEulerVectorToRef(F,V)),I&&j(V),u.writeFloat32(V.x),u.writeFloat32(V.y),u.writeFloat32(V.z),u.writeFloat32(V.w)):e.forEach((function(e){u.writeFloat32(e)}))})),m=U(l.length-1,o,5126,T,null),c.push(m),y=c.length-1,v={interpolation:A.samplerInterpolation,input:_,output:y},r.samplers.push(v),b={sampler:r.samplers.length-1,target:{node:R,path:s}},r.channels.push(b)}},e._CreateBakedAnimation=function(t,r,n,i,o,s,a,u,l,c,f){var h,p,g=d.Quaternion.Identity(),x=null,m=null,_=null,y=null,T=null,v=null;c.min=d.Tools.FloatRound(i/s);for(var b=r.getKeys(),A=0,w=b.length;A<w;++A){if(v=null,_=b[A],A+1<w)if(y=b[A+1],_.value.equals&&_.value.equals(y.value)||_.value===y.value){if(0!==A)continue;v=_.frame}else v=y.frame;else{if(T=b[A-1],_.value.equals&&_.value.equals(T.value)||_.value===T.value)continue;v=o}if(v)for(var E=_.frame;E<=v;E+=a)if((p=d.Tools.FloatRound(E/s))!==x){x=p,m=p;var M={key:0,repeatCount:0,loopMode:r.loopMode};h=r._interpolate(E,M),e._SetInterpolatedValue(t,h,p,r,n,g,u,l,f)}}m&&(c.max=m)},e._ConvertFactorToVector3OrQuaternion=function(t,r,n,i,o){var s=e._GetBasePositionRotationOrScale(r,i,o),a=n.targetProperty.split("."),u=a?a[1]:"",l=o?d.Quaternion.FromArray(s).normalize():d.Vector3.FromArray(s);switch(u){case"x":case"y":case"z":l[u]=t;break;case"w":l.w=t;break;default:d.Tools.Error('glTFAnimation: Unsupported component name "'.concat(u,'"!'))}return l},e._SetInterpolatedValue=function(e,t,r,n,i,o,s,a,u){var l;s.push(r),"weights"!==i?(n.dataType===d.Animation.ANIMATIONTYPE_FLOAT&&(t=this._ConvertFactorToVector3OrQuaternion(t,e,n,i,u)),"rotation"===i?(u?o=t:(l=t,d.Quaternion.RotationYawPitchRollToRef(l.y,l.x,l.z,o)),a.push(o.asArray())):(l=t,a.push(l.asArray()))):a.push([t])},e._CreateLinearOrStepAnimation=function(t,r,n,i,o,s){for(var a=0,u=r.getKeys();a<u.length;a++){var l=u[a];i.push(l.frame/r.framePerSecond),e._AddKeyframeValue(l,r,o,n,t,s)}},e._CreateCubicSplineAnimation=function(t,r,n,i,o,s){r.getKeys().forEach((function(a){i.push(a.frame/r.framePerSecond),e._AddSplineTangent(Y.INTANGENT,o,n,"CUBICSPLINE",a,s),e._AddKeyframeValue(a,r,o,n,t,s),e._AddSplineTangent(Y.OUTTANGENT,o,n,"CUBICSPLINE",a,s)}))},e._GetBasePositionRotationOrScale=function(e,t,r){var n;if("rotation"===t)if(r){var i=e.rotationQuaternion;n=(null!=i?i:d.Quaternion.Identity()).asArray()}else{var o=e.rotation;n=(null!=o?o:d.Vector3.Zero()).asArray()}else if("translation"===t){var s=e.position;n=(null!=s?s:d.Vector3.Zero()).asArray()}else{var a=e.scaling;n=(null!=a?a:d.Vector3.One()).asArray()}return n},e._AddKeyframeValue=function(e,t,r,n,i,o){var s,a=t.dataType;if(a===d.Animation.ANIMATIONTYPE_VECTOR3){var u=e.value.asArray();if("rotation"===n){var l=d.Vector3.FromArray(u);u=d.Quaternion.RotationYawPitchRoll(l.y,l.x,l.z).asArray()}r.push(u)}else if(a===d.Animation.ANIMATIONTYPE_FLOAT){if("weights"===n)r.push([e.value]);else if(s=this._ConvertFactorToVector3OrQuaternion(e.value,i,t,n,o)){if("rotation"===n){var c=o?s:d.Quaternion.RotationYawPitchRoll(s.y,s.x,s.z).normalize();r.push(c.asArray())}r.push(s.asArray())}}else a===d.Animation.ANIMATIONTYPE_QUATERNION?r.push(e.value.normalize().asArray()):d.Tools.Error("glTFAnimation: Unsupported key frame values for animation!")},e._DeduceInterpolation=function(e,t,r){var n,i,o=!1;if("rotation"===t&&!r)return{interpolationType:"LINEAR",shouldBakeAnimation:!0};for(var s=0,a=e.length;s<a;++s)if((i=e[s]).inTangent||i.outTangent)if(n){if("CUBICSPLINE"!==n){n="LINEAR",o=!0;break}}else n="CUBICSPLINE";else if(n){if("CUBICSPLINE"===n||i.interpolation&&1===i.interpolation&&"STEP"!==n){n="LINEAR",o=!0;break}}else n=i.interpolation&&1===i.interpolation?"STEP":"LINEAR";return n||(n="LINEAR"),{interpolationType:n,shouldBakeAnimation:o}},e._AddSplineTangent=function(e,t,r,n,i,o){var s,a=e===Y.INTANGENT?i.inTangent:i.outTangent;if("CUBICSPLINE"===n){if("rotation"===r)if(a)if(o)s=a.asArray();else{var u=a;s=d.Quaternion.RotationYawPitchRoll(u.y,u.x,u.z).asArray()}else s=[0,0,0,0];else s="weights"===r?a?[a]:[0]:a?a.asArray():[0,0,0];t.push(s)}},e._CalculateMinMaxKeyFrames=function(e){var t=1/0,r=-1/0;return e.forEach((function(e){t=Math.min(t,e.frame),r=Math.max(r,e.frame)})),{min:t,max:r}},e}();function J(e,t,r,n,i,o){var s={attributes:{},influence:e.influence,name:e.name},a=o?-1:1,u=d.Vector3.Zero(),l=0,c=0,f=0,h=0;if(e.hasPositions){var p=e.getPositions(),g=t.getVerticesData(d.VertexBuffer.PositionKind,void 0,void 0,!0);if(g){var x=[1/0,1/0,1/0],m=[-1/0,-1/0,-1/0];c=g.length/3,f=r.byteOffset;for(var _=l=0;_<c;++_){var y=d.Vector3.FromArray(g,3*_);d.Vector3.FromArray(p,3*_).subtractToRef(y,u),u.x*=a,x[0]=Math.min(x[0],u.x),m[0]=Math.max(m[0],u.x),x[1]=Math.min(x[1],u.y),m[1]=Math.max(m[1],u.y),x[2]=Math.min(x[2],u.z),m[2]=Math.max(m[2],u.z),r.writeFloat32(u.x),r.writeFloat32(u.y),r.writeFloat32(u.z)}n.push(O(0,f,4*p.length,12)),h=n.length-1,i.push(U(h,"VEC3",5126,p.length/3,0,{min:x,max:m})),s.attributes.POSITION=i.length-1}else d.Tools.Warn("Morph target positions for mesh ".concat(t.name," were not exported. Mesh does not have position vertex data"))}if(e.hasNormals){var T=e.getNormals(),v=t.getVerticesData(d.VertexBuffer.NormalKind,void 0,void 0,!0);if(v){for(c=v.length/3,f=r.byteOffset,_=l=0;_<c;++_){var b=d.Vector3.FromArray(v,3*_).normalize();d.Vector3.FromArray(T,3*_).normalize().subtractToRef(b,u),r.writeFloat32(u.x*a),r.writeFloat32(u.y),r.writeFloat32(u.z)}n.push(O(0,f,4*T.length,12)),h=n.length-1,i.push(U(h,"VEC3",5126,T.length/3,0)),s.attributes.NORMAL=i.length-1}else d.Tools.Warn("Morph target normals for mesh ".concat(t.name," were not exported. Mesh does not have normals vertex data"))}if(e.hasTangents){var A=e.getTangents(),w=t.getVerticesData(d.VertexBuffer.TangentKind,void 0,void 0,!0);if(w){for(c=w.length/4,l=0,f=r.byteOffset,_=l;_<c;++_){var E=d.Vector3.FromArray(w,4*_);K(E);var M=d.Vector3.FromArray(A,3*_);K(M),M.subtractToRef(E,u),r.writeFloat32(u.x*a),r.writeFloat32(u.y),r.writeFloat32(u.z)}n.push(O(0,f,4*c*3,12)),h=n.length-1,i.push(U(h,"VEC3",5126,c,0)),s.attributes.TANGENT=i.length-1}else d.Tools.Warn("Morph target tangents for mesh ".concat(t.name," were not exported. Mesh does not have tangents vertex data"))}return s}var $=function(){function e(e,t){this._indicesAccessorMap=new Map,this._vertexBufferViewMap=new Map,this._vertexAccessorMap=new Map,this._remappedBufferView=new Map,this._meshMorphTargetMap=new Map,this._vertexMapColorAlpha=new Map,this._exportedNodes=new Set,this._meshMap=new Map,this.convertedToRightHandedBuffers=new Map,this.convertToRightHanded=e,this.wasAddedByNoopNode=t}return e.prototype.getIndicesAccessor=function(e,t,r,n,i){var o,s,a,u;return null===(u=null===(a=null===(s=null===(o=this._indicesAccessorMap.get(e))||void 0===o?void 0:o.get(t))||void 0===s?void 0:s.get(r))||void 0===a?void 0:a.get(n))||void 0===u?void 0:u.get(i)},e.prototype.setIndicesAccessor=function(e,t,r,n,i,o){var s=this._indicesAccessorMap.get(e);s||(s=new Map,this._indicesAccessorMap.set(e,s));var a=s.get(t);a||(a=new Map,s.set(t,a));var u=a.get(r);u||(u=new Map,a.set(r,u));var l=u.get(n);l||(l=new Map,u.set(n,l)),l.set(i,o)},e.prototype.pushExportedNode=function(e){this._exportedNodes.has(e)||this._exportedNodes.add(e)},e.prototype.getNodesSet=function(){return this._exportedNodes},e.prototype.getVertexBufferView=function(e){return this._vertexBufferViewMap.get(e)},e.prototype.setVertexBufferView=function(e,t){this._vertexBufferViewMap.set(e,t)},e.prototype.setRemappedBufferView=function(e,t,r){this._remappedBufferView.set(e,new Map),this._remappedBufferView.get(e).set(t,r)},e.prototype.getRemappedBufferView=function(e,t){var r;return null===(r=this._remappedBufferView.get(e))||void 0===r?void 0:r.get(t)},e.prototype.getVertexAccessor=function(e,t,r){var n,i;return null===(i=null===(n=this._vertexAccessorMap.get(e))||void 0===n?void 0:n.get(t))||void 0===i?void 0:i.get(r)},e.prototype.setVertexAccessor=function(e,t,r,n){var i=this._vertexAccessorMap.get(e);i||(i=new Map,this._vertexAccessorMap.set(e,i));var o=i.get(t);o||(o=new Map,i.set(t,o)),o.set(r,n)},e.prototype.hasVertexColorAlpha=function(e){return this._vertexMapColorAlpha.get(e)||!1},e.prototype.setHasVertexColorAlpha=function(e,t){return this._vertexMapColorAlpha.set(e,t)},e.prototype.getMesh=function(e){return this._meshMap.get(e)},e.prototype.setMesh=function(e,t){this._meshMap.set(e,t)},e.prototype.bindMorphDataToMesh=function(e,t){var r=this._meshMorphTargetMap.get(e)||[];this._meshMorphTargetMap.set(e,r),-1===r.indexOf(t)&&r.push(t)},e.prototype.getMorphTargetsFromMesh=function(e){return this._meshMorphTargetMap.get(e)},e}(),ee=function(){function e(e,t){if(void 0===e&&(e=d.EngineStore.LastCreatedScene),this._glTF={asset:{generator:"Babylon.js v".concat(d.Engine.Version),version:"2.0"}},this._animations=[],this._accessors=[],this._bufferViews=[],this._cameras=[],this._images=[],this._materials=[],this._meshes=[],this._nodes=[],this._samplers=[],this._scenes=[],this._skins=[],this._textures=[],this._imageData={},this._orderedImageData=[],this._materialExporter=new F(this),this._extensions={},this._dataWriter=new X(4),this._shouldExportNodeMap=new Map,this._nodeMap=new Map,this._materialMap=new Map,this._camerasMap=new Map,this._nodesCameraMap=new Map,this._skinMap=new Map,this._nodesSkinMap=new Map,this._materialNeedsUVsSet=new Set,!e)throw new Error("No scene available to export");this._babylonScene=e,this._options=x({shouldExportNode:function(){return!0},shouldExportAnimation:function(){return!0},metadataSelector:function(e){return e},animationSampleRate:1/60,exportWithoutWaitingForScene:!1,exportUnusedUVs:!1,removeNoopRootNodes:!0,includeCoordinateSystemConversionNodes:!1},t),this._loadExtensions()}return e.prototype._applyExtension=function(e,t,r,n){var i=this;if(r>=t.length)return Promise.resolve(e);var o=n(t[r],e);return o?o.then((function(e){return e?i._applyExtension(e,t,r+1,n):null})):this._applyExtension(e,t,r+1,n)},e.prototype._applyExtensions=function(t,r){for(var n=[],i=0,o=e._ExtensionNames;i<o.length;i++){var s=o[i];n.push(this._extensions[s])}return this._applyExtension(t,n,0,r)},e.prototype._extensionsPreExportTextureAsync=function(e,t,r){return this._applyExtensions(t,(function(t,n){return t.preExportTextureAsync&&t.preExportTextureAsync(e,n,r)}))},e.prototype._extensionsPostExportMeshPrimitiveAsync=function(e,t,r){return this._applyExtensions(t,(function(t,n){return t.postExportMeshPrimitiveAsync&&t.postExportMeshPrimitiveAsync(e,n,r)}))},e.prototype._extensionsPostExportNodeAsync=function(e,t,r,n,i){var o=this;return this._applyExtensions(t,(function(t,s){return t.postExportNodeAsync&&t.postExportNodeAsync(e,s,r,n,i,o._dataWriter)}))},e.prototype._extensionsPostExportMaterialAsync=function(e,t,r){return this._applyExtensions(t,(function(t,n){return t.postExportMaterialAsync&&t.postExportMaterialAsync(e,n,r)}))},e.prototype._extensionsPostExportMaterialAdditionalTextures=function(t,r,n){for(var i=[],o=0,s=e._ExtensionNames;o<s.length;o++){var a=s[o],u=this._extensions[a];u.postExportMaterialAdditionalTextures&&i.push.apply(i,u.postExportMaterialAdditionalTextures(t,r,n))}return i},e.prototype._extensionsPostExportTextures=function(t,r,n){for(var i=0,o=e._ExtensionNames;i<o.length;i++){var s=o[i],a=this._extensions[s];a.postExportTexture&&a.postExportTexture(t,r,n)}},e.prototype._forEachExtensions=function(t){for(var r=0,n=e._ExtensionNames;r<n.length;r++){var i=n[r],o=this._extensions[i];o.enabled&&t(o)}},e.prototype._extensionsOnExporting=function(){var e=this;this._forEachExtensions((function(t){var r,n,i;t.wasUsed&&((r=e._glTF).extensionsUsed||(r.extensionsUsed=[]),-1===e._glTF.extensionsUsed.indexOf(t.name)&&e._glTF.extensionsUsed.push(t.name),t.required&&((n=e._glTF).extensionsRequired||(n.extensionsRequired=[]),-1===e._glTF.extensionsRequired.indexOf(t.name)&&e._glTF.extensionsRequired.push(t.name)),(i=e._glTF).extensions||(i.extensions={}),t.onExporting&&t.onExporting())}))},e.prototype._loadExtensions=function(){for(var t=0,r=e._ExtensionNames;t<r.length;t++){var n=r[t],i=e._ExtensionFactories[n](this);this._extensions[n]=i}},e.prototype.dispose=function(){for(var e in this._extensions)this._extensions[e].dispose()},Object.defineProperty(e.prototype,"options",{get:function(){return this._options},enumerable:!1,configurable:!0}),e.RegisterExtension=function(t,r){e.UnregisterExtension(t)&&d.Tools.Warn("Extension with the name ".concat(t," already exists")),e._ExtensionFactories[t]=r,e._ExtensionNames.push(t)},e.UnregisterExtension=function(t){if(!e._ExtensionFactories[t])return!1;delete e._ExtensionFactories[t];var r=e._ExtensionNames.indexOf(t);return-1!==r&&e._ExtensionNames.splice(r,1),!0},e.prototype._generateJSON=function(e,t,r,n){var i,o,s=this,a={byteLength:t},u=t;return a.byteLength&&(this._glTF.buffers=[a]),this._nodes&&this._nodes.length&&(this._glTF.nodes=this._nodes),this._meshes&&this._meshes.length&&(this._glTF.meshes=this._meshes),this._scenes&&this._scenes.length&&(this._glTF.scenes=this._scenes,this._glTF.scene=0),this._cameras&&this._cameras.length&&(this._glTF.cameras=this._cameras),this._bufferViews&&this._bufferViews.length&&(this._glTF.bufferViews=this._bufferViews),this._accessors&&this._accessors.length&&(this._glTF.accessors=this._accessors),this._animations&&this._animations.length&&(this._glTF.animations=this._animations),this._materials&&this._materials.length&&(this._glTF.materials=this._materials),this._textures&&this._textures.length&&(this._glTF.textures=this._textures),this._samplers&&this._samplers.length&&(this._glTF.samplers=this._samplers),this._skins&&this._skins.length&&(this._glTF.skins=this._skins),this._images&&this._images.length&&(e?(this._glTF.images=[],this._images.forEach((function(e){e.uri&&(i=s._imageData[e.uri],s._orderedImageData.push(i),o=O(0,u,i.data.byteLength,void 0),u+=i.data.byteLength,s._bufferViews.push(o),e.bufferView=s._bufferViews.length-1,e.name=void 0,e.mimeType=i.mimeType,e.uri=void 0,s._glTF.images.push(e))})),a.byteLength=u):this._glTF.images=this._images),e||(a.uri=r+".bin"),n?JSON.stringify(this._glTF,null,2):JSON.stringify(this._glTF)},e.prototype.generateGLTFAsync=function(e){return m(this,void 0,void 0,(function(){var t,r,n,i,o,s,a;return _(this,(function(u){switch(u.label){case 0:return[4,this._generateBinaryAsync()];case 1:if(t=u.sent(),this._extensionsOnExporting(),r=this._generateJSON(!1,t.byteLength,e,!0),n=new Blob([t],{type:"application/octet-stream"}),i=e+".gltf",o=e+".bin",(s=new g).files[i]=r,s.files[o]=n,this._imageData)for(a in this._imageData)s.files[a]=new Blob([this._imageData[a].data],{type:this._imageData[a].mimeType});return[2,s]}}))}))},e.prototype._generateBinaryAsync=function(){return m(this,void 0,void 0,(function(){return _(this,(function(e){switch(e.label){case 0:return[4,this._exportSceneAsync()];case 1:return e.sent(),[2,this._dataWriter.getOutputData()]}}))}))},e.prototype._getPadding=function(e){var t=e%4;return 0===t?t:4-t},e.prototype.generateGLBAsync=function(e){return m(this,void 0,void 0,(function(){var t,r,n,i,o,s,a,u,l,c,f,h,p,d,x,m,y,T,v,b,A,w,E,M,R,C,V,F,S;return _(this,(function(_){switch(_.label){case 0:return[4,this._generateBinaryAsync()];case 1:for(t=_.sent(),this._extensionsOnExporting(),r=this._generateJSON(!0,t.byteLength),n=e+".glb",i=r.length,s=0,"undefined"!=typeof TextEncoder&&(a=new TextEncoder,o=a.encode(r),i=o.length),V=0;V<this._orderedImageData.length;++V)s+=this._orderedImageData[V].data.byteLength;if(u=this._getPadding(i),l=this._getPadding(t.byteLength),c=this._getPadding(s),f=28+i+u+t.byteLength+l+s+c,h=new ArrayBuffer(12),(p=new DataView(h)).setUint32(0,1179937895,!0),p.setUint32(4,2,!0),p.setUint32(8,f,!0),d=new ArrayBuffer(8+i+u),(x=new DataView(d)).setUint32(0,i+u,!0),x.setUint32(4,1313821514,!0),m=new Uint8Array(d,8),o)m.set(o);else for(y="_".charCodeAt(0),V=0;V<i;++V)(T=r.charCodeAt(V))!=r.codePointAt(V)?m[V]=y:m[V]=T;for(v=new Uint8Array(d,8+i),V=0;V<u;++V)v[V]=32;for(b=new ArrayBuffer(8),(A=new DataView(b)).setUint32(0,t.byteLength+l+s+c,!0),A.setUint32(4,5130562,!0),w=new ArrayBuffer(l),E=new Uint8Array(w),V=0;V<l;++V)E[V]=0;for(M=new ArrayBuffer(c),R=new Uint8Array(M),V=0;V<c;++V)R[V]=0;for(C=[h,d,b,t],V=0;V<this._orderedImageData.length;++V)C.push(this._orderedImageData[V].data);return C.push(w),C.push(M),F=new Blob(C,{type:"application/octet-stream"}),(S=new g).files[n]=F,[2,S]}}))}))},e.prototype._setNodeTransformation=function(e,t,r){if(t.getPivotPoint().equalsToFloats(0,0,0)||d.Tools.Warn("Pivot points are not supported in the glTF serializer"),!t.position.equalsToFloats(0,0,0)){var n=d.TmpVectors.Vector3[0].copyFrom(t.position);r&&W(n),e.translation=n.asArray()}t.scaling.equalsToFloats(1,1,1)||(e.scale=t.scaling.asArray());var i=d.Quaternion.FromEulerAngles(t.rotation.x,t.rotation.y,t.rotation.z);t.rotationQuaternion&&i.multiplyInPlace(t.rotationQuaternion),d.Quaternion.IsIdentity(i)||(r&&G(i),e.rotation=i.normalize().asArray())},e.prototype._setCameraTransformation=function(e,t,r,n){var i=d.TmpVectors.Vector3[0],o=d.TmpVectors.Quaternion[0];if(null!==n){var s=d.Matrix.Invert(n.getWorldMatrix());t.getWorldMatrix().multiply(s).decompose(void 0,o,i)}else t.getWorldMatrix().decompose(void 0,o,i);i.equalsToFloats(0,0,0)||(e.translation=i.asArray()),d.Quaternion.IsIdentity(o)||(e.rotation=o.asArray())},e.prototype._listAvailableCameras=function(){for(var e=0,t=this._babylonScene.cameras;e<t.length;e++){var r=t[e],n={type:r.mode===d.Camera.PERSPECTIVE_CAMERA?"perspective":"orthographic"};if(r.name&&(n.name=r.name),"perspective"===n.type)n.perspective={aspectRatio:r.getEngine().getAspectRatio(r),yfov:r.fovMode===d.Camera.FOVMODE_VERTICAL_FIXED?r.fov:r.fov*r.getEngine().getAspectRatio(r),znear:r.minZ,zfar:r.maxZ};else if("orthographic"===n.type){var i=r.orthoLeft&&r.orthoRight?.5*(r.orthoRight-r.orthoLeft):.5*r.getEngine().getRenderWidth(),o=r.orthoBottom&&r.orthoTop?.5*(r.orthoTop-r.orthoBottom):.5*r.getEngine().getRenderHeight();n.orthographic={xmag:i,ymag:o,znear:r.minZ,zfar:r.maxZ}}this._camerasMap.set(r,n)}},e.prototype._exportAndAssignCameras=function(){for(var e=0,t=Array.from(this._camerasMap.values());e<t.length;e++){var r=t[e],n=this._nodesCameraMap.get(r);if(void 0!==n){this._cameras.push(r);for(var i=0,o=n;i<o.length;i++)o[i].camera=this._cameras.length-1}}},e.prototype._listAvailableSkeletons=function(){for(var e=0,t=this._babylonScene.skeletons;e<t.length;e++){var r=t[e];r.bones.length<=0||this._skinMap.set(r,{joints:[]})}},e.prototype._exportAndAssignSkeletons=function(){for(var e,t=this,r=0,n=this._babylonScene.skeletons;r<n.length;r++){var i=n[r];if(!(i.bones.length<=0)){var o=this._skinMap.get(i);if(null!=o){for(var s={},a=[],u=-1,l=0;l<i.bones.length;++l)-1!==(c=null!==(e=(f=i.bones[l]).getIndex())&&void 0!==e?e:l)&&(s[c]=f,c>u&&(u=c));for(var c=0;c<=u;++c){var f=s[c];a.push(f.getAbsoluteInverseBindMatrix());var h=f.getTransformNode();if(null!==h){var p=this._nodeMap.get(h);h&&null!=p?o.joints.push(p):d.Tools.Warn("Exporting a bone without a linked transform node is currently unsupported")}else d.Tools.Warn("Exporting a bone without a linked transform node is currently unsupported")}var g=this._nodesSkinMap.get(o);if(o.joints.length>0&&void 0!==g){var x=64*a.length,m=O(0,this._dataWriter.byteOffset,x,void 0);this._bufferViews.push(m);var _=U(this._bufferViews.length-1,"MAT4",5126,a.length,null,null),y=this._accessors.push(_)-1;o.inverseBindMatrices=y,a.forEach((function(e){e.m.forEach((function(e){t._dataWriter.writeFloat32(e)}))})),this._skins.push(o);for(var T=0,v=g;T<v.length;T++)v[T].skin=this._skins.length-1}}}}},e.prototype._exportSceneAsync=function(){return m(this,void 0,void 0,(function(){var e,t,r,n,i,o,s,a,u,l,c,f,h,p,d,g,x,m,y,T,v,b;return _(this,(function(_){switch(_.label){case 0:for(e={nodes:[]},this._babylonScene.metadata&&(this._options.metadataSelector?e.extras=this._options.metadataSelector(this._babylonScene.metadata):this._babylonScene.metadata.gltf&&(e.extras=this._babylonScene.metadata.gltf.extras)),t=new Array,r=new Array,n=new Array,i=0,o=this._babylonScene.rootNodes;i<o.length;i++)s=o[i],this._options.removeNoopRootNodes&&!this._options.includeCoordinateSystemConversionNodes&&q(s,this._babylonScene.useRightHandedSystem)?n.push.apply(n,s.getChildren()):this._babylonScene.useRightHandedSystem?t.push(s):r.push(s);return this._listAvailableCameras(),this._listAvailableSkeletons(),a=new $(!0,!1),l=(u=(T=e.nodes).push).apply,c=[T],[4,this._exportNodesAsync(r,a)];case 1:return l.apply(u,c.concat([_.sent()])),f=new $(!1,!1),p=(h=(v=e.nodes).push).apply,d=[v],[4,this._exportNodesAsync(t,f)];case 2:return p.apply(h,d.concat([_.sent()])),g=new $(!1,!0),m=(x=(b=e.nodes).push).apply,y=[b],[4,this._exportNodesAsync(n,g)];case 3:return m.apply(x,y.concat([_.sent()])),e.nodes.length&&this._scenes.push(e),this._exportAndAssignCameras(),this._exportAndAssignSkeletons(),this._babylonScene.animationGroups.length&&Z._CreateNodeAndMorphAnimationFromAnimationGroups(this._babylonScene,this._animations,this._nodeMap,this._dataWriter,this._bufferViews,this._accessors,this._animationSampleRate,a.getNodesSet()),[2]}}))}))},e.prototype._shouldExportNode=function(e){var t=this._shouldExportNodeMap.get(e);return void 0===t&&(t=this._options.shouldExportNode(e),this._shouldExportNodeMap.set(e,t)),t},e.prototype._exportNodesAsync=function(e,t){return m(this,void 0,void 0,(function(){var r,n,i,o;return _(this,(function(s){switch(s.label){case 0:r=new Array,this._exportBuffers(e,t),n=0,i=e,s.label=1;case 1:return n<i.length?(o=i[n],[4,this._exportNodeAsync(o,r,t)]):[3,4];case 2:s.sent(),s.label=3;case 3:return n++,[3,1];case 4:return[2,r]}}))}))},e.prototype._collectBuffers=function(e,t,r,n,i){if(this._shouldExportNode(e)&&e instanceof d.Mesh&&e.geometry){var o=e.geometry.getVertexBuffers();if(o)for(var s in o){var a=o[s];i.setHasVertexColorAlpha(a,e.hasVertexAlpha);var u=a._buffer,l=t.get(u)||[];t.set(u,l),-1===l.indexOf(a)&&l.push(a);var c=r.get(a)||[];r.set(a,c),-1===c.indexOf(e)&&c.push(e)}var f=e.morphTargetManager;if(f)for(var h=0;h<f.numTargets;h++){var p=f.getTarget(h);c=n.get(p)||[],n.set(p,c),-1===c.indexOf(e)&&c.push(e)}}for(var g=0,x=e.getChildren();g<x.length;g++){var m=x[g];this._collectBuffers(m,t,r,n,i)}},e.prototype._exportBuffers=function(e,t){for(var r=new Map,n=new Map,i=new Map,o=0,s=e;o<s.length;o++){var a=s[o];this._collectBuffers(a,r,n,i,t)}for(var u=Array.from(r.keys()),l=function(e){var i=e.getData();if(!i)throw new Error("Buffer data is not available");var o=r.get(e);if(!o)return"continue";var s=o[0].byteStride;if(o.some((function(e){return e.byteStride!==s})))throw new Error("Vertex buffers pointing to the same buffer must have the same byte stride");for(var a=function(e){if(e instanceof Array){var t=new Float32Array(e);return new Uint8Array(t.buffer,t.byteOffset,t.byteLength)}return ArrayBuffer.isView(e)?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):new Uint8Array(e)}(i).slice(),u=function(e){var t=e.byteOffset,r=e.byteStride,i=e.type,o=e.normalized,s=e.getSize(),u=n.get(e),l=u.reduce((function(e,t){return t.getTotalVertices()>e?t.getTotalVertices():e}),-Number.MAX_VALUE);switch(e.getKind()){case d.VertexBuffer.NormalKind:case d.VertexBuffer.TangentKind:(0,d.EnumerateFloatValues)(a,t,r,s,i,l*s,o,(function(e){var t=1/Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);e[0]*=t,e[1]*=t,e[2]*=t}));break;case d.VertexBuffer.ColorKind:var f=u.filter((function(e){return e.material instanceof d.StandardMaterial||null==e.material})).length;if(0==f)break;if(f!=u.length){d.Logger.Warn("Not converting vertex color space, as buffer is shared by StandardMaterials and other material types. Results may look incorrect.");break}i==d.VertexBuffer.UNSIGNED_BYTE&&d.Logger.Warn("Converting uint8 vertex colors to linear space. Results may look incorrect.");var h=new d.Color3,p=new d.Color4,g=c._babylonScene.getEngine().useExactSrgbConversions;(0,d.EnumerateFloatValues)(a,t,r,s,i,l*s,o,(function(e){3===e.length?(h.fromArray(e,0),h.toLinearSpaceToRef(h,g),h.toArray(e,0)):(p.fromArray(e,0),p.toLinearSpaceToRef(p,g),p.toArray(e,0))}))}},l=0,f=o;l<f.length;l++)u(I=f[l]);if(t.convertToRightHanded){for(var h=0,p=o;h<p.length;h++)switch((I=p[h]).getKind()){case d.VertexBuffer.PositionKind:case d.VertexBuffer.NormalKind:case d.VertexBuffer.TangentKind:for(var g=0,x=n.get(I);g<x.length;g++){var m=x[g],_=I.byteOffset,y=I.byteStride,T=I.type,v=I.normalized,b=I.getSize();(0,d.EnumerateFloatValues)(a,_,y,b,T,m.getTotalVertices()*b,v,(function(e){e[0]=-e[0]}))}}t.convertedToRightHandedBuffers.set(e,a)}var A=c._dataWriter.byteOffset;c._dataWriter.writeUint8Array(a),c._bufferViews.push(O(0,A,a.length,s)),t.setVertexBufferView(e,c._bufferViews.length-1);for(var w=new Map,E=0,M=o;E<M.length;E++)switch((I=M[E]).getKind()){case d.VertexBuffer.MatricesIndicesKind:case d.VertexBuffer.MatricesIndicesExtraKind:if(I.type==d.VertexBuffer.FLOAT)for(var R=0,C=n.get(I);R<C.length;R++){m=C[R];var V=I.getFloatData(m.getTotalVertices());null!==V&&w.set(I,V)}}0!==w.size&&d.Logger.Warn("Joints conversion needed: some joints are stored as floats in Babylon but GLTF requires UNSIGNED BYTES. We will perform the conversion but this might lead to unused data in the buffer.");for(var F=0,S=Array.from(w.keys());F<S.length;F++){var I=S[F],N=w.get(I);if(N){var B=c._dataWriter.byteOffset;if(N.some((function(e){return e>=256}))){for(var P=new Uint16Array(N.length),U=0;U<N.length;U++)P[U]=N[U];c._dataWriter.writeUint16Array(P),c._bufferViews.push(O(0,B,P.byteLength,8))}else{for(P=new Uint8Array(N.length),U=0;U<N.length;U++)P[U]=N[U];c._dataWriter.writeUint8Array(P),c._bufferViews.push(O(0,B,P.byteLength,4))}t.setRemappedBufferView(e,I,c._bufferViews.length-1)}}},c=this,f=0,h=u;f<h.length;f++)l(h[f]);for(var p=0,g=Array.from(i.keys());p<g.length;p++){var x=g[p],m=i.get(x);if(m)for(var _=J(x,m[0],this._dataWriter,this._bufferViews,this._accessors,t.convertToRightHanded),y=0,T=m;y<T.length;y++){var v=T[y];t.bindMorphDataToMesh(v,_)}}},e.prototype._exportNodeAsync=function(e,t,r){return m(this,void 0,void 0,(function(){var n,i,o,s,a,u,l,c,f=this;return _(this,(function(h){switch(h.label){case 0:return void 0!==(n=this._nodeMap.get(e))?(t.includes(n)||t.push(n),[2]):[4,this._createNodeAsync(e,r)];case 1:(i=h.sent())&&(n=this._nodes.length,this._nodes.push(i),this._nodeMap.set(e,n),r.pushExportedNode(e),t.push(n),o={name:"runtime animations",channels:[],samplers:[]},s=[],this._babylonScene.animationGroups.length||(Z._CreateMorphTargetAnimationFromMorphTargetAnimations(e,o,s,this._nodeMap,this._nodes,this._dataWriter,this._bufferViews,this._accessors,this._animationSampleRate,r.convertToRightHanded,this._options.shouldExportAnimation),e.animations.length&&Z._CreateNodeAnimationFromNodeAnimations(e,o,s,this._nodeMap,this._nodes,this._dataWriter,this._bufferViews,this._accessors,this._animationSampleRate,r.convertToRightHanded,this._options.shouldExportAnimation)),o.channels.length&&o.samplers.length&&this._animations.push(o),s.forEach((function(e){e.channels.length&&e.samplers.length&&f._animations.push(e)}))),a=i?[]:t,u=0,l=e.getChildren(),h.label=2;case 2:return u<l.length?(c=l[u],[4,this._exportNodeAsync(c,a,r)]):[3,5];case 3:h.sent(),h.label=4;case 4:return u++,[3,2];case 5:return i&&a.length&&(i.children=a),[2]}}))}))},e.prototype._createNodeAsync=function(e,t){return m(this,void 0,void 0,(function(){var r,n,i,o,s,a,u,l,c,f,h;return _(this,(function(p){switch(p.label){case 0:return this._shouldExportNode(e)?(r={},e.name&&(r.name=e.name),e instanceof d.TransformNode?(this._setNodeTransformation(r,e,t.convertToRightHanded),e instanceof d.Mesh||e instanceof d.InstancedMesh?(n=e instanceof d.Mesh?e:e.sourceMesh).subMeshes&&n.subMeshes.length>0?(i=r,[4,this._exportMeshAsync(n,t)]):[3,2]:[3,3]):[3,3]):[2,null];case 1:i.mesh=p.sent(),p.label=2;case 2:e.skeleton&&void 0!==(o=this._skinMap.get(e.skeleton))&&(void 0===this._nodesSkinMap.get(o)&&this._nodesSkinMap.set(o,[]),null===(c=this._nodesSkinMap.get(o))||void 0===c||c.push(r)),p.label=3;case 3:if(e instanceof d.Camera&&(s=this._camerasMap.get(e))){if(void 0===this._nodesCameraMap.get(s)&&this._nodesCameraMap.set(s,[]),a=e.parent,this._setCameraTransformation(r,e,t.convertToRightHanded,a),a&&H(e,a)&&(u=this._nodeMap.get(a)))return l=this._nodes[u],null===(f=this._nodesCameraMap.get(s))||void 0===f||f.push(l),[2,null];t.convertToRightHanded&&(g=r,x=d.Vector3.FromArrayToRef(g.translation||[0,0,0],0,d.TmpVectors.Vector3[0]),m=d.Quaternion.FromArrayToRef(g.rotation||[0,0,0,1],0,d.TmpVectors.Quaternion[0]),x=W(x),m=G(m),x.equalsWithEpsilon(B,N)?delete g.translation:g.translation=x.asArray(),d.Quaternion.IsIdentity(m)?delete g.rotation:g.rotation=m.asArray(),function(e){if(e.rotation){var t=d.Quaternion.FromArrayToRef(e.rotation||[0,0,0,1],0,d.TmpVectors.Quaternion[1]);I.multiplyToRef(t,t),e.rotation=t.asArray()}}(r)),null===(h=this._nodesCameraMap.get(s))||void 0===h||h.push(r)}return[4,this._extensionsPostExportNodeAsync("exportNodeAsync",r,e,this._nodeMap,t.convertToRightHanded)];case 4:return p.sent()?[2,r]:(d.Logger.Warn("Not exporting node ".concat(e.name)),[2,null])}var g,x,m}))}))},e.prototype._exportIndices=function(e,t,r,n,i,o,s,a){var u=function(e,t){return e?e instanceof Array?e.some((function(e){return e>=65536})):4===e.BYTES_PER_ELEMENT:t>=65536}(e,r),l=e;a.mode=D(i);var c=o!==d.Material.CounterClockWiseSideOrientation,f=!s.wasAddedByNoopNode&&c,h=function(e){switch(e){case d.Material.TriangleFillMode:case d.Material.TriangleStripDrawMode:case d.Material.TriangleFanDrawMode:return!0}return!1}(i)&&f;if(h){if(i===d.Material.TriangleStripDrawMode||i===d.Material.TriangleFanDrawMode)throw new Error("Triangle strip/fan fill mode is not implemented");a.mode=D(i);var p=u?new Uint32Array(r):new Uint16Array(r);if(e)for(var g=0;g+2<r;g+=3)p[g]=e[t+g]+n,p[g+1]=e[t+g+2]+n,p[g+2]=e[t+g+1]+n;else for(g=0;g+2<r;g+=3)p[g]=g,p[g+1]=g+2,p[g+2]=g+1;l=p}else if(e&&0!==n){for(p=u?new Uint32Array(r):new Uint16Array(r),g=0;g<r;g++)p[g]=e[t+g]+n;l=p}if(l){var x=s.getIndicesAccessor(e,t,r,n,h);if(void 0===x){var m=this._dataWriter.byteOffset,_=function(e,t,r,n){if(e instanceof Array){var i=e.slice(t,t+r);return e=n?new Uint32Array(i):new Uint16Array(i),new Uint8Array(e.buffer,e.byteOffset,e.byteLength)}return ArrayBuffer.isView(e)?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):new Uint8Array(e)}(l,t,r,u);this._dataWriter.writeUint8Array(_),this._bufferViews.push(O(0,m,_.length));var y=this._bufferViews.length-1,T=u?5125:5123;this._accessors.push(U(y,"SCALAR",T,r,0)),x=this._accessors.length-1,s.setIndicesAccessor(e,t,r,n,h,x)}a.indices=x}},e.prototype._exportVertexBuffer=function(e,t,r,n,i,o){var s=e.getKind();if(function(e){switch(e){case d.VertexBuffer.PositionKind:case d.VertexBuffer.NormalKind:case d.VertexBuffer.TangentKind:case d.VertexBuffer.ColorKind:case d.VertexBuffer.MatricesIndicesKind:case d.VertexBuffer.MatricesIndicesExtraKind:case d.VertexBuffer.MatricesWeightsKind:case d.VertexBuffer.MatricesWeightsExtraKind:case d.VertexBuffer.UVKind:case d.VertexBuffer.UV2Kind:case d.VertexBuffer.UV3Kind:case d.VertexBuffer.UV4Kind:case d.VertexBuffer.UV5Kind:case d.VertexBuffer.UV6Kind:return!0}return!1}(s)&&(!s.startsWith("uv")||this._options.exportUnusedUVs||t&&this._materialNeedsUVsSet.has(t))){var a=i.getVertexAccessor(e,r,n);if(void 0===a){var u,l=i.convertedToRightHandedBuffers.get(e._buffer)||e._buffer.getData(),c=s===d.VertexBuffer.PositionKind?function(e,t,r,n){var i=t.byteOffset,o=t.byteStride,s=t.type,a=t.normalized,u=t.getSize(),l=new Array(u).fill(1/0),c=new Array(u).fill(-1/0);return(0,d.EnumerateFloatValues)(e,i+r*o,o,u,s,n*u,a,(function(e){for(var t=0;t<u;t++)l[t]=Math.min(l[t],e[t]),c[t]=Math.max(c[t],e[t])})),{min:l,max:c}}(l,e,r,n):null;if(s!==d.VertexBuffer.MatricesIndicesKind&&s!==d.VertexBuffer.MatricesIndicesExtraKind||e.type!==d.VertexBuffer.FLOAT)u=i.getVertexBufferView(e._buffer),f=e.byteOffset+r*e.byteStride,this._accessors.push(U(u,L(s,i.hasVertexColorAlpha(e)),e.type,n,f,c,e.normalized)),a=this._accessors.length-1,i.setVertexAccessor(e,r,n,a),o.attributes[k(s)]=a;else if(void 0!==(u=i.getRemappedBufferView(e._buffer,e))){var f=e.byteOffset+r*e.byteStride;this._accessors.push(U(u,L(s,i.hasVertexColorAlpha(e)),d.VertexBuffer.UNSIGNED_BYTE,n,f,c)),a=this._accessors.length-1,i.setVertexAccessor(e,r,n,a),o.attributes[k(s)]=a}}else o.attributes[k(s)]=a}},e.prototype._exportMaterialAsync=function(e,t,r,n){return m(this,void 0,void 0,(function(){var i,o;return _(this,(function(s){switch(s.label){case 0:return void 0!==(i=this._materialMap.get(e))?[3,6]:(o=t&&Object.keys(t).some((function(e){return e.startsWith("uv")})),(e=e instanceof d.MultiMaterial?e.subMaterials[r.materialIndex]:e)instanceof d.PBRMaterial?[4,this._materialExporter.exportPBRMaterialAsync(e,"image/png",o)]:[3,2]);case 1:return i=s.sent(),[3,5];case 2:return e instanceof d.StandardMaterial?[4,this._materialExporter.exportStandardMaterialAsync(e,"image/png",o)]:[3,4];case 3:return i=s.sent(),[3,5];case 4:return d.Logger.Warn("Unsupported material '".concat(e.name,"' with type ").concat(e.getClassName())),[2];case 5:this._materialMap.set(e,i),s.label=6;case 6:return n.material=i,[2]}}))}))},e.prototype._exportMeshAsync=function(e,t){return m(this,void 0,void 0,(function(){var r,n,i,o,s,a,u,l,c,f,h,p,g,x,m,T,v,b,A,w,E,M,R,C,V,F;return _(this,(function(_){switch(_.label){case 0:if(void 0!==(r=t.getMesh(e)))return[2,r];if(n={primitives:[]},r=this._meshes.length,this._meshes.push(n),t.setMesh(e,r),i=e.isUnIndexed?null:e.getIndices(),o=null===(V=e.geometry)||void 0===V?void 0:V.getVertexBuffers(),s=t.getMorphTargetsFromMesh(e),a=!1,e instanceof d.LinesMesh&&(a=!0),u=e.subMeshes,!(o&&u&&u.length>0))return[3,6];l=0,c=u,_.label=1;case 1:return l<c.length?(f=c[l],h={attributes:{}},p=f.getMaterial()||this._babylonScene.defaultMaterial,a?(g={name:p.name},(!(x=e).color.equals(d.Color3.White())||x.alpha<1)&&(g.pbrMetallicRoughness={baseColorFactor:y(y([],x.color.asArray(),!0),[x.alpha],!1)}),this._materials.push(g),h.material=this._materials.length-1,[3,4]):[3,2]):[3,6];case 2:return[4,this._exportMaterialAsync(p,o,f,h)];case 3:_.sent(),_.label=4;case 4:for(m=a?d.Material.LineListDrawMode:null!==(F=e.overrideRenderingFillMode)&&void 0!==F?F:p.fillMode,T=p._getEffectiveOrientation(e),this._exportIndices(i,f.indexStart,f.indexCount,-f.verticesStart,m,T,t,h),v=0,b=Object.values(o);v<b.length;v++)A=b[v],this._exportVertexBuffer(A,p,f.verticesStart,f.verticesCount,t,h);if(n.primitives.push(h),s)for(h.targets=[],w=0,E=s;w<E.length;w++)C=E[w],h.targets.push(C.attributes);_.label=5;case 5:return l++,[3,1];case 6:if(s)for(n.weights=[],n.extras||(n.extras={}),n.extras.targetNames=[],M=0,R=s;M<R.length;M++)C=R[M],n.weights.push(C.influence),n.extras.targetNames.push(C.name);return[2,r]}}))}))},e._ExtensionNames=new Array,e._ExtensionFactories={},e}(),te=function(){function e(){}return e.GLTFAsync=function(e,t,r){return m(this,void 0,void 0,(function(){var n,i;return _(this,(function(o){switch(o.label){case 0:return r&&r.exportWithoutWaitingForScene?[3,2]:[4,e.whenReadyAsync()];case 1:o.sent(),o.label=2;case 2:return[4,(n=new ee(e,r)).generateGLTFAsync(t.replace(/\.[^/.]+$/,""))];case 3:return i=o.sent(),n.dispose(),[2,i]}}))}))},e.GLBAsync=function(e,t,r){return m(this,void 0,void 0,(function(){var n,i;return _(this,(function(o){switch(o.label){case 0:return r&&r.exportWithoutWaitingForScene?[3,2]:[4,e.whenReadyAsync()];case 1:o.sent(),o.label=2;case 2:return[4,(n=new ee(e,r)).generateGLBAsync(t.replace(/\.[^/.]+$/,""))];case 3:return i=o.sent(),n.dispose(),[2,i]}}))}))},e}(),re="EXT_mesh_gpu_instancing",ne=function(){function e(e){this.name=re,this.enabled=!0,this.required=!1,this._wasUsed=!1,this._exporter=e}return e.prototype.dispose=function(){},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.postExportNodeAsync=function(e,t,r,n,i,o){var s=this;return new Promise((function(e){if(t&&r instanceof d.Mesh&&r.hasThinInstances&&s._exporter){s._wasUsed=!0;for(var n=d.Vector3.Zero(),a=d.Quaternion.Identity(),u=d.Vector3.One(),l=r.thinInstanceGetWorldMatrices(),c=d.TmpVectors.Vector3[2],f=d.TmpVectors.Quaternion[1],h=d.TmpVectors.Vector3[3],p=!1,g=!1,x=!1,m=new Float32Array(3*r.thinInstanceCount),_=new Float32Array(4*r.thinInstanceCount),y=new Float32Array(3*r.thinInstanceCount),T=0,v=0,b=l;v<b.length;v++)b[v].decompose(h,f,c),i&&(W(c),G(f)),m.set(c.asArray(),3*T),_.set(f.normalize().asArray(),4*T),y.set(h.asArray(),3*T),p=p||!c.equalsWithEpsilon(n),g=g||!f.equalsWithEpsilon(a),x=x||!h.equalsWithEpsilon(u),T++;var A={attributes:{}};p&&(A.attributes.TRANSLATION=s._buildAccessor(m,"VEC3",r.thinInstanceCount,o,5126)),g&&(A.attributes.ROTATION=s._buildAccessor(_,"VEC4",r.thinInstanceCount,o,5126)),x&&(A.attributes.SCALE=s._buildAccessor(y,"VEC3",r.thinInstanceCount,o,5126)),t.extensions=t.extensions||{},t.extensions[re]=A}e(t)}))},e.prototype._buildAccessor=function(e,t,r,n,i){var o=n.byteOffset;switch(i){case 5126:for(var s=0;s!=e.length;s++)n.writeFloat32(e[s]);break;case 5120:for(s=0;s!=e.length;s++)n.writeInt8(127*e[s]);break;case 5122:for(s=0;s!=e.length;s++)n.writeInt16(32767*e[s])}var a={buffer:0,byteOffset:o,byteLength:e.length*d.VertexBuffer.GetTypeByteLength(i)},u=this._exporter._bufferViews.length;this._exporter._bufferViews.push(a);var l=this._exporter._accessors.length,c={bufferView:u,componentType:i,count:r,type:t,normalized:5120==i||5122==i};return this._exporter._accessors.push(c),l},e}();ee.RegisterExtension(re,(function(e){return new ne(e)}));var ie="KHR_lights_punctual",oe={name:"",color:[1,1,1],intensity:1,range:Number.MAX_VALUE},se={innerConeAngle:0,outerConeAngle:Math.PI/4},ae=d.Vector3.Backward(),ue=function(){function e(e){this.name=ie,this.enabled=!0,this.required=!1,this._exporter=e}return e.prototype.dispose=function(){this._lights=null},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return!!this._lights},enumerable:!1,configurable:!0}),e.prototype.onExporting=function(){this._exporter._glTF.extensions[ie]=this._lights},e.prototype.postExportNodeAsync=function(e,t,r,n,i){var o=this;return new Promise((function(s){if(r instanceof d.ShadowLight){var a=r.getTypeID()==d.Light.LIGHTTYPEID_POINTLIGHT?"point":r.getTypeID()==d.Light.LIGHTTYPEID_DIRECTIONALLIGHT?"directional":r.getTypeID()==d.Light.LIGHTTYPEID_SPOTLIGHT?"spot":null;if(!a)return d.Logger.Warn("".concat(e,": Light ").concat(r.name," is not supported in ").concat(ie)),void s(t);if(r.falloffType!==d.Light.FALLOFF_GLTF&&d.Logger.Warn("".concat(e,": Light falloff for ").concat(r.name," does not match the ").concat(ie," specification!")),!r.position.equalsToFloats(0,0,0)){var u=d.TmpVectors.Vector3[0].copyFrom(r.position);i&&W(u),t.translation=u.asArray()}if("point"!==a){var l=r.direction.normalizeToRef(d.TmpVectors.Vector3[0]);i&&W(l);var c=Math.acos(d.Vector3.Dot(ae,l)),f=d.Vector3.Cross(ae,l),h=d.Quaternion.RotationAxisToRef(f,c,d.TmpVectors.Quaternion[0]);d.Quaternion.IsIdentity(h)||(t.rotation=h.asArray())}var p={type:a,name:r.name,color:r.diffuse.asArray(),intensity:r.intensity,range:r.range};if(z(p,oe),"spot"===a){var g=r;p.spot={innerConeAngle:g.innerAngle/2,outerConeAngle:g.angle/2},z(p.spot,se)}o._lights||(o._lights={lights:[]}),o._lights.lights.push(p);var x={light:o._lights.lights.length-1},m=r.parent;if(m&&H(r,m)){var _=n.get(m);if(_){var y=o._exporter._nodes[_];return function(e,t){var r=d.Vector3.FromArrayToRef(t.translation||[0,0,0],0,d.TmpVectors.Vector3[0]),n=d.Quaternion.FromArrayToRef(t.rotation||[0,0,0,1],0,d.TmpVectors.Quaternion[0]),i=d.Vector3.FromArrayToRef(t.scale||[1,1,1],0,d.TmpVectors.Vector3[1]),o=d.Matrix.ComposeToRef(i,n,r,d.TmpVectors.Matrix[0]),s=d.Vector3.FromArrayToRef(e.translation||[0,0,0],0,d.TmpVectors.Vector3[2]),a=d.Quaternion.FromArrayToRef(e.rotation||[0,0,0,1],0,d.TmpVectors.Quaternion[1]),u=d.Vector3.FromArrayToRef(e.scale||[1,1,1],0,d.TmpVectors.Vector3[1]),l=d.Matrix.ComposeToRef(u,a,s,d.TmpVectors.Matrix[1]);o.multiplyToRef(l,l),l.decompose(i,n,r),r.equalsWithEpsilon(B,N)?delete t.translation:t.translation=r.asArray(),d.Quaternion.IsIdentity(n)?delete t.rotation:t.rotation=n.asArray(),i.equalsWithEpsilon(P,N)?delete t.scale:t.scale=i.asArray()}(t,y),y.extensions||(y.extensions={}),y.extensions[ie]=x,void s(null)}}t.extensions||(t.extensions={}),t.extensions[ie]=x,s(t)}else s(t)}))},e}();ee.RegisterExtension(ie,(function(e){return new ue(e)}));var le="KHR_materials_anisotropy",ce=function(){function e(e){this.name=le,this.enabled=!0,this.required=!1,this._wasUsed=!1,this._exporter=e}return e.prototype.dispose=function(){},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.postExportMaterialAdditionalTextures=function(e,t,r){var n=[];return r instanceof d.PBRBaseMaterial&&r.anisotropy.isEnabled&&!r.anisotropy.legacy?(r.anisotropy.texture&&n.push(r.anisotropy.texture),n):[]},e.prototype.postExportMaterialAsync=function(e,t,r){var n=this;return new Promise((function(e){if(r instanceof d.PBRBaseMaterial){if(!r.anisotropy.isEnabled||r.anisotropy.legacy)return void e(t);n._wasUsed=!0,t.extensions=t.extensions||{};var i=n._exporter._materialExporter.getTextureInfo(r.anisotropy.texture),o={anisotropyStrength:r.anisotropy.intensity,anisotropyRotation:r.anisotropy.angle,anisotropyTexture:null!=i?i:void 0};null!==o.anisotropyTexture&&n._exporter._materialNeedsUVsSet.add(r),t.extensions[le]=o}e(t)}))},e}();ee.RegisterExtension(le,(function(e){return new ce(e)}));var fe="KHR_materials_clearcoat",he=function(){function e(e){this.name=fe,this.enabled=!0,this.required=!1,this._wasUsed=!1,this._exporter=e}return e.prototype.dispose=function(){},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.postExportMaterialAdditionalTextures=function(e,t,r){var n=[];return r instanceof d.PBRBaseMaterial&&r.clearCoat.isEnabled?(r.clearCoat.texture&&n.push(r.clearCoat.texture),!r.clearCoat.useRoughnessFromMainTexture&&r.clearCoat.textureRoughness&&n.push(r.clearCoat.textureRoughness),r.clearCoat.bumpTexture&&n.push(r.clearCoat.bumpTexture),n):[]},e.prototype.postExportMaterialAsync=function(e,t,r){var n=this;return new Promise((function(e){if(r instanceof d.PBRBaseMaterial){if(!r.clearCoat.isEnabled)return void e(t);n._wasUsed=!0,t.extensions=t.extensions||{};var i,o=n._exporter._materialExporter.getTextureInfo(r.clearCoat.texture);i=r.clearCoat.useRoughnessFromMainTexture?n._exporter._materialExporter.getTextureInfo(r.clearCoat.texture):n._exporter._materialExporter.getTextureInfo(r.clearCoat.textureRoughness),r.clearCoat.isTintEnabled&&d.Tools.Warn("Clear Color tint is not supported for glTF export. Ignoring for: ".concat(r.name)),r.clearCoat.remapF0OnInterfaceChange&&d.Tools.Warn("Clear Color F0 remapping is not supported for glTF export. Ignoring for: ".concat(r.name));var s=n._exporter._materialExporter.getTextureInfo(r.clearCoat.bumpTexture),a={clearcoatFactor:r.clearCoat.intensity,clearcoatTexture:null!=o?o:void 0,clearcoatRoughnessFactor:r.clearCoat.roughness,clearcoatRoughnessTexture:null!=i?i:void 0,clearcoatNormalTexture:null!=s?s:void 0};null===a.clearcoatTexture&&null===a.clearcoatRoughnessTexture&&null===a.clearcoatRoughnessTexture||n._exporter._materialNeedsUVsSet.add(r),t.extensions[fe]=a}e(t)}))},e}();ee.RegisterExtension(fe,(function(e){return new he(e)}));var pe="KHR_materials_diffuse_transmission",de=function(){function e(e){this.name=pe,this.enabled=!0,this.required=!1,this._wasUsed=!1,this._exporter=e}return e.prototype.dispose=function(){},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.postExportMaterialAdditionalTextures=function(e,t,r){var n=[];return r instanceof d.PBRMaterial&&this._isExtensionEnabled(r)?(r.subSurface.thicknessTexture&&n.push(r.subSurface.thicknessTexture),n):n},e.prototype._isExtensionEnabled=function(e){if(e.unlit)return!1;var t=e.subSurface;return!!t.isTranslucencyEnabled&&!e.unlit&&!t.useAlbedoToTintTranslucency&&t.useGltfStyleTextures&&1===t.volumeIndexOfRefraction&&0===t.minimumThickness&&0===t.maximumThickness},e.prototype._hasTexturesExtension=function(e){return null!=e.subSurface.translucencyIntensityTexture||null!=e.subSurface.translucencyColorTexture},e.prototype.postExportMaterialAsync=function(e,t,r){var n=this;return new Promise((function(e){var i,o;if(r instanceof d.PBRMaterial&&n._isExtensionEnabled(r)){n._wasUsed=!0;var s=r.subSurface,a={diffuseTransmissionFactor:1==s.translucencyIntensity?void 0:s.translucencyIntensity,diffuseTransmissionTexture:null!==(i=n._exporter._materialExporter.getTextureInfo(s.translucencyIntensityTexture))&&void 0!==i?i:void 0,diffuseTransmissionColorFactor:!s.translucencyColor||s.translucencyColor.equalsFloats(1,1,1)?void 0:s.translucencyColor.asArray(),diffuseTransmissionColorTexture:null!==(o=n._exporter._materialExporter.getTextureInfo(s.translucencyColorTexture))&&void 0!==o?o:void 0};n._hasTexturesExtension(r)&&n._exporter._materialNeedsUVsSet.add(r),t.extensions=t.extensions||{},t.extensions[pe]=a}e(t)}))},e}();ee.RegisterExtension(pe,(function(e){return new de(e)}));var ge="KHR_materials_dispersion",xe=function(){function e(){this.name=ge,this.enabled=!0,this.required=!1,this._wasUsed=!1}return e.prototype.dispose=function(){},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype._isExtensionEnabled=function(e){if(e.unlit)return!1;var t=e.subSurface;return!(!t.isRefractionEnabled&&!t.isDispersionEnabled)},e.prototype.postExportMaterialAsync=function(e,t,r){var n=this;return new Promise((function(e){if(r instanceof d.PBRMaterial&&n._isExtensionEnabled(r)){n._wasUsed=!0;var i={dispersion:r.subSurface.dispersion};t.extensions=t.extensions||{},t.extensions[ge]=i}e(t)}))},e}();ee.RegisterExtension(ge,(function(){return new xe}));var me="KHR_materials_emissive_strength",_e=function(){function e(){this.name=me,this.enabled=!0,this.required=!1,this._wasUsed=!1}return e.prototype.dispose=function(){},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.postExportMaterialAsync=function(e,t,r){var n=this;return new Promise((function(e){if(!(r instanceof d.PBRMaterial))return e(t);var i=r.emissiveColor.asArray(),o=Math.max.apply(Math,i);if(o>1){n._wasUsed=!0,t.extensions||(t.extensions={});var s={emissiveStrength:o},a=r.emissiveColor.scale(1/s.emissiveStrength);t.emissiveFactor=a.asArray(),t.extensions[me]=s}return e(t)}))},e}();ee.RegisterExtension(me,(function(e){return new _e}));var ye="KHR_materials_ior",Te=function(){function e(){this.name=ye,this.enabled=!0,this.required=!1,this._wasUsed=!1}return e.prototype.dispose=function(){},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype._isExtensionEnabled=function(e){return!e.unlit&&null!=e.indexOfRefraction&&1.5!=e.indexOfRefraction},e.prototype.postExportMaterialAsync=function(e,t,r){var n=this;return new Promise((function(e){if(r instanceof d.PBRMaterial&&n._isExtensionEnabled(r)){n._wasUsed=!0;var i={ior:r.indexOfRefraction};t.extensions=t.extensions||{},t.extensions[ye]=i}e(t)}))},e}();ee.RegisterExtension(ye,(function(e){return new Te}));var ve="KHR_materials_iridescence",be=function(){function e(e){this.name=ve,this.enabled=!0,this.required=!1,this._wasUsed=!1,this._exporter=e}return e.prototype.dispose=function(){},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.postExportMaterialAdditionalTextures=function(e,t,r){var n=[];return r instanceof d.PBRBaseMaterial&&r.iridescence.isEnabled?(r.iridescence.texture&&n.push(r.iridescence.texture),r.iridescence.thicknessTexture&&r.iridescence.thicknessTexture!==r.iridescence.texture&&n.push(r.iridescence.thicknessTexture),n):[]},e.prototype.postExportMaterialAsync=function(e,t,r){var n=this;return new Promise((function(e){if(r instanceof d.PBRBaseMaterial){if(!r.iridescence.isEnabled)return void e(t);n._wasUsed=!0,t.extensions=t.extensions||{};var i=n._exporter._materialExporter.getTextureInfo(r.iridescence.texture),o=n._exporter._materialExporter.getTextureInfo(r.iridescence.thicknessTexture),s={iridescenceFactor:r.iridescence.intensity,iridescenceIor:r.iridescence.indexOfRefraction,iridescenceThicknessMinimum:r.iridescence.minimumThickness,iridescenceThicknessMaximum:r.iridescence.maximumThickness,iridescenceTexture:null!=i?i:void 0,iridescenceThicknessTexture:null!=o?o:void 0};null===s.iridescenceTexture&&null===s.iridescenceThicknessTexture||n._exporter._materialNeedsUVsSet.add(r),t.extensions[ve]=s}e(t)}))},e}();ee.RegisterExtension(ve,(function(e){return new be(e)}));var Ae="KHR_materials_sheen",we=function(){function e(e){this.name=Ae,this.enabled=!0,this.required=!1,this._wasUsed=!1,this._exporter=e}return e.prototype.dispose=function(){},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.postExportMaterialAdditionalTextures=function(e,t,r){return r instanceof d.PBRMaterial&&r.sheen.isEnabled&&r.sheen.texture?[r.sheen.texture]:[]},e.prototype.postExportMaterialAsync=function(e,t,r){var n=this;return new Promise((function(e){var i,o,s,a;if(r instanceof d.PBRMaterial){if(!r.sheen.isEnabled)return void e(t);n._wasUsed=!0,null==t.extensions&&(t.extensions={});var u={sheenColorFactor:r.sheen.color.asArray(),sheenRoughnessFactor:null!==(i=r.sheen.roughness)&&void 0!==i?i:0};null===u.sheenColorTexture&&null===u.sheenRoughnessTexture||n._exporter._materialNeedsUVsSet.add(r),r.sheen.texture&&(u.sheenColorTexture=null!==(o=n._exporter._materialExporter.getTextureInfo(r.sheen.texture))&&void 0!==o?o:void 0),r.sheen.textureRoughness&&!r.sheen.useRoughnessFromMainTexture?u.sheenRoughnessTexture=null!==(s=n._exporter._materialExporter.getTextureInfo(r.sheen.textureRoughness))&&void 0!==s?s:void 0:r.sheen.texture&&r.sheen.useRoughnessFromMainTexture&&(u.sheenRoughnessTexture=null!==(a=n._exporter._materialExporter.getTextureInfo(r.sheen.texture))&&void 0!==a?a:void 0),t.extensions[Ae]=u}e(t)}))},e}();ee.RegisterExtension(Ae,(function(e){return new we(e)}));var Ee="KHR_materials_specular",Me=function(){function e(e){this.name=Ee,this.enabled=!0,this.required=!1,this._wasUsed=!1,this._exporter=e}return e.prototype.dispose=function(){},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.postExportMaterialAdditionalTextures=function(e,t,r){var n=[];return r instanceof d.PBRMaterial&&this._isExtensionEnabled(r)?(r.metallicReflectanceTexture&&n.push(r.metallicReflectanceTexture),r.reflectanceTexture&&n.push(r.reflectanceTexture),n):n},e.prototype._isExtensionEnabled=function(e){return!e.unlit&&(null!=e.metallicF0Factor&&1!=e.metallicF0Factor||null!=e.metallicReflectanceColor&&!e.metallicReflectanceColor.equalsFloats(1,1,1)||this._hasTexturesExtension(e))},e.prototype._hasTexturesExtension=function(e){return null!=e.metallicReflectanceTexture||null!=e.reflectanceTexture},e.prototype.postExportMaterialAsync=function(e,t,r){var n=this;return new Promise((function(e){var i,o;if(r instanceof d.PBRMaterial&&n._isExtensionEnabled(r)){n._wasUsed=!0,t.extensions=t.extensions||{};var s=null!==(i=n._exporter._materialExporter.getTextureInfo(r.metallicReflectanceTexture))&&void 0!==i?i:void 0,a=null!==(o=n._exporter._materialExporter.getTextureInfo(r.reflectanceTexture))&&void 0!==o?o:void 0,u={specularFactor:1==r.metallicF0Factor?void 0:r.metallicF0Factor,specularTexture:s,specularColorFactor:r.metallicReflectanceColor.equalsFloats(1,1,1)?void 0:r.metallicReflectanceColor.asArray(),specularColorTexture:a};n._hasTexturesExtension(r)&&n._exporter._materialNeedsUVsSet.add(r),t.extensions[Ee]=u}e(t)}))},e}();ee.RegisterExtension(Ee,(function(e){return new Me(e)}));var Re="KHR_materials_transmission",Ce=function(){function e(e){this.name=Re,this.enabled=!0,this.required=!1,this._wasUsed=!1,this._exporter=e}return e.prototype.dispose=function(){},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.postExportMaterialAdditionalTextures=function(e,t,r){var n=[];return r instanceof d.PBRMaterial&&this._isExtensionEnabled(r)?(r.subSurface.thicknessTexture&&n.push(r.subSurface.thicknessTexture),n):n},e.prototype._isExtensionEnabled=function(e){if(e.unlit)return!1;var t=e.subSurface;return t.isRefractionEnabled&&null!=t.refractionIntensity&&0!=t.refractionIntensity||this._hasTexturesExtension(e)},e.prototype._hasTexturesExtension=function(e){return null!=e.subSurface.refractionIntensityTexture},e.prototype.postExportMaterialAsync=function(e,t,r){return m(this,void 0,void 0,(function(){var n,i,o,s;return _(this,(function(a){switch(a.label){case 0:return r instanceof d.PBRMaterial&&this._isExtensionEnabled(r)?(this._wasUsed=!0,n=r.subSurface,i=0===n.refractionIntensity?void 0:n.refractionIntensity,o={transmissionFactor:i},this._hasTexturesExtension(r)&&this._exporter._materialNeedsUVsSet.add(r),n.refractionIntensityTexture?n.useGltfStyleTextures?[4,this._exporter._materialExporter.exportTextureAsync(n.refractionIntensityTexture,"image/png")]:[3,2]:[3,3]):[3,4];case 1:return(s=a.sent())&&(o.transmissionTexture=s),[3,3];case 2:d.Logger.Warn("".concat(e,": Exporting a subsurface refraction intensity texture without `useGltfStyleTextures` is not supported")),a.label=3;case 3:t.extensions||(t.extensions={}),t.extensions[Re]=o,a.label=4;case 4:return[2,t]}}))}))},e}();ee.RegisterExtension(Re,(function(e){return new Ce(e)}));var Ve="KHR_materials_unlit",Fe=function(){function e(){this.name=Ve,this.enabled=!0,this.required=!1,this._wasUsed=!1}return Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.dispose=function(){},e.prototype.postExportMaterialAsync=function(e,t,r){var n=this;return new Promise((function(e){var i=!1;r instanceof d.PBRMaterial?i=r.unlit:r instanceof d.StandardMaterial&&(i=r.disableLighting),i&&(n._wasUsed=!0,null==t.extensions&&(t.extensions={}),t.extensions[Ve]={}),e(t)}))},e}();ee.RegisterExtension(Ve,(function(){return new Fe}));var Se="KHR_materials_volume",Ie=function(){function e(e){this.name=Se,this.enabled=!0,this.required=!1,this._wasUsed=!1,this._exporter=e}return e.prototype.dispose=function(){},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.postExportMaterialAdditionalTextures=function(e,t,r){var n=[];return r instanceof d.PBRMaterial&&this._isExtensionEnabled(r)?(r.subSurface.thicknessTexture&&n.push(r.subSurface.thicknessTexture),n):n},e.prototype._isExtensionEnabled=function(e){if(e.unlit)return!1;var t=e.subSurface;return!(!t.isRefractionEnabled&&!t.isTranslucencyEnabled)&&(null!=t.maximumThickness&&0!=t.maximumThickness||null!=t.tintColorAtDistance&&t.tintColorAtDistance!=Number.POSITIVE_INFINITY||null!=t.tintColor&&t.tintColor!=d.Color3.White()||this._hasTexturesExtension(e))},e.prototype._hasTexturesExtension=function(e){return null!=e.subSurface.thicknessTexture},e.prototype.postExportMaterialAsync=function(e,t,r){var n=this;return new Promise((function(e){var i;if(r instanceof d.PBRMaterial&&n._isExtensionEnabled(r)){n._wasUsed=!0;var o=r.subSurface,s={thicknessFactor:0==o.maximumThickness?void 0:o.maximumThickness,thicknessTexture:null!==(i=n._exporter._materialExporter.getTextureInfo(o.thicknessTexture))&&void 0!==i?i:void 0,attenuationDistance:o.tintColorAtDistance==Number.POSITIVE_INFINITY?void 0:o.tintColorAtDistance,attenuationColor:o.tintColor.equalsFloats(1,1,1)?void 0:o.tintColor.asArray()};n._hasTexturesExtension(r)&&n._exporter._materialNeedsUVsSet.add(r),t.extensions=t.extensions||{},t.extensions[Se]=s}e(t)}))},e}();ee.RegisterExtension(Se,(function(e){return new Ie(e)}));var Ne="KHR_texture_transform",Be=function(){function e(){this.name=Ne,this.enabled=!0,this.required=!1,this._wasUsed=!1}return e.prototype.dispose=function(){},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.postExportTexture=function(e,t,r){if(r&&0===r.uAng&&0===r.vAng){var n={},i=!1;if(0===r.uOffset&&0===r.vOffset||(n.offset=[r.uOffset,r.vOffset],i=!0),1===r.uScale&&1===r.vScale||(n.scale=[r.uScale,r.vScale],i=!0),0!==r.wAng&&(n.rotation=-r.wAng,i=!0,0===r.uRotationCenter&&0===r.vRotationCenter||(n.offset=function(e){var t=e.uOffset,r=e.vOffset,n=e.uRotationCenter,i=e.vRotationCenter,o=e.wAng,s=Math.cos(-o),a=Math.sin(-o);return[t+(n*(1-s)-i*a),r+(i*(1-s)+n*a)]}(r))),0!==r.coordinatesIndex&&(n.texCoord=r.coordinatesIndex,i=!0),!i)return;this._wasUsed=!0,t.extensions||(t.extensions={}),t.extensions[Ne]=n}},e.prototype.preExportTextureAsync=function(e,t){return new Promise((function(r,n){t.getScene()?(0===t.uAng&&0===t.vAng||(d.Tools.Warn("".concat(e,": Texture ").concat(t.name," with rotation in the u or v axis is not supported in glTF.")),r(null)),0===t.wAng||0===t.uRotationCenter&&0===t.vRotationCenter||d.Tools.Warn("".concat(e,": Texture ").concat(t.name," with rotation not centered at the origin will be exported with an adjusted texture offset.")),r(t)):n("".concat(e,': "scene" is not defined for Babylon texture ').concat(t.name,"!"))}))},e}();ee.RegisterExtension(Ne,(function(){return new Be}));var Pe=void 0!==o.g?o.g:"undefined"!=typeof window?window:void 0;if(void 0!==Pe){Pe.BABYLON=Pe.BABYLON||{};var Oe=Pe.BABYLON;Oe.GLTF2=Oe.GLTF2||{},Oe.GLTF2.Exporter=Oe.GLTF2.Exporter||{},Oe.GLTF2.Exporter.Extensions=Oe.GLTF2.Exporter.Extensions||{};var Ue=[];for(var Le in a)Oe[Le]=a[Le],Ue.push(Le);for(var Le in u)Oe[Le]=u[Le],Ue.push(Le);for(var Le in l)Oe[Le]=l[Le],Ue.push(Le);for(var Le in c)Oe.GLTF2.Exporter.Extensions[Le]=c[Le],Ue.push(Le);for(var Le in f)Ue.indexOf(Le)>-1||(Oe.GLTF2.Exporter[Le]=f[Le])}const ke=h;return s.default})()));
//# sourceMappingURL=babylon.glTF2Serializer.min.js.map