!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("babylonjs")):"function"==typeof define&&define.amd?define("babylonjs-serializers",["babylonjs"],t):"object"==typeof exports?exports["babylonjs-serializers"]=t(require("babylonjs")):e.SERIALIZERS=t(e.BABYLON)}("undefined"!=typeof self?self:"undefined"!=typeof global?global:this,(e=>(()=>{"use strict";var t={520:t=>{t.exports=e}},r={};function s(e){var n=r[e];if(void 0!==n)return n.exports;var i=r[e]={exports:{}};return t[e](i,i.exports,s),i.exports}s.d=(e,t)=>{for(var r in t)s.o(t,r)&&!s.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},s.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),s.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var n={};return(()=>{s.d(n,{default:()=>te});var e={};s.r(e),s.d(e,{OBJExport:()=>h});var t={};s.r(t),s.d(t,{__IGLTFExporterExtension:()=>d});var r={};s.r(r),s.d(r,{GLTFData:()=>m});var i={};s.r(i),s.d(i,{GLTF2Export:()=>M});var o={};s.r(o),s.d(o,{EXT_mesh_gpu_instancing:()=>j,KHR_lights_punctual:()=>V,KHR_materials_anisotropy:()=>P,KHR_materials_clearcoat:()=>S,KHR_materials_emissive_strength:()=>Y,KHR_materials_ior:()=>K,KHR_materials_iridescence:()=>I,KHR_materials_sheen:()=>L,KHR_materials_specular:()=>G,KHR_materials_transmission:()=>H,KHR_materials_unlit:()=>k,KHR_materials_volume:()=>W,KHR_texture_transform:()=>w});var a={};s.r(a),s.d(a,{EXT_mesh_gpu_instancing:()=>j,GLTF2Export:()=>M,GLTFData:()=>m,KHR_lights_punctual:()=>V,KHR_materials_anisotropy:()=>P,KHR_materials_clearcoat:()=>S,KHR_materials_emissive_strength:()=>Y,KHR_materials_ior:()=>K,KHR_materials_iridescence:()=>I,KHR_materials_sheen:()=>L,KHR_materials_specular:()=>G,KHR_materials_transmission:()=>H,KHR_materials_unlit:()=>k,KHR_materials_volume:()=>W,KHR_texture_transform:()=>w,_BinaryWriter:()=>A,_Exporter:()=>b,_GLTFAnimation:()=>_,_GLTFMaterialExporter:()=>g,_GLTFUtilities:()=>p,__IGLTFExporterExtensionV2:()=>E});var l={};s.r(l),s.d(l,{STLExport:()=>X});var c={};s.r(c),s.d(c,{EXT_mesh_gpu_instancing:()=>j,GLTF2Export:()=>M,GLTFData:()=>m,KHR_lights_punctual:()=>V,KHR_materials_anisotropy:()=>P,KHR_materials_clearcoat:()=>S,KHR_materials_emissive_strength:()=>Y,KHR_materials_ior:()=>K,KHR_materials_iridescence:()=>I,KHR_materials_sheen:()=>L,KHR_materials_specular:()=>G,KHR_materials_transmission:()=>H,KHR_materials_unlit:()=>k,KHR_materials_volume:()=>W,KHR_texture_transform:()=>w,OBJExport:()=>h,STLExport:()=>X,_BinaryWriter:()=>A,_Exporter:()=>b,_GLTFAnimation:()=>_,_GLTFMaterialExporter:()=>g,_GLTFUtilities:()=>p,__IGLTFExporterExtension:()=>d,__IGLTFExporterExtensionV2:()=>E});var u=s(520);class h{static OBJ(e,t,r,s){const n=[];let i=1,o=1;t&&(r||(r="mat"),n.push("mtllib "+r+".mtl"));for(let r=0;r<e.length;r++){n.push("g object"+r),n.push("o object_"+r);let a=null;if(s){const t=e[r].computeWorldMatrix(!0);a=new u.Matrix,t.invertToRef(a),e[r].bakeTransformIntoVertices(t)}if(t){const t=e[r].material;t&&n.push("usemtl "+t.id)}const l=e[r].geometry;if(!l){u.Tools.Warn("No geometry is present on the mesh");continue}const c=l.getVerticesData("position"),h=l.getVerticesData("normal"),f=l.getVerticesData("uv"),d=l.getIndices();let p=0,_=0;if(c&&d){for(let t=0;t<c.length;t+=3)e[0].getScene().useRightHandedSystem?n.push("v "+c[t]+" "+c[t+1]+" "+c[t+2]):n.push("v "+c[t]+" "+c[t+1]+" "+-c[t+2]),p++;if(null!=h)for(let e=0;e<h.length;e+=3)n.push("vn "+h[e]+" "+h[e+1]+" "+h[e+2]);if(null!=f)for(let e=0;e<f.length;e+=2)n.push("vt "+f[e]+" "+f[e+1]),_++;for(let e=0;e<d.length;e+=3){const t=[String(d[e+2]+i),String(d[e+1]+i),String(d[e]+i)],r=[String(d[e+2]+o),String(d[e+1]+o),String(d[e]+o)],s=["","",""],a=t,l=null!=f?r:s,c=null!=h?t:s;n.push("f "+a[0]+"/"+l[0]+"/"+c[0]+" "+a[1]+"/"+l[1]+"/"+c[1]+" "+a[2]+"/"+l[2]+"/"+c[2])}s&&a&&e[r].bakeTransformIntoVertices(a),i+=p,o+=_}else u.Tools.Warn("There are no position vertices or indices on the mesh!")}return n.join("\n")}static MTL(e){const t=[],r=e.material;return t.push("newmtl mat1"),t.push("  Ns "+r.specularPower.toFixed(4)),t.push("  Ni 1.5000"),t.push("  d "+r.alpha.toFixed(4)),t.push("  Tr 0.0000"),t.push("  Tf 1.0000 1.0000 1.0000"),t.push("  illum 2"),t.push("  Ka "+r.ambientColor.r.toFixed(4)+" "+r.ambientColor.g.toFixed(4)+" "+r.ambientColor.b.toFixed(4)),t.push("  Kd "+r.diffuseColor.r.toFixed(4)+" "+r.diffuseColor.g.toFixed(4)+" "+r.diffuseColor.b.toFixed(4)),t.push("  Ks "+r.specularColor.r.toFixed(4)+" "+r.specularColor.g.toFixed(4)+" "+r.specularColor.b.toFixed(4)),t.push("  Ke "+r.emissiveColor.r.toFixed(4)+" "+r.emissiveColor.g.toFixed(4)+" "+r.emissiveColor.b.toFixed(4)),r.ambientTexture&&t.push("  map_Ka "+r.ambientTexture.name),r.diffuseTexture&&t.push("  map_Kd "+r.diffuseTexture.name),r.specularTexture&&t.push("  map_Ks "+r.specularTexture.name),r.bumpTexture&&t.push("  map_bump -imfchan z "+r.bumpTexture.name),r.opacityTexture&&t.push("  map_d "+r.opacityTexture.name),t.join("\n")}}var f,d=0;class p{static _CreateBufferView(e,t,r,s,n){const i={buffer:e,byteLength:r};return t&&(i.byteOffset=t),n&&(i.name=n),s&&(i.byteStride=s),i}static _CreateAccessor(e,t,r,s,n,i,o,a){const l={name:t,bufferView:e,componentType:s,count:n,type:r};return null!=o&&(l.min=o),null!=a&&(l.max=a),null!=i&&(l.byteOffset=i),l}static _CalculateMinMaxPositions(e,t,r){const s=[1/0,1/0,1/0],n=[-1/0,-1/0,-1/0];let i,o,a;if(r)for(let l=t,c=t+r;l<c;++l){i=3*l,o=u.Vector3.FromArray(e,i),a=o.asArray();for(let e=0;e<3;++e){const t=a[e];t<s[e]&&(s[e]=t),t>n[e]&&(n[e]=t),++i}}return{min:s,max:n}}static _NormalizeTangentFromRef(e){const t=Math.sqrt(e.x*e.x+e.y*e.y+e.z*e.z);t>0&&(e.x/=t,e.y/=t,e.z/=t)}static _GetDataAccessorElementCount(e){switch(e){case"MAT2":case"VEC4":return 4;case"MAT3":return 9;case"MAT4":return 16;case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":return 3}}}!function(e){e[e.INTANGENT=0]="INTANGENT",e[e.OUTTANGENT=1]="OUTTANGENT"}(f||(f={}));class _{static _IsTransformable(e){return e&&(e instanceof u.TransformNode||e instanceof u.Camera||e instanceof u.Light)}static _CreateNodeAnimation(e,t,r,s,n){if(this._IsTransformable(e)){const i=[],o=[],a=t.getKeys(),l=_._CalculateMinMaxKeyFrames(a),c=_._DeduceInterpolation(a,r,s),h=c.interpolationType,f=c.shouldBakeAnimation;if(f?_._CreateBakedAnimation(e,t,r,l.min,l.max,t.framePerSecond,n,i,o,l,s):"LINEAR"===h||"STEP"===h?_._CreateLinearOrStepAnimation(e,t,r,i,o,s):"CUBICSPLINE"===h?_._CreateCubicSplineAnimation(e,t,r,i,o,s):_._CreateBakedAnimation(e,t,r,l.min,l.max,t.framePerSecond,n,i,o,l,s),i.length&&o.length)return{inputs:i,outputs:o,samplerInterpolation:h,inputsMin:f?l.min:u.Tools.FloatRound(l.min/t.framePerSecond),inputsMax:f?l.max:u.Tools.FloatRound(l.max/t.framePerSecond)}}return null}static _DeduceAnimationInfo(e){let t=null,r="VEC3",s=!1;const n=e.targetProperty.split(".");switch(n[0]){case"scaling":t="scale";break;case"position":t="translation";break;case"rotation":r="VEC4",t="rotation";break;case"rotationQuaternion":r="VEC4",s=!0,t="rotation";break;case"influence":r="SCALAR",t="weights";break;default:u.Tools.Error(`Unsupported animatable property ${n[0]}`)}return t?{animationChannelTargetPath:t,dataAccessorType:r,useQuaternion:s}:(u.Tools.Error("animation channel target path and data accessor type could be deduced"),null)}static _CreateNodeAnimationFromNodeAnimations(e,t,r,s,n,i,o,a,l,c){let u;if(_._IsTransformable(e)&&e.animations)for(const n of e.animations){if(c&&!c(n))continue;const h=_._DeduceAnimationInfo(n);h&&(u={name:n.name,samplers:[],channels:[]},_._AddAnimation(`${n.name}`,n.hasRunningRuntimeAnimations?t:u,e,n,h.dataAccessorType,h.animationChannelTargetPath,s,i,o,a,h.useQuaternion,l),u.samplers.length&&u.channels.length&&r.push(u))}}static _CreateMorphTargetAnimationFromMorphTargetAnimations(e,t,r,s,n,i,o,a,l,c){let h;if(e instanceof u.Mesh){const n=e.morphTargetManager;if(n)for(let f=0;f<n.numTargets;++f){const d=n.getTarget(f);for(const p of d.animations){if(c&&!c(p))continue;const d=new u.Animation(`${p.name}`,"influence",p.framePerSecond,p.dataType,p.loopMode,p.enableBlending),m=[],g=p.getKeys();for(let e=0;e<g.length;++e){const t=g[e];for(let e=0;e<n.numTargets;++e)e==f?m.push(t):m.push({frame:t.frame,value:0})}d.setKeys(m);const x=_._DeduceAnimationInfo(d);x&&(h={name:d.name,samplers:[],channels:[]},_._AddAnimation(p.name,p.hasRunningRuntimeAnimations?t:h,e,d,x.dataAccessorType,x.animationChannelTargetPath,s,i,o,a,x.useQuaternion,l,n.numTargets),h.samplers.length&&h.channels.length&&r.push(h))}}}}static _CreateNodeAndMorphAnimationFromAnimationGroups(e,t,r,s,n,i,o,a){let l;if(e.animationGroups){const c=e.animationGroups;for(const h of c){const c=new Map,f=new Map,d=new Set,p=h.to-h.from;l={name:h.name,channels:[],samplers:[]};for(let t=0;t<h.targetedAnimations.length;++t){const p=h.targetedAnimations[t],m=p.target,g=p.animation;if(!a||a(g))if(this._IsTransformable(m)||1===m.length&&this._IsTransformable(m[0])){const e=_._DeduceAnimationInfo(p.animation);if(e){const t=this._IsTransformable(m)?m:this._IsTransformable(m[0])?m[0]:null;t&&_._AddAnimation(`${g.name}`,l,t,g,e.dataAccessorType,e.animationChannelTargetPath,r,s,n,i,e.useQuaternion,o)}}else if((m instanceof u.MorphTarget||1===m.length&&m[0]instanceof u.MorphTarget)&&_._DeduceAnimationInfo(p.animation)){const t=m instanceof u.MorphTarget?m:m[0];if(t){const r=e.morphTargetManagers.find((e=>{for(let r=0;r<e.numTargets;++r)if(e.getTarget(r)===t)return!0;return!1}));if(r){const s=e.meshes.find((e=>e.morphTargetManager===r));s&&(c.has(s)||c.set(s,new Map),c.get(s)?.set(t,g),d.add(s),f.set(s,g))}}}}d.forEach((e=>{const t=e.morphTargetManager;let a=null;const d=[],m=f.get(e).getKeys(),g=m.length;for(let r=0;r<g;++r)for(let s=0;s<t.numTargets;++s){const n=t.getTarget(s),i=c.get(e);if(i){const t=i.get(n);t?(a||(a=new u.Animation(`${h.name}_${e.name}_MorphWeightAnimation`,"influence",t.framePerSecond,u.Animation.ANIMATIONTYPE_FLOAT,t.loopMode,t.enableBlending)),d.push(t.getKeys()[r])):d.push({frame:h.from+p/g*r,value:n.influence,inTangent:m[0].inTangent?0:void 0,outTangent:m[0].outTangent?0:void 0})}}a.setKeys(d);const x=_._DeduceAnimationInfo(a);x&&_._AddAnimation(`${h.name}_${e.name}_MorphWeightAnimation`,l,e,a,x.dataAccessorType,x.animationChannelTargetPath,r,s,n,i,x.useQuaternion,o,t?.numTargets)})),l.channels.length&&l.samplers.length&&t.push(l)}}}static _AddAnimation(e,t,r,s,n,i,o,a,l,c,u,h,f){const d=_._CreateNodeAnimation(r,s,i,u,h);let m,g,x,T,y,b,A;if(d){if(f){let e=0,t=0;const r=[];for(;d.inputs.length>0;)t=d.inputs.shift(),e%f==0&&r.push(t),e++;d.inputs=r}const s=o[r.uniqueId];let u=4*d.inputs.length;m=p._CreateBufferView(0,a.getByteOffset(),u,void 0,`${e}  keyframe data view`),l.push(m),d.inputs.forEach((function(e){a.setFloat32(e)})),g=p._CreateAccessor(l.length-1,`${e}  keyframes`,"SCALAR",5126,d.inputs.length,null,[d.inputsMin],[d.inputsMax]),c.push(g),x=c.length-1,y=d.outputs.length,u=4*p._GetDataAccessorElementCount(n)*d.outputs.length,m=p._CreateBufferView(0,a.getByteOffset(),u,void 0,`${e}  data view`),l.push(m),d.outputs.forEach((function(e){e.forEach((function(e){a.setFloat32(e)}))})),g=p._CreateAccessor(l.length-1,`${e}  data`,n,5126,y,null,null,null),c.push(g),T=c.length-1,b={interpolation:d.samplerInterpolation,input:x,output:T},t.samplers.push(b),A={sampler:t.samplers.length-1,target:{node:s,path:i}},t.channels.push(A)}}static _CreateBakedAnimation(e,t,r,s,n,i,o,a,l,c,h){let f;const d=u.Quaternion.Identity();let p,m=null,g=null,x=null,T=null,y=null,b=null;c.min=u.Tools.FloatRound(s/i);const A=t.getKeys();for(let s=0,c=A.length;s<c;++s){if(b=null,x=A[s],s+1<c)if(T=A[s+1],x.value.equals&&x.value.equals(T.value)||x.value===T.value){if(0!==s)continue;b=x.frame}else b=T.frame;else{if(y=A[s-1],x.value.equals&&x.value.equals(y.value)||x.value===y.value)continue;b=n}if(b)for(let s=x.frame;s<=b;s+=o){if(p=u.Tools.FloatRound(s/i),p===m)continue;m=p,g=p;const n={key:0,repeatCount:0,loopMode:t.loopMode};f=t._interpolate(s,n),_._SetInterpolatedValue(e,f,p,t,r,d,a,l,h)}}g&&(c.max=g)}static _ConvertFactorToVector3OrQuaternion(e,t,r,s,n){const i=_._GetBasePositionRotationOrScale(t,s,n),o=r.targetProperty.split("."),a=o?o[1]:"",l=n?u.Quaternion.FromArray(i).normalize():u.Vector3.FromArray(i);switch(a){case"x":case"y":case"z":l[a]=e;break;case"w":l.w=e;break;default:u.Tools.Error(`glTFAnimation: Unsupported component name "${a}"!`)}return l}static _SetInterpolatedValue(e,t,r,s,n,i,o,a,l){let c;o.push(r),"weights"!==n?(s.dataType===u.Animation.ANIMATIONTYPE_FLOAT&&(t=this._ConvertFactorToVector3OrQuaternion(t,e,s,n,l)),"rotation"===n?(l?i=t:(c=t,u.Quaternion.RotationYawPitchRollToRef(c.y,c.x,c.z,i)),a.push(i.asArray())):(c=t,a.push(c.asArray()))):a.push([t])}static _CreateLinearOrStepAnimation(e,t,r,s,n,i){for(const o of t.getKeys())s.push(o.frame/t.framePerSecond),_._AddKeyframeValue(o,t,n,r,e,i)}static _CreateCubicSplineAnimation(e,t,r,s,n,i){t.getKeys().forEach((function(o){s.push(o.frame/t.framePerSecond),_._AddSplineTangent(f.INTANGENT,n,r,"CUBICSPLINE",o,i),_._AddKeyframeValue(o,t,n,r,e,i),_._AddSplineTangent(f.OUTTANGENT,n,r,"CUBICSPLINE",o,i)}))}static _GetBasePositionRotationOrScale(e,t,r){let s;return s="rotation"===t?r?(e.rotationQuaternion??u.Quaternion.Identity()).asArray():(e.rotation??u.Vector3.Zero()).asArray():"translation"===t?(e.position??u.Vector3.Zero()).asArray():(e.scaling??u.Vector3.One()).asArray(),s}static _AddKeyframeValue(e,t,r,s,n,i){let o;const a=t.dataType;if(a===u.Animation.ANIMATIONTYPE_VECTOR3){let t=e.value.asArray();if("rotation"===s){const e=u.Vector3.FromArray(t);t=u.Quaternion.RotationYawPitchRoll(e.y,e.x,e.z).asArray()}r.push(t)}else if(a===u.Animation.ANIMATIONTYPE_FLOAT){if("weights"===s)r.push([e.value]);else if(o=this._ConvertFactorToVector3OrQuaternion(e.value,n,t,s,i),o){if("rotation"===s){const e=i?o:u.Quaternion.RotationYawPitchRoll(o.y,o.x,o.z).normalize();r.push(e.asArray())}r.push(o.asArray())}}else a===u.Animation.ANIMATIONTYPE_QUATERNION?r.push(e.value.normalize().asArray()):u.Tools.Error("glTFAnimation: Unsupported key frame values for animation!")}static _DeduceInterpolation(e,t,r){let s,n,i=!1;if("rotation"===t&&!r)return{interpolationType:"LINEAR",shouldBakeAnimation:!0};for(let t=0,r=e.length;t<r;++t)if(n=e[t],n.inTangent||n.outTangent)if(s){if("CUBICSPLINE"!==s){s="LINEAR",i=!0;break}}else s="CUBICSPLINE";else if(s){if("CUBICSPLINE"===s||n.interpolation&&n.interpolation===u.AnimationKeyInterpolation.STEP&&"STEP"!==s){s="LINEAR",i=!0;break}}else s=n.interpolation&&n.interpolation===u.AnimationKeyInterpolation.STEP?"STEP":"LINEAR";return s||(s="LINEAR"),{interpolationType:s,shouldBakeAnimation:i}}static _AddSplineTangent(e,t,r,s,n,i){let o;const a=e===f.INTANGENT?n.inTangent:n.outTangent;if("CUBICSPLINE"===s){if("rotation"===r)if(a)if(i)o=a.asArray();else{const e=a;o=u.Quaternion.RotationYawPitchRoll(e.y,e.x,e.z).asArray()}else o=[0,0,0,0];else o="weights"===r?a?[a]:[0]:a?a.asArray():[0,0,0];t.push(o)}}static _CalculateMinMaxKeyFrames(e){let t=1/0,r=-1/0;return e.forEach((function(e){t=Math.min(t,e.frame),r=Math.max(r,e.frame)})),{min:t,max:r}}}class m{constructor(){this.glTFFiles={}}downloadFiles(){function e(e,t){return-1!==e.indexOf(t,e.length-t.length)}for(const t in this.glTFFiles){const r=document.createElement("a");document.body.appendChild(r),r.setAttribute("type","hidden"),r.download=t;const s=this.glTFFiles[t];let n;e(t,".glb")?n={type:"model/gltf-binary"}:e(t,".bin")?n={type:"application/octet-stream"}:e(t,".gltf")?n={type:"model/gltf+json"}:e(t,".jpeg")||e(t,".jpg")?n={type:"image/jpeg"}:e(t,".png")&&(n={type:"image/png"}),r.href=window.URL.createObjectURL(new Blob([s],n)),r.click()}}}class g{constructor(e){this._textureMap={},this._internalTextureToImage={},this._textureMap={},this._exporter=e}static _FuzzyEquals(e,t,r){return u.Scalar.WithinEpsilon(e.r,t.r,r)&&u.Scalar.WithinEpsilon(e.g,t.g,r)&&u.Scalar.WithinEpsilon(e.b,t.b,r)}_convertMaterialsToGLTFAsync(e,t,r){const s=[];return e.forEach((e=>{"StandardMaterial"===e.getClassName()?s.push(this._convertStandardMaterialAsync(e,t,r)):-1!==e.getClassName().indexOf("PBR")?s.push(this._convertPBRMaterialAsync(e,t,r)):u.Tools.Warn(`Unsupported material type: ${e.name}`)})),Promise.all(s).then((()=>{}))}_stripTexturesFromMaterial(e){const t={};if(e){t.name=e.name,t.doubleSided=e.doubleSided,t.alphaMode=e.alphaMode,t.alphaCutoff=e.alphaCutoff,t.emissiveFactor=e.emissiveFactor;const r=e.pbrMetallicRoughness;r&&(t.pbrMetallicRoughness={},t.pbrMetallicRoughness.baseColorFactor=r.baseColorFactor,t.pbrMetallicRoughness.metallicFactor=r.metallicFactor,t.pbrMetallicRoughness.roughnessFactor=r.roughnessFactor)}return t}_hasTexturesPresent(e){if(e.emissiveTexture||e.normalTexture||e.occlusionTexture)return!0;const t=e.pbrMetallicRoughness;if(t&&(t.baseColorTexture||t.metallicRoughnessTexture))return!0;if(e.extensions)for(const t in e.extensions){const r=e.extensions[t];if(r)return r.hasTextures?.()}return!1}_getTextureInfo(e){if(e){const t=e.uid;if(t in this._textureMap)return this._textureMap[t]}return null}_convertToGLTFPBRMetallicRoughness(e){const t=new u.Vector2(0,1),r=new u.Vector2(0,.1),s=new u.Vector2(0,.1),n=new u.Vector2(1300,.1),i=e.diffuseColor.toLinearSpace(e.getScene().getEngine().useExactSrgbConversions).scale(.5),o=e.alpha,a=(l=u.Scalar.Clamp(e.specularPower,0,g._MaxSpecularPower),c=Math.pow(l/n.x,.333333),h=t.y,f=r.y,d=s.y,p=n.y,(1-c)*(1-c)*(1-c)*h+3*(1-c)*(1-c)*c*f+3*(1-c)*c*c*d+c*c*c*p);var l,c,h,f,d,p;return{baseColorFactor:[i.r,i.g,i.b,o],metallicFactor:0,roughnessFactor:a}}static _SolveMetallic(e,t,r){if(t<this._DielectricSpecular.r)return this._DielectricSpecular,0;const s=this._DielectricSpecular.r,n=e*r/(1-this._DielectricSpecular.r)+t-2*this._DielectricSpecular.r,i=n*n-4*s*(this._DielectricSpecular.r-t);return u.Scalar.Clamp((-n+Math.sqrt(i))/(2*s),0,1)}static _SetAlphaMode(e,t){t.needAlphaBlending()?e.alphaMode="BLEND":t.needAlphaTesting()&&(e.alphaMode="MASK",e.alphaCutoff=t.alphaCutOff)}_convertStandardMaterialAsync(e,t,r){const s=this._exporter._materialMap,n=this._exporter._materials,i=[],o=this._convertToGLTFPBRMetallicRoughness(e),a={name:e.name};if(null==e.backFaceCulling||e.backFaceCulling||(e.twoSidedLighting||u.Tools.Warn(e.name+": Back-face culling disabled and two-sided lighting disabled is not supported in glTF."),a.doubleSided=!0),r){e.diffuseTexture&&i.push(this._exportTextureAsync(e.diffuseTexture,t).then((e=>{e&&(o.baseColorTexture=e)})));const r=e.bumpTexture;r&&i.push(this._exportTextureAsync(r,t).then((e=>{e&&(a.normalTexture=e,1!==r.level&&(a.normalTexture.scale=r.level))}))),e.emissiveTexture&&(a.emissiveFactor=[1,1,1],i.push(this._exportTextureAsync(e.emissiveTexture,t).then((e=>{e&&(a.emissiveTexture=e)})))),e.ambientTexture&&i.push(this._exportTextureAsync(e.ambientTexture,t).then((e=>{if(e){const t={index:e.index};a.occlusionTexture=t}})))}return(e.alpha<1||e.opacityTexture)&&(e.alphaMode===u.Constants.ALPHA_COMBINE?a.alphaMode="BLEND":u.Tools.Warn(e.name+": glTF 2.0 does not support alpha mode: "+e.alphaMode.toString())),e.emissiveColor&&!g._FuzzyEquals(e.emissiveColor,u.Color3.Black(),g._Epsilon)&&(a.emissiveFactor=e.emissiveColor.asArray()),a.pbrMetallicRoughness=o,g._SetAlphaMode(a,e),n.push(a),s[e.uniqueId]=n.length-1,this._finishMaterial(i,a,e,t)}_finishMaterial(e,t,r,s){return Promise.all(e).then((()=>{const e=this._exporter._extensionsPostExportMaterialAdditionalTextures("exportMaterial",t,r);let n=null;for(const t of e)n||(n=[]),n.push(this._exportTextureAsync(t,s));return n||(n=[Promise.resolve(null)]),Promise.all(n).then((()=>{const e=this._exporter._extensionsPostExportMaterialAsync("exportMaterial",t,r);return e?e.then((()=>t)):t}))}))}async _getImageDataAsync(e,t,r,s){const n=u.Constants.TEXTURETYPE_UNSIGNED_INT,i=this._exporter._babylonScene,o=i.getEngine(),a=o.createRawTexture(e,t,r,u.Constants.TEXTUREFORMAT_RGBA,!1,!0,u.Texture.NEAREST_SAMPLINGMODE,null,n);await u.TextureTools.ApplyPostProcess("pass",a,i,n,u.Constants.TEXTURE_NEAREST_SAMPLINGMODE,u.Constants.TEXTUREFORMAT_RGBA);const l=await o._readTexturePixels(a,t,r);return await u.DumpTools.DumpDataAsync(t,r,l,s,void 0,!0,!0)}_createWhiteTexture(e,t,r){const s=new Uint8Array(e*t*4);for(let e=0;e<s.length;e+=4)s[e]=s[e+1]=s[e+2]=s[e+3]=255;return u.RawTexture.CreateRGBATexture(s,e,t,r)}_resizeTexturesToSameDimensions(e,t,r){const s=e?e.getSize():{width:0,height:0},n=t?t.getSize():{width:0,height:0};let i,o;return s.width<n.width?(i=e&&e instanceof u.Texture?u.TextureTools.CreateResizedCopy(e,n.width,n.height,!0):this._createWhiteTexture(n.width,n.height,r),o=t):s.width>n.width?(o=t&&t instanceof u.Texture?u.TextureTools.CreateResizedCopy(t,s.width,s.height,!0):this._createWhiteTexture(s.width,s.height,r),i=e):(i=e,o=t),{texture1:i,texture2:o}}_convertPixelArrayToFloat32(e){if(e instanceof Uint8Array){const t=e.length,r=new Float32Array(e.length);for(let s=0;s<t;++s)r[s]=e[s]/255;return r}if(e instanceof Float32Array)return e;throw new Error("Unsupported pixel format!")}async _convertSpecularGlossinessTexturesToMetallicRoughnessAsync(e,t,r,s){const n=new Array;if(!e&&!t)return Promise.reject("_ConvertSpecularGlosinessTexturesToMetallicRoughness: diffuse and specular glossiness textures are not defined!");const i=e?e.getScene():t?t.getScene():null;if(i){const o=this._resizeTexturesToSameDimensions(e,t,i),a=o.texture1?.getSize();let l,c;const h=a.width,f=a.height,d=await o.texture1.readPixels(),p=await o.texture2.readPixels();if(!d)return Promise.reject("Failed to retrieve pixels from diffuse texture!");if(l=this._convertPixelArrayToFloat32(d),!p)return Promise.reject("Failed to retrieve pixels from specular glossiness texture!");c=this._convertPixelArrayToFloat32(p);const _=c.byteLength,m=new Uint8Array(_),x=new Uint8Array(_),T=4,y=u.Color3.Black();let b=0,A=0;for(let e=0;e<f;++e)for(let t=0;t<h;++t){const s=(h*e+t)*T,n={diffuseColor:new u.Color3(l[s],l[s+1],l[s+2]).toLinearSpace(i.getEngine().useExactSrgbConversions).multiply(r.diffuseColor),specularColor:new u.Color3(c[s],c[s+1],c[s+2]).toLinearSpace(i.getEngine().useExactSrgbConversions).multiply(r.specularColor),glossiness:c[s+3]*r.glossiness},a=this._convertSpecularGlossinessToMetallicRoughness(n);y.r=Math.max(y.r,a.baseColor.r),y.g=Math.max(y.g,a.baseColor.g),y.b=Math.max(y.b,a.baseColor.b),b=Math.max(b,a.metallic),A=Math.max(A,a.roughness),x[s]=255*a.baseColor.r,x[s+1]=255*a.baseColor.g,x[s+2]=255*a.baseColor.b,x[s+3]=o.texture1.hasAlpha?255*l[s+3]:255,m[s]=0,m[s+1]=255*a.roughness,m[s+2]=255*a.metallic,m[s+3]=255}const E={baseColor:y,metallic:b,roughness:A};let M=!1,F=!1;for(let e=0;e<f;++e)for(let t=0;t<h;++t){const r=(h*e+t)*T;x[r]/=E.baseColor.r>g._Epsilon?E.baseColor.r:1,x[r+1]/=E.baseColor.g>g._Epsilon?E.baseColor.g:1,x[r+2]/=E.baseColor.b>g._Epsilon?E.baseColor.b:1;const s=u.Color3.FromInts(x[r],x[r+1],x[r+2]).toGammaSpace(i.getEngine().useExactSrgbConversions);x[r]=255*s.r,x[r+1]=255*s.g,x[r+2]=255*s.b,g._FuzzyEquals(s,u.Color3.White(),g._Epsilon)||(F=!0),m[r+1]/=E.roughness>g._Epsilon?E.roughness:1,m[r+2]/=E.metallic>g._Epsilon?E.metallic:1;const n=u.Color3.FromInts(255,m[r+1],m[r+2]);g._FuzzyEquals(n,u.Color3.White(),g._Epsilon)||(M=!0)}return M&&n.push(this._getImageDataAsync(m,h,f,s).then((e=>{E.metallicRoughnessTextureData=e}))),F&&n.push(this._getImageDataAsync(x,h,f,s).then((e=>{E.baseColorTextureData=e}))),Promise.all(n).then((()=>E))}return Promise.reject("_ConvertSpecularGlossinessTexturesToMetallicRoughness: Scene from textures is missing!")}_convertSpecularGlossinessToMetallicRoughness(e){const t=this._getPerceivedBrightness(e.diffuseColor),r=this._getPerceivedBrightness(e.specularColor),s=1-this._getMaxComponent(e.specularColor),n=g._SolveMetallic(t,r,s),i=e.diffuseColor.scale(s/(1-g._DielectricSpecular.r)/Math.max(1-n,g._Epsilon)),o=e.specularColor.subtract(g._DielectricSpecular.scale(1-n)).scale(1/Math.max(n,g._Epsilon));let a=u.Color3.Lerp(i,o,n*n);return a=a.clampToRef(0,1,a),{baseColor:a,metallic:n,roughness:1-e.glossiness}}_getPerceivedBrightness(e){return e?Math.sqrt(.299*e.r*e.r+.587*e.g*e.g+.114*e.b*e.b):0}_getMaxComponent(e){return e?Math.max(e.r,Math.max(e.g,e.b)):0}_convertMetalRoughFactorsToMetallicRoughnessAsync(e,t,r,s){const n=[],i={baseColor:e._albedoColor,metallic:e._metallic,roughness:e._roughness};if(s){e._albedoTexture&&n.push(this._exportTextureAsync(e._albedoTexture,t).then((e=>{e&&(r.baseColorTexture=e)})));const s=e._metallicTexture;s&&n.push(this._exportTextureAsync(s,t).then((e=>{e&&(r.metallicRoughnessTexture=e)})))}return Promise.all(n).then((()=>i))}_getTextureSampler(e){const t={};if(!(e&&e instanceof u.Texture))return t;const r=this._getGLTFTextureWrapMode(e.wrapU);10497!==r&&(t.wrapS=r);const s=this._getGLTFTextureWrapMode(e.wrapV);switch(10497!==s&&(t.wrapT=s),e.samplingMode){case u.Texture.LINEAR_LINEAR:t.magFilter=9729,t.minFilter=9729;break;case u.Texture.LINEAR_NEAREST:t.magFilter=9729,t.minFilter=9728;break;case u.Texture.NEAREST_LINEAR:t.magFilter=9728,t.minFilter=9729;break;case u.Texture.NEAREST_LINEAR_MIPLINEAR:t.magFilter=9728,t.minFilter=9987;break;case u.Texture.NEAREST_NEAREST:t.magFilter=9728,t.minFilter=9728;break;case u.Texture.NEAREST_LINEAR_MIPNEAREST:t.magFilter=9728,t.minFilter=9985;break;case u.Texture.LINEAR_NEAREST_MIPNEAREST:t.magFilter=9729,t.minFilter=9984;break;case u.Texture.LINEAR_NEAREST_MIPLINEAR:t.magFilter=9729,t.minFilter=9986;break;case u.Texture.NEAREST_NEAREST_MIPLINEAR:t.magFilter=9728,t.minFilter=9986;break;case u.Texture.LINEAR_LINEAR_MIPLINEAR:t.magFilter=9729,t.minFilter=9987;break;case u.Texture.LINEAR_LINEAR_MIPNEAREST:t.magFilter=9729,t.minFilter=9985;break;case u.Texture.NEAREST_NEAREST_MIPNEAREST:t.magFilter=9728,t.minFilter=9984}return t}_getGLTFTextureWrapMode(e){switch(e){case u.Texture.WRAP_ADDRESSMODE:return 10497;case u.Texture.CLAMP_ADDRESSMODE:return 33071;case u.Texture.MIRROR_ADDRESSMODE:return 33648;default:return u.Tools.Error(`Unsupported Texture Wrap Mode ${e}!`),10497}}_convertSpecGlossFactorsToMetallicRoughnessAsync(e,t,r,s){return Promise.resolve().then((()=>{const n={diffuseColor:e._albedoColor,specularColor:e._reflectivityColor,glossiness:e._microSurface},i=e._albedoTexture,o=e._reflectivityTexture,a=e._useMicroSurfaceFromReflectivityMapAlpha;if(o&&!a)return Promise.reject("_ConvertPBRMaterial: Glossiness values not included in the reflectivity texture are currently not supported");if((i||o)&&s){const e=this._exportTextureSampler(i||o);return this._convertSpecularGlossinessTexturesToMetallicRoughnessAsync(i,o,n,t).then((s=>{const n=this._exporter._textures;if(s.baseColorTextureData){const o=this._exportImage(`baseColor${n.length}`,t,s.baseColorTextureData);r.baseColorTexture=this._exportTextureInfo(o,e,i?.coordinatesIndex)}if(s.metallicRoughnessTextureData){const i=this._exportImage(`metallicRoughness${n.length}`,t,s.metallicRoughnessTextureData);r.metallicRoughnessTexture=this._exportTextureInfo(i,e,o?.coordinatesIndex)}return s}))}return this._convertSpecularGlossinessToMetallicRoughness(n)}))}_convertPBRMaterialAsync(e,t,r){const s={},n={name:e.name};if(e.isMetallicWorkflow()){const i=e._albedoColor,o=e.alpha;return i&&(s.baseColorFactor=[i.r,i.g,i.b,o]),this._convertMetalRoughFactorsToMetallicRoughnessAsync(e,t,s,r).then((i=>this._setMetallicRoughnessPbrMaterial(i,e,n,s,t,r)))}return this._convertSpecGlossFactorsToMetallicRoughnessAsync(e,t,s,r).then((i=>this._setMetallicRoughnessPbrMaterial(i,e,n,s,t,r)))}_setMetallicRoughnessPbrMaterial(e,t,r,s,n,i){const o=this._exporter._materialMap,a=this._exporter._materials,l=[];if(e){if(g._SetAlphaMode(r,t),g._FuzzyEquals(e.baseColor,u.Color3.White(),g._Epsilon)&&t.alpha>=g._Epsilon||(s.baseColorFactor=[e.baseColor.r,e.baseColor.g,e.baseColor.b,t.alpha]),null!=e.metallic&&1!==e.metallic&&(s.metallicFactor=e.metallic),null!=e.roughness&&1!==e.roughness&&(s.roughnessFactor=e.roughness),null==t.backFaceCulling||t.backFaceCulling||(t._twoSidedLighting||u.Tools.Warn(t.name+": Back-face culling disabled and two-sided lighting disabled is not supported in glTF."),r.doubleSided=!0),i){const e=t._bumpTexture;if(e){const t=this._exportTextureAsync(e,n).then((t=>{t&&(r.normalTexture=t,1!==e.level&&(r.normalTexture.scale=e.level))}));l.push(t)}const s=t._ambientTexture;if(s){const e=this._exportTextureAsync(s,n).then((e=>{if(e){const s={index:e.index,texCoord:e.texCoord,extensions:e.extensions};r.occlusionTexture=s;const n=t._ambientTextureStrength;n&&(s.strength=n)}}));l.push(e)}const i=t._emissiveTexture;if(i){const e=this._exportTextureAsync(i,n).then((e=>{e&&(r.emissiveTexture=e)}));l.push(e)}}const c=t._emissiveColor;g._FuzzyEquals(c,u.Color3.Black(),g._Epsilon)||(r.emissiveFactor=c.asArray()),r.pbrMetallicRoughness=s,a.push(r),o[t.uniqueId]=a.length-1}return this._finishMaterial(l,r,t,n)}_getPixelsFromTexture(e){return e.textureType,u.Constants.TEXTURETYPE_UNSIGNED_INT,e.readPixels()}_exportTextureAsync(e,t){const r=this._exporter._extensionsPreExportTextureAsync("exporter",e,t);return r?r.then((r=>r?this._exportTextureInfoAsync(r,t):this._exportTextureInfoAsync(e,t))):this._exportTextureInfoAsync(e,t)}async _exportTextureInfoAsync(e,t){const r=e.uid;if(!(r in this._textureMap)){const s=await this._getPixelsFromTexture(e);if(!s)return null;const n=this._exportTextureSampler(e),i=e.mimeType;if(i)switch(i){case"image/jpeg":case"image/png":case"image/webp":t=i;break;default:u.Tools.Warn(`Unsupported media type: ${i}`)}const o=this._internalTextureToImage,a=e.getInternalTexture().uniqueId;o[a]||={};let l=o[a][t];if(void 0===l){const r=e.getSize();l=(async()=>{const n=await this._getImageDataAsync(s,r.width,r.height,t);return this._exportImage(e.name,t,n)})(),o[a][t]=l}const c=this._exportTextureInfo(await l,n,e.coordinatesIndex);this._textureMap[r]=c,this._exporter._extensionsPostExportTextures("exporter",this._textureMap[r],e)}return this._textureMap[r]}_exportImage(e,t,r){const s=this._exporter._imageData,n=e.replace(/\.\/|\/|\.\\|\\/g,"_"),i=function(e){switch(e){case"image/jpeg":return".jpg";case"image/png":return".png";case"image/webp":return".webp"}}(t);let o=n+i;o in s&&(o=`${n}_${u.Tools.RandomId()}${i}`),s[o]={data:r,mimeType:t};const a=this._exporter._images;return a.push({name:e,uri:o}),a.length-1}_exportTextureInfo(e,t,r){const s=this._exporter._textures;let n=s.findIndex((r=>r.sampler==t&&r.source===e));-1===n&&(n=s.length,s.push({source:e,sampler:t}));const i={index:n};return r&&(i.texCoord=r),i}_exportTextureSampler(e){const t=this._getTextureSampler(e),r=this._exporter._samplers,s=r.findIndex((e=>e.minFilter===t.minFilter&&e.magFilter===t.magFilter&&e.wrapS===t.wrapS&&e.wrapT===t.wrapT));return-1!==s?s:(r.push(t),r.length-1)}}g._DielectricSpecular=new u.Color3(.04,.04,.04),g._MaxSpecularPower=1024,g._Epsilon=1e-6;const x=u.Matrix.Compose(new u.Vector3(-1,1,1),u.Quaternion.Identity(),u.Vector3.Zero());function T(e,t){if(!(e instanceof u.TransformNode))return!1;if(t){if(!e.getWorldMatrix().isIdentity())return!1}else if(!e.getWorldMatrix().multiplyToRef(x,u.TmpVectors.Matrix[0]).isIdentity())return!1;return!(e instanceof u.Mesh&&e.geometry||e instanceof u.InstancedMesh&&e.sourceMesh.geometry)}function y(e){const t=u.Vector3.FromArrayToRef(e.translation||[0,0,0],0,u.TmpVectors.Vector3[0]),r=u.Quaternion.FromArrayToRef(e.rotation||[0,0,0,1],0,u.TmpVectors.Quaternion[0]),s=u.Vector3.FromArrayToRef(e.scale||[1,1,1],0,u.TmpVectors.Vector3[1]);u.Matrix.ComposeToRef(s,r,t,u.TmpVectors.Matrix[0]).multiplyToRef(x,u.TmpVectors.Matrix[0]).decompose(s,r,t),t.equalsToFloats(0,0,0)?delete e.translation:e.translation=t.asArray(),u.Quaternion.IsIdentity(r)?delete e.rotation:e.rotation=r.asArray(),s.equalsToFloats(1,1,1)?delete e.scale:e.scale=s.asArray()}class b{_applyExtension(e,t,r,s){if(r>=t.length)return Promise.resolve(e);const n=s(t[r],e);return n?n.then((e=>this._applyExtension(e,t,r+1,s))):this._applyExtension(e,t,r+1,s)}_applyExtensions(e,t){const r=[];for(const e of b._ExtensionNames)r.push(this._extensions[e]);return this._applyExtension(e,r,0,t)}_extensionsPreExportTextureAsync(e,t,r){return this._applyExtensions(t,((t,s)=>t.preExportTextureAsync&&t.preExportTextureAsync(e,s,r)))}_extensionsPostExportMeshPrimitiveAsync(e,t,r,s){return this._applyExtensions(t,((t,n)=>t.postExportMeshPrimitiveAsync&&t.postExportMeshPrimitiveAsync(e,n,r,s)))}_extensionsPostExportNodeAsync(e,t,r,s,n){return this._applyExtensions(t,((t,i)=>t.postExportNodeAsync&&t.postExportNodeAsync(e,i,r,s,n)))}_extensionsPostExportMaterialAsync(e,t,r){return this._applyExtensions(t,((t,s)=>t.postExportMaterialAsync&&t.postExportMaterialAsync(e,s,r)))}_extensionsPostExportMaterialAdditionalTextures(e,t,r){const s=[];for(const n of b._ExtensionNames){const i=this._extensions[n];i.postExportMaterialAdditionalTextures&&s.push(...i.postExportMaterialAdditionalTextures(e,t,r))}return s}_extensionsPostExportTextures(e,t,r){for(const s of b._ExtensionNames){const n=this._extensions[s];n.postExportTexture&&n.postExportTexture(e,t,r)}}_forEachExtensions(e){for(const t of b._ExtensionNames){const r=this._extensions[t];r.enabled&&e(r)}}_extensionsOnExporting(){this._forEachExtensions((e=>{e.wasUsed&&(null==this._glTF.extensionsUsed&&(this._glTF.extensionsUsed=[]),-1===this._glTF.extensionsUsed.indexOf(e.name)&&this._glTF.extensionsUsed.push(e.name),e.required&&(null==this._glTF.extensionsRequired&&(this._glTF.extensionsRequired=[]),-1===this._glTF.extensionsRequired.indexOf(e.name)&&this._glTF.extensionsRequired.push(e.name)),null==this._glTF.extensions&&(this._glTF.extensions={}),e.onExporting&&e.onExporting())}))}_loadExtensions(){for(const e of b._ExtensionNames){const t=b._ExtensionFactories[e](this);this._extensions[e]=t}}constructor(e,t){this._extensions={},this._glTF={asset:{generator:`Babylon.js v${u.Engine.Version}`,version:"2.0"}},(e=e||u.EngineStore.LastCreatedScene)&&(this._babylonScene=e,this._bufferViews=[],this._accessors=[],this._meshes=[],this._scenes=[],this._cameras=[],this._nodes=[],this._images=[],this._materials=[],this._materialMap=[],this._textures=[],this._samplers=[],this._skins=[],this._animations=[],this._imageData={},this._orderedImageData=[],this._options=t||{},this._animationSampleRate=this._options.animationSampleRate||1/60,this._glTFMaterialExporter=new g(this),this._loadExtensions())}dispose(){for(const e in this._extensions)this._extensions[e].dispose()}get options(){return this._options}static RegisterExtension(e,t){b.UnregisterExtension(e)&&u.Tools.Warn(`Extension with the name ${e} already exists`),b._ExtensionFactories[e]=t,b._ExtensionNames.push(e)}static UnregisterExtension(e){if(!b._ExtensionFactories[e])return!1;delete b._ExtensionFactories[e];const t=b._ExtensionNames.indexOf(e);return-1!==t&&b._ExtensionNames.splice(t,1),!0}_reorderIndicesBasedOnPrimitiveMode(e,t,r,s,n){switch(t){case u.Material.TriangleFillMode:s||(s=0);for(let t=e.indexStart,r=e.indexStart+e.indexCount;t<r;t+=3){const e=s+4*t,r=n.getUInt32(e+4),i=n.getUInt32(e+8);n.setUInt32(i,e+4),n.setUInt32(r,e+8)}break;case u.Material.TriangleFanDrawMode:for(let t=e.indexStart+e.indexCount-1,i=e.indexStart;t>=i;--t)n.setUInt32(r[t],s),s+=4;break;case u.Material.TriangleStripDrawMode:e.indexCount>=3&&(n.setUInt32(r[e.indexStart+2],s+4),n.setUInt32(r[e.indexStart+1],s+8))}}_reorderVertexAttributeDataBasedOnPrimitiveMode(e,t,r,s,n,i){switch(t){case u.Material.TriangleFillMode:this._reorderTriangleFillMode(e,r,s,n,i);break;case u.Material.TriangleStripDrawMode:this._reorderTriangleStripDrawMode(e,r,s,n,i);break;case u.Material.TriangleFanDrawMode:this._reorderTriangleFanMode(e,r,s,n,i)}}_reorderTriangleFillMode(e,t,r,s,n){const i=this._getVertexBufferFromMesh(t,e.getMesh());if(i){const o=i.byteStride/u.VertexBuffer.GetTypeByteLength(i.type);if(e.verticesCount%3!=0)u.Tools.Error("The submesh vertices for the triangle fill mode is not divisible by 3!");else{const a=[];let l=0;switch(t){case u.VertexBuffer.PositionKind:case u.VertexBuffer.NormalKind:for(let t=e.verticesStart;t<e.verticesStart+e.verticesCount;t+=3)l=t*o,a.push(u.Vector3.FromArray(r,l)),a.push(u.Vector3.FromArray(r,l+2*o)),a.push(u.Vector3.FromArray(r,l+o));break;case u.VertexBuffer.TangentKind:for(let t=e.verticesStart;t<e.verticesStart+e.verticesCount;t+=3)l=t*o,a.push(u.Vector4.FromArray(r,l)),a.push(u.Vector4.FromArray(r,l+2*o)),a.push(u.Vector4.FromArray(r,l+o));break;case u.VertexBuffer.ColorKind:{const t=i.getSize();for(let s=e.verticesStart;s<e.verticesStart+e.verticesCount;s+=t)l=s*o,4===t?(a.push(u.Vector4.FromArray(r,l)),a.push(u.Vector4.FromArray(r,l+2*o)),a.push(u.Vector4.FromArray(r,l+o))):(a.push(u.Vector3.FromArray(r,l)),a.push(u.Vector3.FromArray(r,l+2*o)),a.push(u.Vector3.FromArray(r,l+o)));break}case u.VertexBuffer.UVKind:case u.VertexBuffer.UV2Kind:for(let t=e.verticesStart;t<e.verticesStart+e.verticesCount;t+=3)l=t*o,a.push(u.Vector2.FromArray(r,l)),a.push(u.Vector2.FromArray(r,l+2*o)),a.push(u.Vector2.FromArray(r,l+o));break;default:u.Tools.Error(`Unsupported Vertex Buffer type: ${t}`)}this._writeVertexAttributeData(a,s,t,n)}}else u.Tools.Warn(`reorderTriangleFillMode: Vertex Buffer Kind ${t} not present!`)}_reorderTriangleStripDrawMode(e,t,r,s,n){const i=this._getVertexBufferFromMesh(t,e.getMesh());if(i){const o=i.byteStride/u.VertexBuffer.GetTypeByteLength(i.type),a=[];let l=0;switch(t){case u.VertexBuffer.PositionKind:case u.VertexBuffer.NormalKind:l=e.verticesStart,a.push(u.Vector3.FromArray(r,l+2*o)),a.push(u.Vector3.FromArray(r,l+o));break;case u.VertexBuffer.TangentKind:for(let t=e.verticesStart+e.verticesCount-1;t>=e.verticesStart;--t)l=t*o,a.push(u.Vector4.FromArray(r,l));break;case u.VertexBuffer.ColorKind:for(let t=e.verticesStart+e.verticesCount-1;t>=e.verticesStart;--t)l=t*o,4===i.getSize()?a.push(u.Vector4.FromArray(r,l)):a.push(u.Vector3.FromArray(r,l));break;case u.VertexBuffer.UVKind:case u.VertexBuffer.UV2Kind:for(let t=e.verticesStart+e.verticesCount-1;t>=e.verticesStart;--t)l=t*o,a.push(u.Vector2.FromArray(r,l));break;default:u.Tools.Error(`Unsupported Vertex Buffer type: ${t}`)}this._writeVertexAttributeData(a,s+12,t,n)}else u.Tools.Warn(`reorderTriangleStripDrawMode: Vertex buffer kind ${t} not present!`)}_reorderTriangleFanMode(e,t,r,s,n){const i=this._getVertexBufferFromMesh(t,e.getMesh());if(i){const o=i.byteStride/u.VertexBuffer.GetTypeByteLength(i.type),a=[];let l=0;switch(t){case u.VertexBuffer.PositionKind:case u.VertexBuffer.NormalKind:for(let t=e.verticesStart+e.verticesCount-1;t>=e.verticesStart;--t)l=t*o,a.push(u.Vector3.FromArray(r,l));break;case u.VertexBuffer.TangentKind:for(let t=e.verticesStart+e.verticesCount-1;t>=e.verticesStart;--t)l=t*o,a.push(u.Vector4.FromArray(r,l));break;case u.VertexBuffer.ColorKind:for(let t=e.verticesStart+e.verticesCount-1;t>=e.verticesStart;--t)l=t*o,a.push(u.Vector4.FromArray(r,l)),4===i.getSize()?a.push(u.Vector4.FromArray(r,l)):a.push(u.Vector3.FromArray(r,l));break;case u.VertexBuffer.UVKind:case u.VertexBuffer.UV2Kind:for(let t=e.verticesStart+e.verticesCount-1;t>=e.verticesStart;--t)l=t*o,a.push(u.Vector2.FromArray(r,l));break;default:u.Tools.Error(`Unsupported Vertex Buffer type: ${t}`)}this._writeVertexAttributeData(a,s,t,n)}else u.Tools.Warn(`reorderTriangleFanMode: Vertex buffer kind ${t} not present!`)}_writeVertexAttributeData(e,t,r,s){for(const n of e){r===u.VertexBuffer.NormalKind?n.normalize():r===u.VertexBuffer.TangentKind&&n instanceof u.Vector4&&p._NormalizeTangentFromRef(n);for(const e of n.asArray())s.setFloat32(e,t),t+=4}}_writeAttributeData(e,t,r,s,n,i){let o,a,l=[];switch(e){case u.VertexBuffer.PositionKind:for(let e=0,t=r.length/s;e<t;++e){o=e*s;const t=u.Vector3.FromArray(r,o);l.push(t.asArray())}break;case u.VertexBuffer.NormalKind:for(let e=0,t=r.length/s;e<t;++e){o=e*s;const t=u.Vector3.FromArray(r,o);l.push(t.normalize().asArray())}break;case u.VertexBuffer.TangentKind:for(let e=0,t=r.length/s;e<t;++e){o=e*s;const t=u.Vector4.FromArray(r,o);p._NormalizeTangentFromRef(t),l.push(t.asArray())}break;case u.VertexBuffer.ColorKind:{const e=i.material,t=!e||"StandardMaterial"===e.getClassName(),n=3===s?new u.Color3:new u.Color4,a=this._babylonScene.getEngine().useExactSrgbConversions;for(let e=0,i=r.length/s;e<i;++e)o=e*s,3===s?(u.Color3.FromArrayToRef(r,o,n),t&&n.toLinearSpaceToRef(n,a)):(u.Color4.FromArrayToRef(r,o,n),t&&n.toLinearSpaceToRef(n,a)),l.push(n.asArray());break}case u.VertexBuffer.UVKind:case u.VertexBuffer.UV2Kind:for(let e=0,t=r.length/s;e<t;++e){o=e*s;const t=u.Vector2.FromArray(r,o);l.push(t.asArray())}break;case u.VertexBuffer.MatricesIndicesKind:case u.VertexBuffer.MatricesIndicesExtraKind:for(let e=0,t=r.length/s;e<t;++e){o=e*s;const t=u.Vector4.FromArray(r,o);l.push(t.asArray())}break;case u.VertexBuffer.MatricesWeightsKind:case u.VertexBuffer.MatricesWeightsExtraKind:for(let e=0,t=r.length/s;e<t;++e){o=e*s;const t=u.Vector4.FromArray(r,o);l.push(t.asArray())}break;default:u.Tools.Warn("Unsupported Vertex Buffer Type: "+e),l=[]}switch(t){case 5121:a=n.setUInt8.bind(n);break;case 5123:a=n.setUInt16.bind(n);break;case 5125:a=n.setUInt32.bind(n);break;case 5126:a=n.setFloat32.bind(n);break;default:return void u.Tools.Warn("Unsupported Attribute Component kind: "+t)}for(const e of l)for(const t of e)a(t)}writeMorphTargetAttributeData(e,t,r,s,n,i,o,a){let l,c,h=[],f=new u.Vector3,d=new u.Vector4(0,0,0,0);switch(e){case u.VertexBuffer.PositionKind:for(let e=r.verticesStart;e<r.verticesCount;++e){l=r.indexStart+e*i;const t=u.Vector3.FromArray(s,l);f=u.Vector3.FromArray(n,l).subtractToRef(t,f),a&&(a.min.copyFromFloats(Math.min(f.x,a.min.x),Math.min(f.y,a.min.y),Math.min(f.z,a.min.z)),a.max.copyFromFloats(Math.max(f.x,a.max.x),Math.max(f.y,a.max.y),Math.max(f.z,a.max.z))),h.push(f.asArray())}break;case u.VertexBuffer.NormalKind:for(let e=r.verticesStart;e<r.verticesCount;++e){l=r.indexStart+e*i;const t=u.Vector3.FromArray(s,l).normalize();f=u.Vector3.FromArray(n,l).normalize().subtractToRef(t,f),h.push(f.asArray())}break;case u.VertexBuffer.TangentKind:for(let e=r.verticesStart;e<r.verticesCount;++e){l=r.indexStart+e*(i+1);const t=u.Vector4.FromArray(s,l);p._NormalizeTangentFromRef(t);const o=u.Vector4.FromArray(n,l);p._NormalizeTangentFromRef(o),d=o.subtractToRef(t,d),h.push([d.x,d.y,d.z])}break;default:u.Tools.Warn("Unsupported Vertex Buffer Type: "+e),h=[]}switch(t){case 5121:c=o.setUInt8.bind(o);break;case 5123:c=o.setUInt16.bind(o);break;case 5125:c=o.setUInt32.bind(o);break;case 5126:c=o.setFloat32.bind(o);break;default:return void u.Tools.Warn("Unsupported Attribute Component kind: "+t)}for(const e of h)for(const t of e)c(t)}_generateJSON(e,t,r){const s={byteLength:this._totalByteLength};let n,i,o,a=this._totalByteLength;return s.byteLength&&(this._glTF.buffers=[s]),this._nodes&&this._nodes.length&&(this._glTF.nodes=this._nodes),this._meshes&&this._meshes.length&&(this._glTF.meshes=this._meshes),this._scenes&&this._scenes.length&&(this._glTF.scenes=this._scenes,this._glTF.scene=0),this._cameras&&this._cameras.length&&(this._glTF.cameras=this._cameras),this._bufferViews&&this._bufferViews.length&&(this._glTF.bufferViews=this._bufferViews),this._accessors&&this._accessors.length&&(this._glTF.accessors=this._accessors),this._animations&&this._animations.length&&(this._glTF.animations=this._animations),this._materials&&this._materials.length&&(this._glTF.materials=this._materials),this._textures&&this._textures.length&&(this._glTF.textures=this._textures),this._samplers&&this._samplers.length&&(this._glTF.samplers=this._samplers),this._skins&&this._skins.length&&(this._glTF.skins=this._skins),this._images&&this._images.length&&(e?(this._glTF.images=[],this._images.forEach((e=>{e.uri&&(i=this._imageData[e.uri],this._orderedImageData.push(i),n=e.uri.split(".")[0]+" image",o=p._CreateBufferView(0,a,i.data.byteLength,void 0,n),a+=i.data.byteLength,this._bufferViews.push(o),e.bufferView=this._bufferViews.length-1,e.name=n,e.mimeType=i.mimeType,e.uri=void 0,this._glTF.images||(this._glTF.images=[]),this._glTF.images.push(e))})),s.byteLength=a):this._glTF.images=this._images),e||(s.uri=t+".bin"),r?JSON.stringify(this._glTF,null,2):JSON.stringify(this._glTF)}_generateGLTFAsync(e,t=!0){return this._generateBinaryAsync().then((r=>{this._extensionsOnExporting();const s=this._generateJSON(!1,e,!0),n=new Blob([r],{type:"application/octet-stream"}),i=e+".gltf",o=e+".bin",a=new m;if(a.glTFFiles[i]=s,a.glTFFiles[o]=n,this._imageData)for(const e in this._imageData)a.glTFFiles[e]=new Blob([this._imageData[e].data],{type:this._imageData[e].mimeType});return t&&this.dispose(),a}))}_generateBinaryAsync(){const e=new A(4);return this._createSceneAsync(e).then((()=>(this._localEngine&&this._localEngine.dispose(),e.getArrayBuffer())))}_getPadding(e){const t=e%4;return 0===t?t:4-t}_generateGLBAsync(e,t=!0){return this._generateBinaryAsync().then((r=>{this._extensionsOnExporting();const s=this._generateJSON(!0),n=e+".glb";let i,o=s.length,a=0;"undefined"!=typeof TextEncoder&&(i=(new TextEncoder).encode(s),o=i.length);for(let e=0;e<this._orderedImageData.length;++e)a+=this._orderedImageData[e].data.byteLength;const l=this._getPadding(o),c=this._getPadding(r.byteLength),u=this._getPadding(a),h=28+o+l+r.byteLength+c+a+u,f=new ArrayBuffer(12),d=new DataView(f);d.setUint32(0,1179937895,!0),d.setUint32(4,2,!0),d.setUint32(8,h,!0);const p=new ArrayBuffer(8+o+l),_=new DataView(p);_.setUint32(0,o+l,!0),_.setUint32(4,1313821514,!0);const g=new Uint8Array(p,8);if(i)g.set(i);else{const e="_".charCodeAt(0);for(let t=0;t<o;++t){const r=s.charCodeAt(t);r!=s.codePointAt(t)?g[t]=e:g[t]=r}}const x=new Uint8Array(p,8+o);for(let e=0;e<l;++e)x[e]=32;const T=new ArrayBuffer(8),y=new DataView(T);y.setUint32(0,r.byteLength+a+u,!0),y.setUint32(4,5130562,!0);const b=new ArrayBuffer(c),A=new Uint8Array(b);for(let e=0;e<c;++e)A[e]=0;const E=new ArrayBuffer(u),M=new Uint8Array(E);for(let e=0;e<u;++e)M[e]=0;const F=[f,p,T,r];for(let e=0;e<this._orderedImageData.length;++e)F.push(this._orderedImageData[e].data);F.push(b),F.push(E);const w=new Blob(F,{type:"application/octet-stream"}),C=new m;return C.glTFFiles[n]=w,null!=this._localEngine&&this._localEngine.dispose(),t&&this.dispose(),C}))}_setNodeTransformation(e,t){t.getPivotPoint().equalsToFloats(0,0,0)||u.Tools.Warn("Pivot points are not supported in the glTF serializer"),t.position.equalsToFloats(0,0,0)||(e.translation=t.position.asArray()),t.scaling.equalsToFloats(1,1,1)||(e.scale=t.scaling.asArray());const r=u.Quaternion.RotationYawPitchRoll(t.rotation.y,t.rotation.x,t.rotation.z);t.rotationQuaternion&&r.multiplyInPlace(t.rotationQuaternion),u.Quaternion.IsIdentity(r)||(e.rotation=r.normalize().asArray())}_setCameraTransformation(e,t){t.position.equalsToFloats(0,0,0)||(e.translation=t.position.asArray());const r=t.rotationQuaternion;r&&!u.Quaternion.IsIdentity(r)&&(e.rotation=r.normalize().asArray())}_getVertexBufferFromMesh(e,t){if(t.isVerticesDataPresent(e,!0)){const r=t.getVertexBuffer(e,!0);if(r)return r}return null}_createBufferViewKind(e,t,r,s,n){const i=r instanceof u.Mesh?r:r instanceof u.InstancedMesh?r.sourceMesh:null;if(i){const o=i.getVertexBuffer(e,!0),a=i.getVerticesData(e,void 0,void 0,!0);if(o&&a){const o=u.VertexBuffer.GetTypeByteLength(t),l=a.length*o,c=p._CreateBufferView(0,s.getByteOffset(),l,n,e+" - "+i.name);this._bufferViews.push(c),this._writeAttributeData(e,t,a,n/o,s,r)}}}_setMorphTargetAttributes(e,t,r,s){if(r){t.targets||(t.targets=[]);const n={},i=e.getMesh();if(r.hasNormals){const t=i.getVerticesData(u.VertexBuffer.NormalKind,void 0,void 0,!0),o=r.getNormals(),a=e.verticesCount,l=12,c=a*l,h=p._CreateBufferView(0,s.getByteOffset(),c,l,r.name+"_NORMAL");this._bufferViews.push(h);const f=this._bufferViews.length-1,d=p._CreateAccessor(f,r.name+" - NORMAL","VEC3",5126,a,0,null,null);this._accessors.push(d),n.NORMAL=this._accessors.length-1,this.writeMorphTargetAttributeData(u.VertexBuffer.NormalKind,5126,e,t,o,l/4,s)}if(r.hasPositions){const t=i.getVerticesData(u.VertexBuffer.PositionKind,void 0,void 0,!0),o=r.getPositions(),a=e.verticesCount,l=12,c=a*l,h=p._CreateBufferView(0,s.getByteOffset(),c,l,r.name+"_POSITION");this._bufferViews.push(h);const f=this._bufferViews.length-1,d={min:new u.Vector3(1/0,1/0,1/0),max:new u.Vector3(-1/0,-1/0,-1/0)},_=p._CreateAccessor(f,r.name+" - POSITION","VEC3",5126,a,0,null,null);this._accessors.push(_),n.POSITION=this._accessors.length-1,this.writeMorphTargetAttributeData(u.VertexBuffer.PositionKind,5126,e,t,o,l/4,s,d),_.min=d.min.asArray(),_.max=d.max.asArray()}if(r.hasTangents){const t=i.getVerticesData(u.VertexBuffer.TangentKind,void 0,void 0,!0),o=r.getTangents(),a=e.verticesCount,l=12,c=a*l,h=p._CreateBufferView(0,s.getByteOffset(),c,l,r.name+"_NORMAL");this._bufferViews.push(h);const f=this._bufferViews.length-1,d=p._CreateAccessor(f,r.name+" - TANGENT","VEC3",5126,a,0,null,null);this._accessors.push(d),n.TANGENT=this._accessors.length-1,this.writeMorphTargetAttributeData(u.VertexBuffer.TangentKind,5126,e,t,o,l/4,s)}t.targets.push(n)}}_getMeshPrimitiveMode(e){if(e instanceof u.LinesMesh)return u.Material.LineListDrawMode;if(e instanceof u.InstancedMesh||e instanceof u.Mesh){const t=e instanceof u.Mesh?e:e.sourceMesh;if("number"==typeof t.overrideRenderingFillMode)return t.overrideRenderingFillMode}return e.material?e.material.fillMode:u.Material.TriangleFillMode}_setPrimitiveMode(e,t){switch(t){case u.Material.TriangleFillMode:break;case u.Material.TriangleStripDrawMode:e.mode=5;break;case u.Material.TriangleFanDrawMode:e.mode=6;break;case u.Material.PointListDrawMode:case u.Material.PointFillMode:e.mode=0;break;case u.Material.LineLoopDrawMode:e.mode=2;break;case u.Material.LineListDrawMode:e.mode=1;break;case u.Material.LineStripDrawMode:e.mode=3}}_setAttributeKind(e,t){switch(t){case u.VertexBuffer.PositionKind:e.attributes.POSITION=this._accessors.length-1;break;case u.VertexBuffer.NormalKind:e.attributes.NORMAL=this._accessors.length-1;break;case u.VertexBuffer.ColorKind:e.attributes.COLOR_0=this._accessors.length-1;break;case u.VertexBuffer.TangentKind:e.attributes.TANGENT=this._accessors.length-1;break;case u.VertexBuffer.UVKind:e.attributes.TEXCOORD_0=this._accessors.length-1;break;case u.VertexBuffer.UV2Kind:e.attributes.TEXCOORD_1=this._accessors.length-1;break;case u.VertexBuffer.MatricesIndicesKind:e.attributes.JOINTS_0=this._accessors.length-1;break;case u.VertexBuffer.MatricesIndicesExtraKind:e.attributes.JOINTS_1=this._accessors.length-1;break;case u.VertexBuffer.MatricesWeightsKind:e.attributes.WEIGHTS_0=this._accessors.length-1;break;case u.VertexBuffer.MatricesWeightsExtraKind:e.attributes.WEIGHTS_1=this._accessors.length-1;break;default:u.Tools.Warn("Unsupported Vertex Buffer Type: "+t)}}_setPrimitiveAttributesAsync(e,t,r){const s=[];let n,i,o=null;t instanceof u.Mesh?o=t:t instanceof u.InstancedMesh&&(o=t.sourceMesh);const a=[{kind:u.VertexBuffer.PositionKind,accessorType:"VEC3",accessorComponentType:5126,byteStride:12},{kind:u.VertexBuffer.NormalKind,accessorType:"VEC3",accessorComponentType:5126,byteStride:12},{kind:u.VertexBuffer.ColorKind,accessorType:"VEC4",accessorComponentType:5126,byteStride:16},{kind:u.VertexBuffer.TangentKind,accessorType:"VEC4",accessorComponentType:5126,byteStride:16},{kind:u.VertexBuffer.UVKind,accessorType:"VEC2",accessorComponentType:5126,byteStride:8},{kind:u.VertexBuffer.UV2Kind,accessorType:"VEC2",accessorComponentType:5126,byteStride:8},{kind:u.VertexBuffer.MatricesIndicesKind,accessorType:"VEC4",accessorComponentType:5123,byteStride:8},{kind:u.VertexBuffer.MatricesIndicesExtraKind,accessorType:"VEC4",accessorComponentType:5123,byteStride:8},{kind:u.VertexBuffer.MatricesWeightsKind,accessorType:"VEC4",accessorComponentType:5126,byteStride:16},{kind:u.VertexBuffer.MatricesWeightsExtraKind,accessorType:"VEC4",accessorComponentType:5126,byteStride:16}];if(o){let l=null;const c=this._getMeshPrimitiveMode(o),h={},f=o.morphTargetManager;for(const e of a){const s=e.kind,n=e.accessorComponentType;if(o.isVerticesDataPresent(s,!0)){const i=this._getVertexBufferFromMesh(s,o);e.byteStride=i?i.getSize()*u.VertexBuffer.GetTypeByteLength(e.accessorComponentType):4*u.VertexBuffer.DeduceStride(s),12===e.byteStride&&(e.accessorType="VEC3"),this._createBufferViewKind(s,n,t,r,e.byteStride),e.bufferViewIndex=this._bufferViews.length-1,h[s]=e.bufferViewIndex}}if(o.getTotalIndices()){const e=o.getIndices();if(e){const t=4*e.length;n=p._CreateBufferView(0,r.getByteOffset(),t,void 0,"Indices - "+o.name),this._bufferViews.push(n),l=this._bufferViews.length-1;for(let t=0,s=e.length;t<s;++t)r.setUInt32(e[t])}}if(o.subMeshes)for(const n of o.subMeshes){let d=n.getMaterial()||o.getScene().defaultMaterial,_=null;if(d)if(o instanceof u.LinesMesh){const e={name:o.name+" material"};(!o.color.equals(u.Color3.White())||o.alpha<1)&&(e.pbrMetallicRoughness={baseColorFactor:o.color.asArray().concat([o.alpha])}),this._materials.push(e),_=this._materials.length-1}else if(d instanceof u.MultiMaterial){const e=d.subMaterials[n.materialIndex];e&&(d=e,_=this._materialMap[d.uniqueId])}else _=this._materialMap[d.uniqueId];const m=null!=_?this._materials[_]:null,g={attributes:{}};this._setPrimitiveMode(g,c);for(const e of a){const r=e.kind;if(!(r!==u.VertexBuffer.UVKind&&r!==u.VertexBuffer.UV2Kind||this._options.exportUnusedUVs||m&&this._glTFMaterialExporter._hasTexturesPresent(m)))continue;const s=o.getVerticesData(r,void 0,void 0,!0);if(s){const n=this._getVertexBufferFromMesh(r,o);if(n){const o=n.getSize(),a=e.bufferViewIndex;if(null!=a){i={min:null,max:null},r==u.VertexBuffer.PositionKind&&(i=p._CalculateMinMaxPositions(s,0,s.length/o));const n=p._CreateAccessor(a,r+" - "+t.name,e.accessorType,e.accessorComponentType,s.length/o,0,i.min,i.max);this._accessors.push(n),this._setAttributeKind(g,r)}}}}if(l){const e=p._CreateAccessor(l,"indices - "+t.name,"SCALAR",5125,n.indexCount,4*n.indexStart,null,null);this._accessors.push(e),g.indices=this._accessors.length-1}if(null!=_&&Object.keys(g.attributes).length>0){if((null!==o.overrideMaterialSideOrientation?o.overrideMaterialSideOrientation:d.sideOrientation)===(this._babylonScene.useRightHandedSystem?u.Material.ClockWiseSideOrientation:u.Material.CounterClockWiseSideOrientation)){let e=null!=l?this._bufferViews[l].byteOffset:null;null==e&&(e=0);let t=null;if(null!=l&&(t=o.getIndices()),t)this._reorderIndicesBasedOnPrimitiveMode(n,c,t,e,r);else for(const e of a){const t=o.getVerticesData(e.kind,void 0,void 0,!0);if(t){const s=this._bufferViews[h[e.kind]].byteOffset||0;this._reorderVertexAttributeDataBasedOnPrimitiveMode(n,c,e.kind,t,s,r)}}}g.material=_}if(f){let e;for(let t=0;t<f.numTargets;++t)e=f.getTarget(t),this._setMorphTargetAttributes(n,g,e,r)}e.primitives.push(g),this._extensionsPostExportMeshPrimitiveAsync("postExport",g,n,r),s.push()}}return Promise.all(s).then((()=>{}))}_createSceneAsync(e){const t={nodes:[]};let r,s,n;const i=[...this._babylonScene.transformNodes,...this._babylonScene.meshes,...this._babylonScene.lights,...this._babylonScene.cameras],o=new Set;if(this._babylonScene.metadata&&(this._options.metadataSelector?t.extras=this._options.metadataSelector(this._babylonScene.metadata):this._babylonScene.metadata.gltf&&(t.extras=this._babylonScene.metadata.gltf.extras)),(this._options.removeNoopRootNodes??1)&&!this._options.includeCoordinateSystemConversionNodes)for(const e of this._babylonScene.rootNodes)T(e,this._babylonScene.useRightHandedSystem)&&(o.add(e),i.splice(i.indexOf(e),1));const a=new Map;this._babylonScene.cameras.forEach((e=>{if(!this._options.shouldExportNode||this._options.shouldExportNode(e)){const t={type:e.mode===u.Camera.PERSPECTIVE_CAMERA?"perspective":"orthographic"};if(e.name&&(t.name=e.name),"perspective"===t.type)t.perspective={aspectRatio:e.getEngine().getAspectRatio(e),yfov:e.fovMode===u.Camera.FOVMODE_VERTICAL_FIXED?e.fov:e.fov*e.getEngine().getAspectRatio(e),znear:e.minZ,zfar:e.maxZ};else if("orthographic"===t.type){const r=e.orthoLeft&&e.orthoRight?.5*(e.orthoRight-e.orthoLeft):.5*e.getEngine().getRenderWidth(),s=e.orthoBottom&&e.orthoTop?.5*(e.orthoTop-e.orthoBottom):.5*e.getEngine().getRenderHeight();t.orthographic={xmag:r,ymag:s,znear:e.minZ,zfar:e.maxZ}}a.set(e,this._cameras.length),this._cameras.push(t)}}));const[l,c]=this._getExportNodes(i);return this._glTFMaterialExporter._convertMaterialsToGLTFAsync(c,"image/png",!0).then((()=>this._createNodeMapAndAnimationsAsync(l,e).then((l=>this._createSkinsAsync(l,e).then((c=>{if(this._nodeMap=l,this._totalByteLength=e.getByteOffset(),null==this._totalByteLength)throw new Error("undefined byte length!");for(const e of i)if(r=this._nodeMap[e.uniqueId],void 0!==r&&(s=this._nodes[r],e.metadata&&(this._options.metadataSelector?s.extras=this._options.metadataSelector(e.metadata):e.metadata.gltf&&(s.extras=e.metadata.gltf.extras)),e instanceof u.Camera&&(s.camera=a.get(e)),this._options.shouldExportNode&&!this._options.shouldExportNode(e)?u.Tools.Log("Omitting "+e.name+" from scene."):(e.parent||this._babylonScene.useRightHandedSystem||y(s),e.parent&&!o.has(e.parent)||t.nodes.push(r)),e instanceof u.Mesh&&e.skeleton&&(s.skin=c[e.skeleton.uniqueId]),n=e.getDescendants(!0),!s.children&&n&&n.length)){const e=[];for(const t of n)null!=this._nodeMap[t.uniqueId]&&e.push(this._nodeMap[t.uniqueId]);e.length&&(s.children=e)}t.nodes.length&&this._scenes.push(t)}))))))}_getExportNodes(e){const t=[],r=new Set;for(const s of e)if(!this._options.shouldExportNode||this._options.shouldExportNode(s)){t.push(s);const e=s;if(e.subMeshes&&e.subMeshes.length>0){const t=e.material||e.getScene().defaultMaterial;if(t instanceof u.MultiMaterial)for(const e of t.subMaterials)e&&r.add(e);else r.add(t)}}else s.name;return[t,r]}_createNodeMapAndAnimationsAsync(e,t){let r=Promise.resolve();const s={};let n;const i={name:"runtime animations",channels:[],samplers:[]},o=[];for(const a of e)r=r.then((()=>this._createNodeAsync(a,t).then((e=>{const r=this._extensionsPostExportNodeAsync("createNodeAsync",e,a,s,t);return null==r?(u.Tools.Warn(`Not exporting node ${a.name}`),Promise.resolve()):r.then((e=>{e&&(this._nodes.push(e),n=this._nodes.length-1,s[a.uniqueId]=n,this._babylonScene.animationGroups.length||(_._CreateMorphTargetAnimationFromMorphTargetAnimations(a,i,o,s,this._nodes,t,this._bufferViews,this._accessors,this._animationSampleRate,this._options.shouldExportAnimation),a.animations.length&&_._CreateNodeAnimationFromNodeAnimations(a,i,o,s,this._nodes,t,this._bufferViews,this._accessors,this._animationSampleRate,this._options.shouldExportAnimation)))}))}))));return r.then((()=>(i.channels.length&&i.samplers.length&&this._animations.push(i),o.forEach((e=>{e.channels.length&&e.samplers.length&&this._animations.push(e)})),this._babylonScene.animationGroups.length&&_._CreateNodeAndMorphAnimationFromAnimationGroups(this._babylonScene,this._animations,s,t,this._bufferViews,this._accessors,this._animationSampleRate,this._options.shouldExportAnimation),s)))}_createNodeAsync(e,t){return Promise.resolve().then((()=>{const r={},s={primitives:[]};if(e.name&&(r.name=e.name),e instanceof u.TransformNode){if(this._setNodeTransformation(r,e),e instanceof u.Mesh){const t=e.morphTargetManager;if(t&&t.numTargets>0){s.weights=[];for(let e=0;e<t.numTargets;++e)s.weights.push(t.getTarget(e).influence)}}return this._setPrimitiveAttributesAsync(s,e,t).then((()=>(s.primitives.length&&(this._meshes.push(s),r.mesh=this._meshes.length-1),r)))}return e instanceof u.Camera?(this._setCameraTransformation(r,e),r):r}))}_createSkinsAsync(e,t){const r=Promise.resolve(),s={};for(const r of this._babylonScene.skeletons){if(r.bones.length<=0)continue;const n={joints:[]},i=[],o={};let a=-1;for(let e=0;e<r.bones.length;++e){const t=r.bones[e],s=t.getIndex()??e;-1!==s&&(o[s]=t,s>a&&(a=s))}for(let t=0;t<=a;++t){const r=o[t];i.push(r.getInvertedAbsoluteTransform());const s=r.getTransformNode();s&&null!==e[s.uniqueId]&&void 0!==e[s.uniqueId]?n.joints.push(e[s.uniqueId]):u.Tools.Warn("Exporting a bone without a linked transform node is currently unsupported")}if(n.joints.length>0){const e=64,o=i.length*e,a=t.getByteOffset(),l=p._CreateBufferView(0,a,o,void 0,"InverseBindMatrices - "+r.name);this._bufferViews.push(l);const c=this._bufferViews.length-1,u=p._CreateAccessor(c,"InverseBindMatrices - "+r.name,"MAT4",5126,i.length,null,null,null),h=this._accessors.push(u)-1;n.inverseBindMatrices=h,this._skins.push(n),s[r.uniqueId]=this._skins.length-1,i.forEach((e=>{e.m.forEach((e=>{t.setFloat32(e)}))}))}}return r.then((()=>s))}}b._ExtensionNames=new Array,b._ExtensionFactories={};class A{constructor(e){this._arrayBuffer=new ArrayBuffer(e),this._dataView=new DataView(this._arrayBuffer),this._byteOffset=0}_resizeBuffer(e){const t=new ArrayBuffer(e),r=Math.min(this._arrayBuffer.byteLength,e),s=new Uint8Array(this._arrayBuffer,0,r);return new Uint8Array(t).set(s,0),this._arrayBuffer=t,this._dataView=new DataView(this._arrayBuffer),t}getArrayBuffer(){return this._resizeBuffer(this.getByteOffset())}getByteOffset(){if(null==this._byteOffset)throw new Error("Byte offset is undefined!");return this._byteOffset}setUInt8(e,t){null!=t?t<this._byteOffset?this._dataView.setUint8(t,e):u.Tools.Error("BinaryWriter: byteoffset is greater than the current binary buffer length!"):(this._byteOffset+1>this._arrayBuffer.byteLength&&this._resizeBuffer(2*this._arrayBuffer.byteLength),this._dataView.setUint8(this._byteOffset,e),this._byteOffset+=1)}setUInt16(e,t){null!=t?t<this._byteOffset?this._dataView.setUint16(t,e,!0):u.Tools.Error("BinaryWriter: byteoffset is greater than the current binary buffer length!"):(this._byteOffset+2>this._arrayBuffer.byteLength&&this._resizeBuffer(2*this._arrayBuffer.byteLength),this._dataView.setUint16(this._byteOffset,e,!0),this._byteOffset+=2)}getUInt32(e){if(e<this._byteOffset)return this._dataView.getUint32(e,!0);throw u.Tools.Error("BinaryWriter: byteoffset is greater than the current binary buffer length!"),new Error("BinaryWriter: byteoffset is greater than the current binary buffer length!")}getVector3Float32FromRef(e,t){t+8>this._byteOffset?u.Tools.Error("BinaryWriter: byteoffset is greater than the current binary buffer length!"):(e.x=this._dataView.getFloat32(t,!0),e.y=this._dataView.getFloat32(t+4,!0),e.z=this._dataView.getFloat32(t+8,!0))}setVector3Float32FromRef(e,t){t+8>this._byteOffset?u.Tools.Error("BinaryWriter: byteoffset is greater than the current binary buffer length!"):(this._dataView.setFloat32(t,e.x,!0),this._dataView.setFloat32(t+4,e.y,!0),this._dataView.setFloat32(t+8,e.z,!0))}getVector4Float32FromRef(e,t){t+12>this._byteOffset?u.Tools.Error("BinaryWriter: byteoffset is greater than the current binary buffer length!"):(e.x=this._dataView.getFloat32(t,!0),e.y=this._dataView.getFloat32(t+4,!0),e.z=this._dataView.getFloat32(t+8,!0),e.w=this._dataView.getFloat32(t+12,!0))}setVector4Float32FromRef(e,t){t+12>this._byteOffset?u.Tools.Error("BinaryWriter: byteoffset is greater than the current binary buffer length!"):(this._dataView.setFloat32(t,e.x,!0),this._dataView.setFloat32(t+4,e.y,!0),this._dataView.setFloat32(t+8,e.z,!0),this._dataView.setFloat32(t+12,e.w,!0))}setFloat32(e,t){isNaN(e)&&u.Tools.Error("Invalid data being written!"),null!=t&&(t<this._byteOffset?this._dataView.setFloat32(t,e,!0):u.Tools.Error("BinaryWriter: byteoffset is greater than the current binary length!")),this._byteOffset+4>this._arrayBuffer.byteLength&&this._resizeBuffer(2*this._arrayBuffer.byteLength),this._dataView.setFloat32(this._byteOffset,e,!0),this._byteOffset+=4}setUInt32(e,t){null!=t?t<this._byteOffset?this._dataView.setUint32(t,e,!0):u.Tools.Error("BinaryWriter: byteoffset is greater than the current binary buffer length!"):(this._byteOffset+4>this._arrayBuffer.byteLength&&this._resizeBuffer(2*this._arrayBuffer.byteLength),this._dataView.setUint32(this._byteOffset,e,!0),this._byteOffset+=4)}setInt16(e,t){null!=t?t<this._byteOffset?this._dataView.setInt16(t,e,!0):u.Tools.Error("BinaryWriter: byteoffset is greater than the current binary buffer length!"):(this._byteOffset+2>this._arrayBuffer.byteLength&&this._resizeBuffer(2*this._arrayBuffer.byteLength),this._dataView.setInt16(this._byteOffset,e,!0),this._byteOffset+=2)}setByte(e,t){null!=t?t<this._byteOffset?this._dataView.setInt8(t,e):u.Tools.Error("BinaryWriter: byteoffset is greater than the current binary buffer length!"):(this._byteOffset+1>this._arrayBuffer.byteLength&&this._resizeBuffer(2*this._arrayBuffer.byteLength),this._dataView.setInt8(this._byteOffset,e),this._byteOffset++)}}var E=0;class M{static GLTFAsync(e,t,r){return e.whenReadyAsync().then((()=>{const s=t.replace(/\.[^/.]+$/,"");return new b(e,r)._generateGLTFAsync(s)}))}static _PreExportAsync(e,t){return Promise.resolve().then((()=>t&&t.exportWithoutWaitingForScene?Promise.resolve():e.whenReadyAsync()))}static _PostExportAsync(e,t,r){return Promise.resolve().then((()=>(r&&r.exportWithoutWaitingForScene,t)))}static GLBAsync(e,t,r){return this._PreExportAsync(e,r).then((()=>{const s=t.replace(/\.[^/.]+$/,"");return new b(e,r)._generateGLBAsync(s).then((t=>this._PostExportAsync(e,t,r)))}))}}const F="KHR_texture_transform";class w{constructor(){this.name=F,this.enabled=!0,this.required=!1,this._wasUsed=!1}dispose(){}get wasUsed(){return this._wasUsed}postExportTexture(e,t,r){if(r&&(0===r.uAng&&0===r.wAng&&0===r.vAng||0===r.uRotationCenter&&0===r.vRotationCenter)){const e={};let s=!1;if(0===r.uOffset&&0===r.vOffset||(e.offset=[r.uOffset,r.vOffset],s=!0),1===r.uScale&&1===r.vScale||(e.scale=[r.uScale,r.vScale],s=!0),0!==r.wAng&&(e.rotation=-r.wAng,s=!0),0!==r.coordinatesIndex&&(e.texCoord=r.coordinatesIndex,s=!0),!s)return;this._wasUsed=!0,t.extensions||(t.extensions={}),t.extensions[F]=e}}preExportTextureAsync(e,t){return new Promise(((r,s)=>{t.getScene()?0!==t.uAng||0!==t.vAng?(u.Tools.Warn(`${e}: Texture ${t.name} with rotation in the u or v axis is not supported in glTF.`),r(null)):0===t.wAng||0===t.uRotationCenter&&0===t.vRotationCenter?r(t):(u.Tools.Warn(`${e}: Texture ${t.name} with rotation not centered at the origin cannot be exported with ${F}`),r(null)):s(`${e}: "scene" is not defined for Babylon texture ${t.name}!`)}))}}b.RegisterExtension(F,(()=>new w));const C="KHR_lights_punctual";class V{constructor(e){this.name=C,this.enabled=!0,this.required=!1,this._exporter=e}dispose(){this._lights=null}get wasUsed(){return!!this._lights}onExporting(){this._exporter._glTF.extensions[C]=this._lights}postExportNodeAsync(e,t,r,s){return new Promise((n=>{if(t&&r instanceof u.ShadowLight){let i;const o=r.getTypeID()==u.Light.LIGHTTYPEID_POINTLIGHT?"point":r.getTypeID()==u.Light.LIGHTTYPEID_DIRECTIONALLIGHT?"directional":r.getTypeID()==u.Light.LIGHTTYPEID_SPOTLIGHT?"spot":null;if(null==o)u.Logger.Warn(`${e}: Light ${r.name} is not supported in ${C}`);else{if(r.position.equalsToFloats(0,0,0)||(t.translation=r.position.asArray()),"point"!==o){const e=r.direction,s=-Math.atan2(e.z,e.x)+Math.PI/2,n=Math.sqrt(e.x*e.x+e.z*e.z),i=-Math.atan2(e.y,n),o=u.Quaternion.RotationYawPitchRoll(s+Math.PI,i,0);u.Quaternion.IsIdentity(o)||(t.rotation=o.asArray())}if(r.falloffType!==u.Light.FALLOFF_GLTF&&u.Logger.Warn(`${e}: Light falloff for ${r.name} does not match the ${C} specification!`),i={type:o},r.diffuse.equals(u.Color3.White())||(i.color=r.diffuse.asArray()),1!==r.intensity&&(i.intensity=r.intensity),r.range!==Number.MAX_VALUE&&(i.range=r.range),"spot"===o){const e=r;e.angle!==Math.PI/2&&(null==i.spot&&(i.spot={}),i.spot.outerConeAngle=e.angle/2),0!==e.innerAngle&&(null==i.spot&&(i.spot={}),i.spot.innerConeAngle=e.innerAngle/2)}this._lights||={lights:[]},this._lights.lights.push(i);const a={light:this._lights.lights.length-1},l=r.parent;if(l&&1==l.getChildren().length){const e=this._exporter._nodes[s[l.uniqueId]];if(e){const r=u.Vector3.FromArrayToRef(e.translation||[0,0,0],0,u.TmpVectors.Vector3[0]),s=u.Quaternion.FromArrayToRef(e.rotation||[0,0,0,1],0,u.TmpVectors.Quaternion[0]),i=u.Vector3.FromArrayToRef(e.scale||[1,1,1],0,u.TmpVectors.Vector3[1]),o=u.Matrix.ComposeToRef(i,s,r,u.TmpVectors.Matrix[0]),l=u.Vector3.FromArrayToRef(t.translation||[0,0,0],0,u.TmpVectors.Vector3[2]),c=u.Quaternion.FromArrayToRef(t.rotation||[0,0,0,1],0,u.TmpVectors.Quaternion[1]),h=u.Matrix.ComposeToRef(u.Vector3.OneReadOnly,c,l,u.TmpVectors.Matrix[1]);return o.multiplyToRef(h,h),h.decompose(i,s,r),r.equalsToFloats(0,0,0)?delete e.translation:e.translation=r.asArray(),u.Quaternion.IsIdentity(s)?delete e.rotation:e.rotation=s.asArray(),i.equalsToFloats(1,1,1)?delete e.scale:e.scale=i.asArray(),e.extensions||={},e.extensions[C]=a,void n(null)}}t.extensions||={},t.extensions[C]=a}}n(t)}))}}b.RegisterExtension(C,(e=>new V(e)));const R="KHR_materials_clearcoat";class S{constructor(e){this.name=R,this.enabled=!0,this.required=!1,this._wasUsed=!1,this._exporter=e}dispose(){}get wasUsed(){return this._wasUsed}postExportMaterialAdditionalTextures(e,t,r){const s=[];return r instanceof u.PBRBaseMaterial&&r.clearCoat.isEnabled?(r.clearCoat.texture&&s.push(r.clearCoat.texture),!r.clearCoat.useRoughnessFromMainTexture&&r.clearCoat.textureRoughness&&s.push(r.clearCoat.textureRoughness),r.clearCoat.bumpTexture&&s.push(r.clearCoat.bumpTexture),s):[]}postExportMaterialAsync(e,t,r){return new Promise((e=>{if(r instanceof u.PBRBaseMaterial){if(!r.clearCoat.isEnabled)return void e(t);this._wasUsed=!0,t.extensions=t.extensions||{};const s=this._exporter._glTFMaterialExporter._getTextureInfo(r.clearCoat.texture);let n;n=r.clearCoat.useRoughnessFromMainTexture?this._exporter._glTFMaterialExporter._getTextureInfo(r.clearCoat.texture):this._exporter._glTFMaterialExporter._getTextureInfo(r.clearCoat.textureRoughness),r.clearCoat.isTintEnabled&&u.Tools.Warn(`Clear Color tint is not supported for glTF export. Ignoring for: ${r.name}`),r.clearCoat.remapF0OnInterfaceChange&&u.Tools.Warn(`Clear Color F0 remapping is not supported for glTF export. Ignoring for: ${r.name}`);const i=this._exporter._glTFMaterialExporter._getTextureInfo(r.clearCoat.bumpTexture),o={clearcoatFactor:r.clearCoat.intensity,clearcoatTexture:s??void 0,clearcoatRoughnessFactor:r.clearCoat.roughness,clearcoatRoughnessTexture:n??void 0,clearcoatNormalTexture:i??void 0,hasTextures:()=>null!==o.clearcoatTexture||null!==o.clearcoatRoughnessTexture||null!==o.clearcoatRoughnessTexture};t.extensions[R]=o}e(t)}))}}b.RegisterExtension(R,(e=>new S(e)));const v="KHR_materials_iridescence";class I{constructor(e){this.name=v,this.enabled=!0,this.required=!1,this._wasUsed=!1,this._exporter=e}dispose(){}get wasUsed(){return this._wasUsed}postExportMaterialAdditionalTextures(e,t,r){const s=[];return r instanceof u.PBRBaseMaterial&&r.iridescence.isEnabled?(r.iridescence.texture&&s.push(r.iridescence.texture),r.iridescence.thicknessTexture&&r.iridescence.thicknessTexture!==r.iridescence.texture&&s.push(r.iridescence.thicknessTexture),s):[]}postExportMaterialAsync(e,t,r){return new Promise((e=>{if(r instanceof u.PBRBaseMaterial){if(!r.iridescence.isEnabled)return void e(t);this._wasUsed=!0,t.extensions=t.extensions||{};const s=this._exporter._glTFMaterialExporter._getTextureInfo(r.iridescence.texture),n=this._exporter._glTFMaterialExporter._getTextureInfo(r.iridescence.thicknessTexture),i={iridescenceFactor:r.iridescence.intensity,iridescenceIor:r.iridescence.indexOfRefraction,iridescenceThicknessMinimum:r.iridescence.minimumThickness,iridescenceThicknessMaximum:r.iridescence.maximumThickness,iridescenceTexture:s??void 0,iridescenceThicknessTexture:n??void 0,hasTextures:()=>null!==i.iridescenceTexture||null!==i.iridescenceThicknessTexture};t.extensions[v]=i}e(t)}))}}b.RegisterExtension(v,(e=>new I(e)));const B="KHR_materials_anisotropy";class P{constructor(e){this.name=B,this.enabled=!0,this.required=!1,this._wasUsed=!1,this._exporter=e}dispose(){}get wasUsed(){return this._wasUsed}postExportMaterialAdditionalTextures(e,t,r){const s=[];return r instanceof u.PBRBaseMaterial&&r.anisotropy.isEnabled&&!r.anisotropy.legacy?(r.anisotropy.texture&&s.push(r.anisotropy.texture),s):[]}postExportMaterialAsync(e,t,r){return new Promise((e=>{if(r instanceof u.PBRBaseMaterial){if(!r.anisotropy.isEnabled||r.anisotropy.legacy)return void e(t);this._wasUsed=!0,t.extensions=t.extensions||{};const s=this._exporter._glTFMaterialExporter._getTextureInfo(r.anisotropy.texture),n={anisotropyStrength:r.anisotropy.intensity,anisotropyRotation:r.anisotropy.angle,anisotropyTexture:s??void 0,hasTextures:()=>null!==n.anisotropyTexture};t.extensions[B]=n}e(t)}))}}b.RegisterExtension(B,(e=>new P(e)));const N="KHR_materials_sheen";class L{constructor(e){this.name=N,this.enabled=!0,this.required=!1,this._wasUsed=!1,this._exporter=e}dispose(){}get wasUsed(){return this._wasUsed}postExportMaterialAdditionalTextures(e,t,r){return r instanceof u.PBRMaterial&&r.sheen.isEnabled&&r.sheen.texture?[r.sheen.texture]:[]}postExportMaterialAsync(e,t,r){return new Promise((e=>{if(r instanceof u.PBRMaterial){if(!r.sheen.isEnabled)return void e(t);this._wasUsed=!0,null==t.extensions&&(t.extensions={});const s={sheenColorFactor:r.sheen.color.asArray(),sheenRoughnessFactor:r.sheen.roughness??0,hasTextures:()=>null!==s.sheenColorTexture||null!==s.sheenRoughnessTexture};r.sheen.texture&&(s.sheenColorTexture=this._exporter._glTFMaterialExporter._getTextureInfo(r.sheen.texture)??void 0),r.sheen.textureRoughness&&!r.sheen.useRoughnessFromMainTexture?s.sheenRoughnessTexture=this._exporter._glTFMaterialExporter._getTextureInfo(r.sheen.textureRoughness)??void 0:r.sheen.texture&&r.sheen.useRoughnessFromMainTexture&&(s.sheenRoughnessTexture=this._exporter._glTFMaterialExporter._getTextureInfo(r.sheen.texture)??void 0),t.extensions[N]=s}e(t)}))}}b.RegisterExtension(N,(e=>new L(e)));const O="KHR_materials_unlit";class k{constructor(){this.name=O,this.enabled=!0,this.required=!1,this._wasUsed=!1}get wasUsed(){return this._wasUsed}dispose(){}postExportMaterialAsync(e,t,r){return new Promise((e=>{let s=!1;r instanceof u.PBRMaterial?s=r.unlit:r instanceof u.StandardMaterial&&(s=r.disableLighting),s&&(this._wasUsed=!0,null==t.extensions&&(t.extensions={}),t.extensions[O]={}),e(t)}))}}b.RegisterExtension(O,(()=>new k));const U="KHR_materials_ior";class K{constructor(){this.name=U,this.enabled=!0,this.required=!1,this._wasUsed=!1}dispose(){}get wasUsed(){return this._wasUsed}_isExtensionEnabled(e){return!e.unlit&&null!=e.indexOfRefraction&&1.5!=e.indexOfRefraction}postExportMaterialAsync(e,t,r){return new Promise((e=>{if(r instanceof u.PBRMaterial&&this._isExtensionEnabled(r)){this._wasUsed=!0;const e={ior:r.indexOfRefraction};t.extensions=t.extensions||{},t.extensions[U]=e}e(t)}))}}b.RegisterExtension(U,(e=>new K));const D="KHR_materials_specular";class G{constructor(e){this.name=D,this.enabled=!0,this.required=!1,this._wasUsed=!1,this._exporter=e}dispose(){}get wasUsed(){return this._wasUsed}postExportMaterialAdditionalTextures(e,t,r){const s=[];return r instanceof u.PBRMaterial&&this._isExtensionEnabled(r)?(r.metallicReflectanceTexture&&s.push(r.metallicReflectanceTexture),r.reflectanceTexture&&s.push(r.reflectanceTexture),s):s}_isExtensionEnabled(e){return!e.unlit&&(null!=e.metallicF0Factor&&1!=e.metallicF0Factor||null!=e.metallicReflectanceColor&&!e.metallicReflectanceColor.equalsFloats(1,1,1)||this._hasTexturesExtension(e))}_hasTexturesExtension(e){return null!=e.metallicReflectanceTexture||null!=e.reflectanceTexture}postExportMaterialAsync(e,t,r){return new Promise((e=>{if(r instanceof u.PBRMaterial&&this._isExtensionEnabled(r)){this._wasUsed=!0,t.extensions=t.extensions||{};const e=this._exporter._glTFMaterialExporter._getTextureInfo(r.metallicReflectanceTexture)??void 0,s=this._exporter._glTFMaterialExporter._getTextureInfo(r.reflectanceTexture)??void 0,n={specularFactor:1==r.metallicF0Factor?void 0:r.metallicF0Factor,specularTexture:e,specularColorFactor:r.metallicReflectanceColor.equalsFloats(1,1,1)?void 0:r.metallicReflectanceColor.asArray(),specularColorTexture:s,hasTextures:()=>this._hasTexturesExtension(r)};t.extensions[D]=n}e(t)}))}}b.RegisterExtension(D,(e=>new G(e)));const z="KHR_materials_volume";class W{constructor(e){this.name=z,this.enabled=!0,this.required=!1,this._wasUsed=!1,this._exporter=e}dispose(){}get wasUsed(){return this._wasUsed}postExportMaterialAdditionalTextures(e,t,r){const s=[];return r instanceof u.PBRMaterial&&this._isExtensionEnabled(r)?(r.subSurface.thicknessTexture&&s.push(r.subSurface.thicknessTexture),s):s}_isExtensionEnabled(e){if(e.unlit)return!1;const t=e.subSurface;return!(!t.isRefractionEnabled&&!t.isTranslucencyEnabled)&&(null!=t.maximumThickness&&0!=t.maximumThickness||null!=t.tintColorAtDistance&&t.tintColorAtDistance!=Number.POSITIVE_INFINITY||null!=t.tintColor&&t.tintColor!=u.Color3.White()||this._hasTexturesExtension(e))}_hasTexturesExtension(e){return null!=e.subSurface.thicknessTexture}postExportMaterialAsync(e,t,r){return new Promise((e=>{if(r instanceof u.PBRMaterial&&this._isExtensionEnabled(r)){this._wasUsed=!0;const e=r.subSurface,s={thicknessFactor:0==e.maximumThickness?void 0:e.maximumThickness,thicknessTexture:this._exporter._glTFMaterialExporter._getTextureInfo(e.thicknessTexture)??void 0,attenuationDistance:e.tintColorAtDistance==Number.POSITIVE_INFINITY?void 0:e.tintColorAtDistance,attenuationColor:e.tintColor.equalsFloats(1,1,1)?void 0:e.tintColor.asArray(),hasTextures:()=>this._hasTexturesExtension(r)};t.extensions=t.extensions||{},t.extensions[z]=s}e(t)}))}}b.RegisterExtension(z,(e=>new W(e)));const q="KHR_materials_transmission";class H{constructor(e){this.name=q,this.enabled=!0,this.required=!1,this._wasUsed=!1,this._exporter=e}dispose(){}get wasUsed(){return this._wasUsed}postExportMaterialAdditionalTextures(e,t,r){const s=[];return r instanceof u.PBRMaterial&&this._isExtensionEnabled(r)?(r.subSurface.thicknessTexture&&s.push(r.subSurface.thicknessTexture),s):s}_isExtensionEnabled(e){if(e.unlit)return!1;const t=e.subSurface;return t.isRefractionEnabled&&null!=t.refractionIntensity&&0!=t.refractionIntensity||this._hasTexturesExtension(e)}_hasTexturesExtension(e){return null!=e.subSurface.refractionIntensityTexture}postExportMaterialAsync(e,t,r){return new Promise((e=>{if(r instanceof u.PBRMaterial&&this._isExtensionEnabled(r)){this._wasUsed=!0;const e=r.subSurface,s={transmissionFactor:0===e.refractionIntensity?void 0:e.refractionIntensity,transmissionTexture:this._exporter._glTFMaterialExporter._getTextureInfo(e.refractionIntensityTexture)??void 0,hasTextures:()=>this._hasTexturesExtension(r)};t.extensions=t.extensions||{},t.extensions[q]=s}e(t)}))}}b.RegisterExtension(q,(e=>new H(e)));const $="EXT_mesh_gpu_instancing";class j{constructor(e){this.name=$,this.enabled=!0,this.required=!1,this._wasUsed=!1,this._exporter=e}dispose(){}get wasUsed(){return this._wasUsed}postExportNodeAsync(e,t,r,s,n){return new Promise((e=>{if(t&&r instanceof u.Mesh&&r.hasThinInstances&&n){this._wasUsed=!0;const e=u.Vector3.Zero(),s=u.Quaternion.Identity(),i=u.Vector3.One(),o=r.thinInstanceGetWorldMatrices(),a=u.TmpVectors.Vector3[2],l=u.TmpVectors.Quaternion[1],c=u.TmpVectors.Vector3[3];let h=!1,f=!1,d=!1;const p=new Float32Array(3*r.thinInstanceCount),_=new Float32Array(4*r.thinInstanceCount),m=new Float32Array(3*r.thinInstanceCount);let g=0;for(const t of o)t.decompose(c,l,a),p.set(a.asArray(),3*g),_.set(l.normalize().asArray(),4*g),m.set(c.asArray(),3*g),h=h||!a.equalsWithEpsilon(e),f=f||!l.equalsWithEpsilon(s),d=d||!c.equalsWithEpsilon(i),g++;const x={attributes:{}};if(h&&(x.attributes.TRANSLATION=this._buildAccessor(p,"VEC3",r.thinInstanceCount,n,5126)),f){const e=5126;x.attributes.ROTATION=this._buildAccessor(_,"VEC4",r.thinInstanceCount,n,e)}d&&(x.attributes.SCALE=this._buildAccessor(m,"VEC3",r.thinInstanceCount,n,5126)),t.extensions=t.extensions||{},t.extensions[$]=x}e(t)}))}_buildAccessor(e,t,r,s,n){const i=s.getByteOffset();switch(n){case 5126:for(let t=0;t!=e.length;t++)s.setFloat32(e[t]);break;case 5120:for(let t=0;t!=e.length;t++)s.setByte(127*e[t]);break;case 5122:for(let t=0;t!=e.length;t++)s.setInt16(32767*e[t])}const o={buffer:0,byteOffset:i,byteLength:e.length*u.VertexBuffer.GetTypeByteLength(n)},a=this._exporter._bufferViews.length;this._exporter._bufferViews.push(o);const l=this._exporter._accessors.length,c={bufferView:a,componentType:n,count:r,type:t,normalized:5120==n||5122==n};return this._exporter._accessors.push(c),l}}b.RegisterExtension($,(e=>new j(e)));const Q="KHR_materials_emissive_strength";class Y{constructor(){this.name=Q,this.enabled=!0,this.required=!1,this._wasUsed=!1}dispose(){}get wasUsed(){return this._wasUsed}postExportMaterialAsync(e,t,r){return new Promise((e=>{if(!(r instanceof u.PBRMaterial))return e(t);const s=r.emissiveColor.asArray(),n=Math.max(...s);if(n>1){this._wasUsed=!0,t.extensions||={};const e={emissiveStrength:n},s=r.emissiveColor.scale(1/e.emissiveStrength);t.emissiveFactor=s.asArray(),t.extensions[Q]=e}return e(t)}))}}b.RegisterExtension(Q,(e=>new Y));class X{static CreateSTL(e,t=!0,r="stlmesh",s=!1,n=!0,i=!1,o=!1,a=!1){const l=function(e,t,r){const s=[3*e[r],3*e[r+1],3*e[r+2]],n=[new u.Vector3(t[s[0]],t[s[0]+2],t[s[0]+1]),new u.Vector3(t[s[1]],t[s[1]+2],t[s[1]+1]),new u.Vector3(t[s[2]],t[s[2]+2],t[s[2]+1])],i=n[0].subtract(n[1]),o=n[2].subtract(n[1]);return{v:n,n:u.Vector3.Cross(o,i).normalize()}},c=function(e,t,r,s){return t=h(e,t,r.x,s),t=h(e,t,r.y,s),h(e,t,r.z,s)},h=function(e,t,r,s){return e.setFloat32(t,r,s),t+4},f=function(e){if(o){let t=e;e instanceof u.InstancedMesh&&(t=e.sourceMesh);const r=t.getVerticesData(u.VertexBuffer.PositionKind,!0,!0);if(!r)return[];const s=u.Vector3.Zero();let n;for(n=0;n<r.length;n+=3)u.Vector3.TransformCoordinatesFromFloatsToRef(r[n],r[n+1],r[n+2],e.computeWorldMatrix(!0),s).toArray(r,n);return r}return e.getVerticesData(u.VertexBuffer.PositionKind)||[]};o&&(i=!0);let d="",p=0,_=0;if(s){for(let t=0;t<e.length;t++){const r=e[t].getIndices();p+=r?r.length/3:0}const t=new ArrayBuffer(84+50*p);d=new DataView(t),_+=80,d.setUint32(_,p,n),_+=4}else a||(d="solid stlmesh\r\n");for(let t=0;t<e.length;t++){const r=e[t];!s&&a&&(d+="solid "+r.name+"\r\n"),!i&&r instanceof u.Mesh&&r.bakeCurrentTransformIntoVertices();const o=f(r),h=r.getIndices()||[];for(let e=0;e<h.length;e+=3){const t=l(h,o,e);s?(_=c(d,_,t.n,n),_=c(d,_,t.v[0],n),_=c(d,_,t.v[1],n),_=c(d,_,t.v[2],n),_+=2):(d+="\tfacet normal "+t.n.x+" "+t.n.y+" "+t.n.z+"\r\n",d+="\t\touter loop\r\n",d+="\t\t\tvertex "+t.v[0].x+" "+t.v[0].y+" "+t.v[0].z+"\r\n",d+="\t\t\tvertex "+t.v[1].x+" "+t.v[1].y+" "+t.v[1].z+"\r\n",d+="\t\t\tvertex "+t.v[2].x+" "+t.v[2].y+" "+t.v[2].z+"\r\n",d+="\t\tendloop\r\n",d+="\tendfacet\r\n")}!s&&a&&(d+="endsolid "+name+"\r\n")}if(s||a||(d+="endsolid stlmesh"),t){const e=document.createElement("a"),t=new Blob([d],{type:"application/octet-stream"});e.href=window.URL.createObjectURL(t),e.download=r+".stl",e.click()}return d}}const J=void 0!==s.g?s.g:"undefined"!=typeof window?window:void 0;if(void 0!==J){J.BABYLON=J.BABYLON||{};const e=J.BABYLON;e.GLTF2=e.GLTF2||{},e.GLTF2.Exporter=e.GLTF2.Exporter||{},e.GLTF2.Exporter.Extensions=e.GLTF2.Exporter.Extensions||{};const s=[];for(const r in t)e[r]=t[r],s.push(r);for(const t in r)e[t]=r[t],s.push(t);for(const t in i)e[t]=i[t],s.push(t);for(const t in o)e.GLTF2.Exporter.Extensions[t]=o[t],s.push(t);for(const t in a)s.indexOf(t)>-1||(e.GLTF2.Exporter[t]=a[t])}const Z=void 0!==s.g?s.g:"undefined"!=typeof window?window:void 0;if(void 0!==Z)for(const t in e)Z.BABYLON[t]=e[t];const ee=void 0!==s.g?s.g:"undefined"!=typeof window?window:void 0;if(void 0!==ee)for(const e in l)ee.BABYLON[e]=l[e];const te=c})(),n.default})()));
//# sourceMappingURL=babylonjs.serializers.min.js.map